<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consumption Conversion | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://pqvvrljykfvhpyvxmwzb.supabase.co" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #F97316; --accent-dark: #EA580C; --accent-light: #FB923C; --accent-rgb: 249, 115, 22; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => { const params = new URLSearchParams(window.location.search); return params.get('userName') || 'Builder'; };

    const LESSON_CONFIG = {
      id: 'consumption-conversion',
      title: 'Consumption Conversion',
      description: 'Turn product usage into repeat purchases with the Hook-Story-Close framework',
      accentColor: '#F97316',
      duration: '6 min',
      nextLesson: { id: 'conviction-architecture', title: 'Conviction Architecture', teaser: 'Build unshakeable customer belief systems.' }
    };

    // ============ ADMIN REPORTER SYSTEM ============
    // Per-slide bug reporting for admin users
    let __isAdmin = false;

    // Listen for admin status from parent
    window.addEventListener('message', function(e) {
      if (e.data?.type === 'ADMIN_STATUS') {
        __isAdmin = e.data.isAdmin;
      }
    });

    // Request admin status on load
    if (window.parent !== window) {
      window.parent.postMessage({ type: 'CHECK_ADMIN_STATUS' }, '*');
    }

    // Admin Report Button Component
    const AdminSlideReportButton = ({ slideIndex, slideType }) => {
      // TEMP: if (!__isAdmin) return null; // TODO: restore before going live

      const handleReport = (e) => {
        e.stopPropagation();
        e.preventDefault();
        if (window.parent !== window) {
          window.parent.postMessage({
            type: 'ADMIN_REPORT_REQUEST',
            slideIndex: slideIndex,
            slideType: slideType,
            lessonSlug: LESSON_CONFIG.id,
            elementId: slideType + '-' + slideIndex
          }, '*');
        }
      };

      return (
        <button
          onClick={handleReport}
          title={`Report issue on Slide ${slideIndex + 1} (${slideType})`}
          style={{
            position: 'absolute',
            top: '12px',
            right: '12px',
            width: '32px',
            height: '32px',
            borderRadius: '8px',
            backgroundColor: 'rgba(239, 68, 68, 0.9)',
            color: 'white',
            border: 'none',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            opacity: 0.6,
            transition: 'opacity 0.2s, transform 0.2s',
            boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
          }}
          onMouseEnter={(e) => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.transform = 'scale(1.1)'; }}
          onMouseLeave={(e) => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.transform = 'scale(1)'; }}
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/>
            <path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/>
            <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/>
            <path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/>
            <path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/>
            <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/>
            <path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/>
          </svg>
        </button>
      );
    };
    // ============ END ADMIN REPORTER SYSTEM ============


    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_playing_air_guitar_light_headbanging_rockstar__0702007e-9e84-4d9e-8f99-8ee23d0b65f8_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_the_running_man_dance_move_vintage_cool__25682b0f-cf4c-4e93-8dcb-6c3dac8135cd_0.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_standing_and_clapping_enthusiastically_mouth_o_992ac4fd-9a0e-4963-bbcc-a5271f25f4fd_3.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];

    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_covering_face_with_palm_facepalm_gesture_disap_211b0566-078f-4d42-9c41-547b14f5827c_0.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    const slides = [
      { type: 'welcome', learningGoals: ['The fatal mistake most product pages make', 'The Hook-Story-Close framework that converts strangers to buyers', 'How to find your "Forbidden Coffee" hook that creates instant curiosity'] },
      { type: 'hook', headline: 'You cannot ram features down throats.', subtext: 'You send traffic to your product page. The visitor lands. Scrolls. Sees specs. Features. Benefits. And leaves. Because you are trying to sell before you have earned the right to. You skipped the setup. You need a BIG UNIQUE IDEA. A HOOK that pulls strangers into your world.', characterVideo: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_giving_double_thumbs_up_huge_grin_extremely_ha_b5ae8ebd-5dd7-4d80-9f6b-f63f68bff313_2.mp4', characterPosition: 'left' },
      { type: 'stat-countdown', title: 'Why Most Product Pages Fail', stats: [
        { value: 0.8, suffix: '%', label: 'Avg Conversion Rate', subtext: 'Feature-dumping pages', color: '#EF4444' },
        { value: 17, suffix: '', label: 'Features Listed', subtext: 'That nobody reads', color: '#6B7280' },
        { value: 3, suffix: 'sec', label: 'Time to Lose Them', subtext: 'Without a hook', color: '#F97316' }
      ]},
      { type: 'funnel-visual', title: 'The Hook-Story-Close Framework', subtitle: 'Stop selling. Start converting.' },
      { type: 'framework-breakdown', title: 'Each Stage Has ONE Job', stages: [
        { name: 'HOOK', color: '#F97316', job: 'Create curiosity', where: 'Ad / Social Post', outcome: 'Get the click', icon: 'Zap' },
        { name: 'STORY', color: '#3B82F6', job: 'Build the case', where: 'Landing Page', outcome: 'Make them feel it', icon: 'BookOpen' },
        { name: 'CLOSE', color: '#22C55E', job: 'Remove friction', where: 'Product Page', outcome: 'Convert the sale', icon: 'ShoppingCart' }
      ]},
      { type: 'before-after-hook', title: 'Boring vs Hook', before: { text: 'Premium Brazilian Coffee Beans - 1kg Bag. High quality. Fair trade. Organic.', label: 'COMMODITY' }, after: { text: 'The Forbidden Coffee Once Reserved for Amazonian Warriors. A secret blend hidden for centuries.', label: 'STORY' }, insight: 'One is a commodity you scroll past. The other is a story you NEED to know more about.' },
      { type: 'hook-elements', title: 'Finding Your Forbidden Coffee', elements: [
        { title: 'Origin Story', description: 'Where did this come from? Who discovered it? What is the backstory that makes this special?', icon: 'MapPin', color: '#F97316' },
        { title: 'Unique Mechanism', description: 'What makes it DIFFERENT? Not better. Different. What does it do that nothing else does?', icon: 'Cog', color: '#3B82F6' },
        { title: 'The Enemy', description: 'What does this replace? What does it make obsolete? What are you fighting against?', icon: 'Sword', color: '#EF4444' },
        { title: 'Transformation', description: 'Not features. The FEELING they get after using it. The person they become.', icon: 'Sparkles', color: '#22C55E' }
      ]},
      { type: 'content', title: 'Your Hook Is Not Your Product', body: 'Most sellers make this mistake: they think the hook IS the product. "Our coffee is premium" is not a hook. "The Forbidden Coffee Once Reserved for Amazonian Warriors" is a hook. The first tells you what it is. The second makes you NEED to know more. Your hook is the angle, the story, the unique perspective that pulls people in. The product closes the sale. The hook opens the door.', characterVideo: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_having_a_lightbulb_moment_pure_100_white_backg_bd88fbc3-b501-446f-a37f-09b80e6320fc_3.mp4', characterPosition: 'right' },
      { type: 'strategy-steps', title: 'Your 4-Step Hook Discovery', steps: [
        { number: 1, title: 'BRAINSTORM', icon: 'Lightbulb', color: '#F97316', description: 'Write 10 different hooks for your best product. Include origin stories, unique mechanisms, enemy angles, and transformation hooks.' },
        { number: 2, title: 'TEST', icon: 'BarChart2', color: '#3B82F6', description: 'A/B test your top 3 hooks as ad headlines or product page headlines. Run for 7-14 days with equal traffic.' },
        { number: 3, title: 'MEASURE', icon: 'Target', color: '#22C55E', description: 'Track conversions, not clicks. The hook that gets highest conversion rate is your winner. CTR means nothing without sales.' },
        { number: 4, title: 'BUILD', icon: 'Layers', color: '#8B5CF6', description: 'Build your entire funnel around the winning hook. Ads, landing page, emails - all reinforce that angle.' }
      ]},
      { type: 'tool-integration', title: 'Test Your Hooks Systematically', subtitle: 'Find your Forbidden Coffee angle with data', tool: { name: 'ABConvert', description: 'Shopify A/B testing app that lets you test headlines, images, prices, and layouts in minutes', link: 'https://apps.shopify.com/a-b-convert-price-a-b-test?mref=aviv-azriel', features: ['Test hook headlines on product pages', 'Statistical significance calculator', 'No coding required', 'Track actual conversions, not just clicks'] } },
      { type: 'quiz', question: 'What is the job of The Hook in the Hook-Story-Close framework?', options: ['List all product features', 'Create curiosity and get the click', 'Close the sale immediately', 'Show social proof and reviews'], correctIndex: 1, feedback: { correct: 'Exactly. The Hook has ONE job: create curiosity and get the click. Not to sell. Not to explain everything. Just to make them think "Wait... what?" and click to learn more. Once you have attention, THEN you can build the case with The Story. Trying to close before hooking is why most product pages fail.', incorrect: 'The Hook is not about selling or explaining. Its ONE job is to create curiosity. To make them think "Wait... what?" and click. That is it. Once you have attention, The Story builds the case. The Close removes friction. Each stage has a specific job. Mix them up and you lose conversions.' }},
      { type: 'completion', sources: [{ name: 'ABConvert (A/B Testing)', url: 'https://apps.shopify.com/a-b-convert-price-a-b-test?mref=aviv-azriel' }] }
    ];

    // Icons
    const Icons = {
      Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      Zap: ({ size = 18, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
      ExternalLink: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
      Link: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
      BookOpen: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
      ShoppingCart: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>,
      MapPin: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
      Cog: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
      Sword: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" y1="19" x2="19" y2="13"/><line x1="16" y1="16" x2="20" y2="20"/><line x1="19" y1="21" x2="21" y2="19"/></svg>,
      Sparkles: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>,
      Lightbulb: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>,
      BarChart2: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
      Target: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
      Layers: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
      Database: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
      ChevronDown: ({ size = 24, color = 'currentColor' }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>
    };

    // Animated Counter
    const AnimatedCounter = ({ target, suffix = '', prefix = '', duration = 2000, decimals = 0 }) => {
      const [count, setCount] = useState(0);
      useEffect(() => {
        let start = 0;
        const increment = target / (duration / 16);
        const timer = setInterval(() => {
          start += increment;
          if (start >= target) { setCount(target); clearInterval(timer); }
          else { setCount(start); }
        }, 16);
        return () => clearInterval(timer);
      }, [target, duration]);
      return <span>{prefix}{decimals > 0 ? count.toFixed(decimals) : Math.floor(count)}{suffix}</span>;
    };

    // Stat Countdown Slide
    const StatCountdownSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto py-8">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold mb-4" style={{ background: 'rgba(239, 68, 68, 0.1)', color: '#EF4444' }}>
            <Icons.BarChart2 size={14} color="#EF4444" />
            <span>The Problem</span>
          </div>
          <h2 className="slide-title text-2xl md:text-3xl lg:text-4xl text-black">{data.title}</h2>
        </motion.div>

        <div className="grid md:grid-cols-3 gap-6">
          {data.stats.map((stat, i) => (
            <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 + i * 0.15 }}
              className="rounded-2xl p-6 text-center relative overflow-hidden"
              style={{ background: '#0a0a0a', border: `1px solid ${stat.color}40`, boxShadow: `0 0 30px ${stat.color}15` }}>
              <div className="absolute top-0 left-0 w-full h-1 opacity-80" style={{ background: `linear-gradient(90deg, transparent, ${stat.color}, transparent)` }}></div>
              <div className="text-5xl md:text-6xl font-bold mb-2" style={{ color: stat.color }}>
                <AnimatedCounter target={stat.value} suffix={stat.suffix} duration={1500 + i * 300} decimals={stat.value < 1 ? 1 : 0} />
              </div>
              <p className="text-white font-semibold text-sm mb-1">{stat.label}</p>
              <p className="text-neutral-500 text-xs">{stat.subtext}</p>
            </motion.div>
          ))}
        </div>
      </div>
    );

    // Funnel Visual Slide
    const FunnelVisualSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto py-8">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold mb-4" style={{ background: 'rgba(249, 115, 22, 0.1)', color: '#F97316' }}>
            <Icons.Zap size={14} color="#F97316" />
            <span>The Framework</span>
          </div>
          <h2 className="slide-title text-2xl md:text-3xl lg:text-4xl text-black mb-2">{data.title}</h2>
          <p className="text-neutral-500 text-sm">{data.subtitle}</p>
        </motion.div>

        <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} transition={{ delay: 0.2 }}
          className="rounded-2xl p-8 md:p-12" style={{ background: '#0a0a0a', border: '1px solid #222', boxShadow: '0 0 40px rgba(249, 115, 22, 0.15)' }}>

          <div className="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8">
            {/* Hook */}
            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3 }}
              className="w-full md:w-48 rounded-xl p-5 text-center" style={{ background: '#F9731620', border: '1px solid #F97316' }}>
              <div className="w-12 h-12 rounded-xl mx-auto mb-3 flex items-center justify-center" style={{ background: '#F9731630' }}>
                <Icons.Zap size={24} color="#F97316" />
              </div>
              <h3 className="text-white font-bold text-lg mb-1">HOOK</h3>
              <p className="text-neutral-400 text-xs">Create Curiosity</p>
              <p className="text-orange-400 text-[10px] mt-2 font-semibold">GET THE CLICK</p>
            </motion.div>

            {/* Arrow */}
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }} className="text-neutral-600 hidden md:block">
              <svg width="40" height="20" viewBox="0 0 40 20" fill="none"><path d="M0 10H32M32 10L24 4M32 10L24 16" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>
            </motion.div>
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }} className="text-neutral-600 md:hidden">
              <Icons.ChevronDown size={24} color="#666" />
            </motion.div>

            {/* Story */}
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4 }}
              className="w-full md:w-48 rounded-xl p-5 text-center" style={{ background: '#3B82F620', border: '1px solid #3B82F6' }}>
              <div className="w-12 h-12 rounded-xl mx-auto mb-3 flex items-center justify-center" style={{ background: '#3B82F630' }}>
                <Icons.BookOpen size={24} color="#3B82F6" />
              </div>
              <h3 className="text-white font-bold text-lg mb-1">STORY</h3>
              <p className="text-neutral-400 text-xs">Build The Case</p>
              <p className="text-blue-400 text-[10px] mt-2 font-semibold">MAKE THEM FEEL IT</p>
            </motion.div>

            {/* Arrow */}
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.6 }} className="text-neutral-600 hidden md:block">
              <svg width="40" height="20" viewBox="0 0 40 20" fill="none"><path d="M0 10H32M32 10L24 4M32 10L24 16" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>
            </motion.div>
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.6 }} className="text-neutral-600 md:hidden">
              <Icons.ChevronDown size={24} color="#666" />
            </motion.div>

            {/* Close */}
            <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.5 }}
              className="w-full md:w-48 rounded-xl p-5 text-center" style={{ background: '#22C55E20', border: '1px solid #22C55E', boxShadow: '0 0 20px rgba(34, 197, 94, 0.2)' }}>
              <div className="w-12 h-12 rounded-xl mx-auto mb-3 flex items-center justify-center" style={{ background: '#22C55E30' }}>
                <Icons.ShoppingCart size={24} color="#22C55E" />
              </div>
              <h3 className="text-white font-bold text-lg mb-1">CLOSE</h3>
              <p className="text-neutral-400 text-xs">Remove Friction</p>
              <p className="text-green-400 text-[10px] mt-2 font-semibold">CONVERT THE SALE</p>
            </motion.div>
          </div>

          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.8 }}
            className="text-center text-neutral-400 text-sm mt-8">
            Do not try to <span className="text-red-400">close</span> before you <span className="text-orange-400">hooked</span>. Each stage has ONE job.
          </motion.p>
        </motion.div>
      </div>
    );

    // Framework Breakdown Slide
    const FrameworkBreakdownSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-10 max-w-5xl mx-auto py-6 slide-scroll overflow-y-auto">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
          <h2 className="slide-title text-xl md:text-2xl lg:text-3xl text-black">{data.title}</h2>
        </motion.div>

        <div className="grid md:grid-cols-3 gap-4">
          {data.stages.map((stage, i) => {
            const StageIcon = Icons[stage.icon] || Icons.Zap;
            return (
              <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 + i * 0.15 }}
                className="rounded-xl p-5 relative overflow-hidden"
                style={{ background: '#0a0a0a', border: `1px solid ${stage.color}40`, boxShadow: `0 0 25px ${stage.color}10` }}>
                <div className="absolute top-0 left-0 w-full h-1 opacity-80" style={{ background: `linear-gradient(90deg, transparent, ${stage.color}, transparent)` }}></div>

                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: `${stage.color}20`, border: `1px solid ${stage.color}` }}>
                    <StageIcon size={20} color={stage.color} />
                  </div>
                  <span className="text-lg font-bold" style={{ color: stage.color }}>{stage.name}</span>
                </div>

                <div className="space-y-3 text-sm">
                  <div><span className="text-neutral-500">Job:</span> <span className="text-white font-medium">{stage.job}</span></div>
                  <div><span className="text-neutral-500">Where:</span> <span className="text-neutral-300">{stage.where}</span></div>
                  <div><span className="text-neutral-500">Outcome:</span> <span className="font-semibold" style={{ color: stage.color }}>{stage.outcome}</span></div>
                </div>
              </motion.div>
            );
          })}
        </div>
      </div>
    );

    // Before After Hook Slide
    const BeforeAfterHookSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
          <h2 className="slide-title text-2xl md:text-3xl text-black">{data.title}</h2>
        </motion.div>

        <div className="grid md:grid-cols-2 gap-6 mb-6">
          <motion.div initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.15 }}
            className="rounded-2xl p-6" style={{ background: 'linear-gradient(135deg, #fef2f2, #fee2e2)', border: '1px solid #fecaca' }}>
            <div className="flex items-center gap-2 mb-4">
              <div className="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center text-white"><Icons.X /></div>
              <span className="px-2 py-0.5 rounded text-xs font-bold text-red-700 bg-red-100">{data.before.label}</span>
            </div>
            <p className="text-red-900 text-lg leading-relaxed italic">"{data.before.text}"</p>
          </motion.div>

          <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.2 }}
            className="rounded-2xl p-6" style={{ background: 'linear-gradient(135deg, #f0fdf4, #dcfce7)', border: '1px solid #bbf7d0' }}>
            <div className="flex items-center gap-2 mb-4">
              <div className="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white"><Icons.Check /></div>
              <span className="px-2 py-0.5 rounded text-xs font-bold text-green-700 bg-green-100">{data.after.label}</span>
            </div>
            <p className="text-green-900 text-lg leading-relaxed italic">"{data.after.text}"</p>
          </motion.div>
        </div>

        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4 }}
          className="rounded-xl p-4 text-center" style={{ background: '#0a0a0a', boxShadow: '0 0 30px rgba(249, 115, 22, 0.15)' }}>
          <p className="text-neutral-300 text-sm"><Icons.Zap className="inline mr-2" style={{ color: '#F97316' }} />{data.insight}</p>
        </motion.div>
      </div>
    );

    // Hook Elements Slide
    const HookElementsSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-10 max-w-5xl mx-auto py-6 slide-scroll overflow-y-auto">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: 'rgba(249, 115, 22, 0.1)', color: '#F97316' }}>
            <Icons.Lightbulb size={14} color="#F97316" />
            <span>Hook Discovery</span>
          </div>
          <h2 className="slide-title text-xl md:text-2xl lg:text-3xl text-black">{data.title}</h2>
        </motion.div>

        <div className="grid md:grid-cols-2 gap-4">
          {data.elements.map((element, i) => {
            const ElementIcon = Icons[element.icon] || Icons.Zap;
            return (
              <motion.div key={i} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 + i * 0.1 }}
                className="rounded-xl p-5 relative overflow-hidden"
                style={{ background: '#0a0a0a', border: `1px solid ${element.color}30` }}>
                <div className="flex items-start gap-4">
                  <div className="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style={{ background: `${element.color}20` }}>
                    <ElementIcon size={20} color={element.color} />
                  </div>
                  <div>
                    <h3 className="text-white font-bold text-base mb-2">{element.title}</h3>
                    <p className="text-neutral-400 text-sm leading-relaxed">{element.description}</p>
                  </div>
                </div>
              </motion.div>
            );
          })}
        </div>
      </div>
    );

    // Strategy Steps Slide
    const StrategyStepsSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-10 max-w-6xl mx-auto py-6 slide-scroll overflow-y-auto">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: 'rgba(249, 115, 22, 0.1)', color: '#F97316' }}>
            <Icons.Target size={14} color="#F97316" />
            <span>Your Action Plan</span>
          </div>
          <h2 className="slide-title text-xl md:text-2xl lg:text-3xl text-black">{data.title}</h2>
        </motion.div>

        <div className="grid md:grid-cols-4 gap-4">
          {data.steps.map((step, i) => {
            const StepIcon = Icons[step.icon] || Icons.Zap;
            return (
              <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 + i * 0.1 }}
                className="rounded-xl p-4 relative overflow-hidden"
                style={{ background: '#0a0a0a', border: `1px solid ${step.color}40`, boxShadow: `0 0 20px ${step.color}10` }}>
                <div className="absolute top-0 left-0 w-full h-1 opacity-80" style={{ background: `linear-gradient(90deg, transparent, ${step.color}, transparent)` }}></div>

                <div className="flex items-center gap-2 mb-3">
                  <div className="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold" style={{ background: `${step.color}20`, border: `1px solid ${step.color}`, color: step.color }}>
                    {step.number}
                  </div>
                  <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ background: `${step.color}15` }}>
                    <StepIcon size={16} color={step.color} />
                  </div>
                </div>

                <h3 className="text-base font-bold text-white mb-2">{step.title}</h3>
                <p className="text-neutral-400 text-xs leading-relaxed">{step.description}</p>
              </motion.div>
            );
          })}
        </div>
      </div>
    );

    // Tool Integration Slide
    const ToolIntegrationSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-10 max-w-4xl mx-auto py-6 slide-scroll overflow-y-auto">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-4">
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold mb-2" style={{ background: 'rgba(59, 130, 246, 0.1)', color: '#3B82F6' }}>
            <Icons.Database size={14} color="#3B82F6" />
            <span>Recommended Tool</span>
          </div>
          <h2 className="slide-title text-xl md:text-2xl lg:text-3xl text-black mb-1">{data.title}</h2>
          <p className="text-neutral-500 text-sm">{data.subtitle}</p>
        </motion.div>

        <motion.div initial={{ opacity: 0, scale: 0.98 }} animate={{ opacity: 1, scale: 1 }} transition={{ delay: 0.2 }}
          className="rounded-xl p-5" style={{ background: '#0a0a0a', border: '1px solid #3B82F630', boxShadow: '0 0 30px rgba(59, 130, 246, 0.08)' }}>
          <div className="flex items-center gap-3 mb-4">
            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: 'rgba(59, 130, 246, 0.15)', border: '1px solid #3B82F6' }}>
              <Icons.Database size={20} color="#3B82F6" />
            </div>
            <h3 className="text-white font-bold">{data.tool.name}</h3>
          </div>
          <p className="text-neutral-400 text-sm mb-4">{data.tool.description}</p>
          <ul className="space-y-2 mb-5">
            {data.tool.features.map((feature, i) => (
              <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3 + i * 0.08 }}
                className="flex items-center gap-2 text-neutral-300 text-sm">
                <span className="text-green-400"><Icons.Check /></span>
                {feature}
              </motion.li>
            ))}
          </ul>
          <a href={data.tool.link} target="_blank" rel="noopener noreferrer"
            className="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-semibold transition-all hover:opacity-90"
            style={{ background: 'linear-gradient(135deg, #3B82F6, #2563EB)', color: 'white' }}>
            <span>Try {data.tool.name}</span>
            <Icons.ExternalLink />
          </a>
        </motion.div>
      </div>
    );

    // Standard Slides
    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      useEffect(() => { onShowGif(welcomeData.gif, '65%', gifSide); return () => onHideGif(); }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-2 md:mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg lg:text-xl mb-2 md:mb-3 max-w-lg leading-relaxed" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center justify-center gap-1.5 text-neutral-400 text-[10px] md:text-xs mb-2 md:mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-xl md:rounded-2xl p-3 md:p-5 mb-3 md:mb-4 max-w-sm w-full mx-auto" style={{ boxShadow: '0 8px 32px rgba(0,0,0,0.4), 0 0 40px rgba(var(--accent-rgb),0.2)' }}>
              <p className="text-neutral-500 text-[9px] md:text-[11px] uppercase tracking-wider mb-2 md:mb-3">In this lesson</p>
              <ul className="space-y-1.5 md:space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>{i + 1}</span>
                    <span className="text-neutral-300 text-[11px] md:text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-6 md:px-7 py-2.5 md:py-3 rounded-xl text-white font-semibold text-sm md:text-base" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8 md:py-10 relative z-10">
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="mb-4 md:mb-6">
            <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold mb-3 md:mb-4" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}><Icons.Zap size={14} />The Hook</span>
            <h2 className="slide-title text-2xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-base md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
        </div>
        {data.characterVideo && (
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3, duration: 0.6 }}
            className={`absolute bottom-0 ${data.characterPosition === 'left' ? 'left-6' : 'right-6'} z-0 pointer-events-none hidden md:block`}
            style={{ height: '52%', maxHeight: '400px' }}>
            <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom">
              <source src={data.characterVideo} type="video/mp4" />
            </video>
          </motion.div>
        )}
      </div>
    );

    const ContentSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-8 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-10 relative z-10">
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }}>
            <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
              Key Concept
            </span>
            <h2 className="slide-title text-2xl md:text-3xl lg:text-4xl text-black mb-6">{data.title}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-base md:text-lg text-neutral-600 leading-relaxed">{data.body}</motion.p>
        </div>
        {data.characterVideo && (
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4, duration: 0.6 }}
            className={`absolute bottom-0 ${data.characterPosition === 'left' ? 'left-6' : 'right-6'} z-0 pointer-events-none hidden md:block`}
            style={{ height: '45%', maxHeight: '350px' }}>
            <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom">
              <source src={data.characterVideo} type="video/mp4" />
            </video>
          </motion.div>
        )}
      </div>
    );

    const QuizSlide = ({ data, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const celebrationGif = useMemo(() => getRandomCelebrationGif(), []);
      const empathyGif = useMemo(() => getRandomEmpathyGif(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      const handleSelect = (index) => { if (showFeedback) return; setSelected(index); setShowFeedback(true); };
      const isCorrect = selected === data.correctIndex;

      useEffect(() => { if (showFeedback) { if (isCorrect) { onShowGif(celebrationGif, '60%', gifSide); } else { onShowGif(empathyGif, '60%', gifSide); } } }, [showFeedback, isCorrect, celebrationGif, empathyGif, gifSide, onShowGif]);
      useEffect(() => { return () => onHideGif(); }, [onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col justify-center px-8 md:px-12 max-w-2xl mx-auto slide-scroll overflow-y-auto py-10 relative z-30">
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6 relative z-10">
              <p className="text-xs uppercase tracking-wider text-neutral-400 mb-3">Quick Check</p>
              <h2 className="slide-title text-xl md:text-2xl text-black leading-tight">{data.question}</h2>
            </motion.div>
            <div className="space-y-3 mb-6">
              {data.options.map((option, i) => (
                <motion.button key={i} initial={{ opacity: 0, x: -15 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.08 + i * 0.06 }} onClick={() => handleSelect(i)} disabled={showFeedback} className={`w-full p-4 rounded-xl text-left transition-all border-2 ${showFeedback ? i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-400 bg-red-50' : 'border-neutral-200 bg-white opacity-40' : 'border-neutral-200 bg-white hover:border-neutral-300'}`}>
                  <div className="flex items-center gap-3">
                    <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold transition-all ${showFeedback && i === data.correctIndex ? 'bg-green-500 text-white' : showFeedback && i === selected && !isCorrect ? 'bg-red-400 text-white' : 'bg-neutral-100 text-neutral-500'}`}>
                      {showFeedback && i === data.correctIndex ? <Icons.Check /> : showFeedback && i === selected && !isCorrect ? <Icons.X /> : String.fromCharCode(65 + i)}
                    </span>
                    <span className="text-neutral-700 text-sm md:text-base">{option}</span>
                  </div>
                </motion.button>
              ))}
            </div>
            <AnimatePresence>
              {showFeedback && (
                <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className={`p-5 rounded-xl ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                  <p className={`text-sm leading-relaxed ${isCorrect ? 'text-green-800' : 'text-amber-800'}`}>{isCorrect ? data.feedback.correct : data.feedback.incorrect}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      );
    };

    const CompletionSlide = ({ data }) => (
      <div className="h-full flex flex-col items-center justify-center text-center px-8 slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'spring', duration: 0.5 }} className="w-16 h-16 rounded-xl flex items-center justify-center mb-4 text-white" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))`, boxShadow: `0 6px 24px rgba(var(--accent-rgb), 0.35)` }}><Icons.Check /></motion.div>
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="slide-title text-2xl md:text-3xl text-black mb-3">Lesson Complete</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }} className="text-neutral-500 text-sm mb-5 max-w-md leading-relaxed">You now understand the Hook-Story-Close framework. Stop ramming features. Start creating curiosity. The Hook gets the click. The Story builds the case. The Close removes friction.</motion.p>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }} className="bg-neutral-900 rounded-xl p-5 max-w-md w-full mb-4" style={{ boxShadow: '0 0 30px rgba(var(--accent-rgb), 0.15)' }}>
          <p className="text-neutral-500 text-xs uppercase tracking-wider mb-2">Up Next</p>
          <h3 className="text-white font-bold text-lg mb-1">{LESSON_CONFIG.nextLesson.title}</h3>
          <p className="text-neutral-400 text-xs">{LESSON_CONFIG.nextLesson.teaser}</p>
        </motion.div>
        {data?.sources && data.sources.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} className="bg-neutral-50 border border-neutral-200 rounded-xl p-4 max-w-md w-full">
            <p className="text-neutral-400 text-xs uppercase tracking-wider mb-2 flex items-center justify-center gap-1"><Icons.Link /> Relevant Sources</p>
            <div className="space-y-1.5">
              {data.sources.map((source, i) => (
                <a key={i} href={source.url} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-2 text-sm font-medium transition-colors hover:underline" style={{ color: 'var(--accent)' }}>
                  {source.name}
                  <Icons.ExternalLink />
                </a>
              ))}
            </div>
          </motion.div>
        )}
      </div>
    );

    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(0);
      const [direction, setDirection] = useState(1);
      const userName = useMemo(() => getUserName(), []);
      const currentSlideRef = React.useRef(0);
      const [gifConfig, setGifConfig] = useState(null);
      const [isAnimating, setIsAnimating] = useState(false);

      const showGif = useCallback((url, height, side) => setGifConfig({ url, height, side }), []);
      const hideGif = useCallback(() => setGifConfig(null), []);

      React.useEffect(() => { currentSlideRef.current = currentSlide; }, [currentSlide]);

      useEffect(() => {
        window.parent.postMessage({
          type: 'LESSON_SLIDE_UPDATE',
          slideIndex: currentSlide,
          slideType: slides[currentSlide]?.type,
          lessonSlug: LESSON_CONFIG.id
        }, '*');
      }, [currentSlide]);

      const goToSlide = useCallback((newSlide) => {
        if (isAnimating || newSlide < 0 || newSlide >= slides.length) return;
        setIsAnimating(true);
        setDirection(newSlide > currentSlideRef.current ? 1 : -1);
        setCurrentSlide(newSlide);
      }, [isAnimating]);

      const nextSlide = useCallback(() => { if (currentSlideRef.current + 1 < slides.length) goToSlide(currentSlideRef.current + 1); }, [goToSlide]);
      const prevSlide = useCallback(() => { if (currentSlideRef.current - 1 >= 0) goToSlide(currentSlideRef.current - 1); }, [goToSlide]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [nextSlide, prevSlide]);

      const slideVariants = {
        enter: (dir) => ({ x: dir > 0 ? '100%' : '-100%', opacity: 0 }),
        center: { x: 0, opacity: 1 },
        exit: (dir) => ({ x: dir > 0 ? '-100%' : '100%', opacity: 0 })
      };

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={nextSlide} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'content': return <ContentSlide data={slide} />;
          case 'stat-countdown': return <StatCountdownSlide data={slide} />;
          case 'funnel-visual': return <FunnelVisualSlide data={slide} />;
          case 'framework-breakdown': return <FrameworkBreakdownSlide data={slide} />;
          case 'before-after-hook': return <BeforeAfterHookSlide data={slide} />;
          case 'hook-elements': return <HookElementsSlide data={slide} />;
          case 'strategy-steps': return <StrategyStepsSlide data={slide} />;
          case 'tool-integration': return <ToolIntegrationSlide data={slide} />;
          case 'quiz': return <QuizSlide data={slide} onShowGif={showGif} onHideGif={hideGif} />;
          case 'completion': return <CompletionSlide data={slide} />;
          default: return null;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction} onExitComplete={() => setIsAnimating(false)}>
              <motion.div key={currentSlide} custom={direction} variants={slideVariants} initial="enter" animate="center" exit="exit" transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
                <AdminSlideReportButton slideIndex={currentSlide} slideType={slides[currentSlide].type} />
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => goToSlide(i)} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gifConfig && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }} className={`absolute ${gifConfig.side === 'left' ? 'left-4 md:left-8' : 'right-4 md:right-8'} bottom-0 pointer-events-none`} style={{ zIndex: 15, height: gifConfig.height }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom" style={{ background: 'transparent', border: 'none', boxShadow: 'none' }}>
                  <source src={gifConfig.url} type="video/mp4" />
                </video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    ReactDOM.render(<LessonApp />, document.getElementById('root'));
  </script>
</body>
</html>
