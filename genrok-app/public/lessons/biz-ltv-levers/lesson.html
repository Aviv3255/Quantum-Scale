<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The LTV Control Panel | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #f97316; --accent-dark: #ea580c; --accent-light: #fb923c; --accent-rgb: 249, 115, 22; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => { const params = new URLSearchParams(window.location.search); return params.get('userName') || 'Builder'; };
    const getInitialSlide = () => { const params = new URLSearchParams(window.location.search); const slide = params.get('slide'); return slide ? parseInt(slide, 10) : 0; };

    const LESSON_CONFIG = {
      id: 'biz-ltv-levers',
      title: 'The LTV Control Panel',
      description: '7 levers to increase customer lifetime value and maximize profitability.',
      accentColor: '#f97316',
      duration: '8 min',
      nextLesson: { id: 'biz-operator-mindset', title: 'The Operator\'s Mindset', teaser: 'How Ben Francis built Gymshark to $1.5B by stepping down as CEO.' }
    };

    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_playing_air_guitar_light_headbanging_rockstar__0702007e-9e84-4d9e-8f99-8ee23d0b65f8_2.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];

    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    const Icons = {
      Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      ExternalLink: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
      Link: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
      DollarSign: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
      TrendingUp: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
      Package: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
      Sliders: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>,
      ShoppingCart: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>,
      CreditCard: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
      Layers: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
      Zap: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
    };

    // AnimatedCounter with optional prefix/suffix
    const AnimatedCounter = ({ value, duration = 1.5, prefix = '', suffix = '', decimals = 0 }) => {
      const [count, setCount] = useState(0);
      useEffect(() => {
        let start = 0;
        const end = parseFloat(value);
        const increment = end / (duration * 60);
        const timer = setInterval(() => {
          start += increment;
          if (start >= end) { setCount(end); clearInterval(timer); }
          else { setCount(start); }
        }, 1000 / 60);
        return () => clearInterval(timer);
      }, [value, duration]);
      return <span>{prefix}{count.toFixed(decimals)}{suffix}</span>;
    };

    const slides = [
      { type: 'welcome', learningGoals: ['The 7 levers that control customer lifetime value', 'How post-purchase upsells multiply profit instantly', 'The lever stacking strategy that 10x\'s results'] },
      { type: 'hook', headline: 'Most stores leave 30-40% of revenue on the table. It\'s sitting right there. You just need to pull the right levers.', subtext: 'There are exactly 7 levers that control LTV. Each one multiplies your profit per customer. Most businesses pull one or two. The pros stack all seven.', brandImage: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/Gymshark_Limited_Logo.png', brandName: 'Gymshark' },
      { type: 'control-panel', title: 'The 7 LTV Levers', levers: [
        { name: 'Price', icon: 'DollarSign', impact: '+15%', description: 'Raise prices, filter tire-kickers' },
        { name: 'COGS', icon: 'Package', impact: '-8%', description: 'Cut costs, protect margins' },
        { name: 'Upsells', icon: 'TrendingUp', impact: '+30%', description: 'Post-purchase offers' },
        { name: 'Downsells', icon: 'Layers', impact: '+12%', description: 'Recover declined offers' },
        { name: 'Cross-Sells', icon: 'ShoppingCart', impact: '+20%', description: 'Complementary products' },
        { name: 'Financing', icon: 'CreditCard', impact: '+25%', description: 'Payment plans unlock purchases' },
        { name: 'Terms', icon: 'Zap', impact: '+10%', description: 'Cash flow acceleration' }
      ]},
      { type: 'lever-detail', leverNumber: 1, name: 'Raise the Price', impact: '+15%', color: '#22C55E', body: 'The easiest lever to pull. Most businesses undercharge out of fear. But higher prices signal quality. They filter out tire-kickers and attract serious buyers. You lose 10% of customers but make 40% more per sale. Net result? Massive profit increase.' },
      { type: 'lever-detail', leverNumber: 2, name: 'Decrease COGS', impact: '-8% costs', color: '#3B82F6', body: 'Cost of Goods Sold. Every dollar saved here is pure profit. Negotiate with suppliers. Buy in bulk. Find better manufacturers. Optimize shipping. Small percentage improvements multiply across thousands of orders.' },
      { type: 'lever-detail', leverNumber: 3, name: 'Add Upsells', impact: '+30%', color: '#F59E0B', body: 'The customer just bought. Their wallet is out. Their trust is high. This is the perfect moment to offer something else. Upsells cost nothing to present but add 20-50% to order value. This lever alone can double your LTV overnight.' },
      { type: 'implementation', title: 'Post-Purchase Upsells That Actually Work', steps: [
        { step: 1, title: 'Install ReConvert', description: 'The leading post-purchase upsell app for Shopify. Free trial available.' },
        { step: 2, title: 'Create Your First Offer', description: 'Offer a complementary product at 15-20% off. One-click add to order.' },
        { step: 3, title: 'Set Up Thank You Page', description: 'Replace boring confirmation with upsell opportunity.' },
        { step: 4, title: 'Track and Optimize', description: 'Measure take rate. Target 15-25% acceptance.' }
      ], toolUrl: 'https://apps.shopify.com/reconvert-upsell-cross-sell?mref=lsbqcbva', cta: 'Get ReConvert Free' },
      { type: 'lever-detail', leverNumber: 4, name: 'Add Downsells', impact: '+12%', color: '#8B5CF6', body: 'They said no to your upsell. Don\'t give up. Offer something smaller. A lower-priced version. A single unit instead of a bundle. Downsells recover 10-20% of declined upsells. That\'s pure money you would have left on the table.' },
      { type: 'lever-detail', leverNumber: 5, name: 'Add Cross-Sells', impact: '+20%', color: '#EC4899', body: 'Similar to upsells but horizontal instead of vertical. Not a better version - a different product. Bought shoes? Here are socks. Bought a camera? Here\'s a memory card. Cross-sells work because the customer is already in buying mode.' },
      { type: 'lever-detail', leverNumber: 6, name: 'Introduce Financing', impact: '+25%', color: '#14B8A6', body: 'Price objections evaporate when you offer payment plans. A $600 product becomes $50/month. Suddenly affordable. Klarna, Afterpay, Affirm - they handle everything. You get paid upfront. Higher-ticket purchases become accessible.' },
      { type: 'lever-detail', leverNumber: 7, name: 'Change Payment Terms', impact: '+10%', color: '#F97316', body: 'Get paid immediately but let fulfillment happen later. Or charge upfront for subscriptions. Or offer annual plans with discounts. The faster you collect cash, the faster you can reinvest in growth.' },
      { type: 'stacking', title: 'The Stacking Effect', before: { aov: 80, label: 'Single Lever', description: 'One upsell added. AOV: $95. +18% increase.' }, after: { aov: 140, label: 'All 7 Levers', description: 'Price +10%, COGS -5%, Upsells +30%, Financing +20%. +75% total.' }, insight: 'Levers compound. Each one multiplies the effect of the others.' },
      { type: 'priority-matrix', title: 'Which Levers to Pull First', priorities: [
        { rank: 1, name: 'Upsells', effort: 'Low', impact: 'High', reason: 'Easiest to implement. Immediate impact. No risk.' },
        { rank: 2, name: 'Pricing', effort: 'Low', impact: 'High', reason: 'Raise by 10-15%. Most stores undercharge.' },
        { rank: 3, name: 'Financing', effort: 'Medium', impact: 'High', reason: 'Klarna/Afterpay integrate in minutes.' },
        { rank: 4, name: 'Cross-Sells', effort: 'Medium', impact: 'Medium', reason: 'Requires product selection strategy.' }
      ]},
      { type: 'quiz', question: 'Which lever has the most immediate impact on LTV with near-zero implementation cost?', options: ['Raise the price', 'Add post-purchase upsells', 'Decrease COGS', 'Introduce financing'], correctIndex: 1, feedback: { correct: 'Exactly. Post-purchase upsells cost nothing to implement and convert at 15-25%. You\'re catching customers right after they bought, when trust is highest.', incorrect: 'Not quite. While all levers work, post-purchase upsells have the most immediate impact with near-zero cost. The customer just bought and their wallet is out.' }},
      { type: 'mindset-shift', title: 'Stop Thinking About One Lever. Start Thinking About All Seven.', insight: 'The difference between a $50 customer and a $500 customer isn\'t the product. It\'s how many levers you\'re pulling.' },
      { type: 'completion', sources: [{ name: 'ReConvert Post-Purchase Upsells', url: 'https://apps.shopify.com/reconvert-upsell-cross-sell?mref=lsbqcbva' }] }
    ];

    // ============ CUSTOM SLIDE COMPONENTS ============

    // Control Panel Slide - 7 Levers visualization
    const ControlPanelSlide = ({ data }) => {
      const [activeIndex, setActiveIndex] = useState(0);

      useEffect(() => {
        const timer = setInterval(() => {
          setActiveIndex(prev => (prev + 1) % data.levers.length);
        }, 2000);
        return () => clearInterval(timer);
      }, [data.levers.length]);

      const getIcon = (iconName) => {
        const IconComponent = Icons[iconName];
        return IconComponent ? <IconComponent /> : null;
      };

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto slide-scroll overflow-y-auto py-8">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
            <span className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: 'rgba(var(--accent-rgb), 0.1)', color: 'var(--accent)' }}>
              <Icons.Sliders /> Control Panel
            </span>
            <h2 className="slide-title text-2xl md:text-4xl text-black">{data.title}</h2>
          </motion.div>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            {data.levers.slice(0, 4).map((lever, i) => (
              <motion.div
                key={i}
                initial={{ opacity: 0, y: 30 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.1 + i * 0.08 }}
                className="relative overflow-hidden rounded-xl p-4"
                style={{
                  background: activeIndex === i ? 'linear-gradient(135deg, #0a0a0a, #1a1a1a)' : 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
                  border: activeIndex === i ? '2px solid var(--accent)' : '1px solid rgba(255,255,255,0.1)',
                  boxShadow: activeIndex === i ? '0 0 30px rgba(var(--accent-rgb), 0.3)' : 'none',
                  transition: 'all 0.3s ease'
                }}
              >
                <div className="absolute top-0 left-0 right-0 h-1" style={{ background: activeIndex === i ? 'linear-gradient(90deg, transparent, var(--accent), transparent)' : 'transparent' }} />
                <div className="flex items-center gap-2 mb-2">
                  <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ background: 'rgba(var(--accent-rgb), 0.2)', color: 'var(--accent)' }}>
                    {getIcon(lever.icon)}
                  </div>
                  <span className="text-white font-bold text-sm">{lever.name}</span>
                </div>
                <div className="text-2xl font-bold mb-1" style={{ color: 'var(--accent)' }}>{lever.impact}</div>
                <div className="text-neutral-400 text-xs">{lever.description}</div>
              </motion.div>
            ))}
          </div>

          <div className="grid grid-cols-3 gap-3">
            {data.levers.slice(4).map((lever, i) => (
              <motion.div
                key={i + 4}
                initial={{ opacity: 0, y: 30 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.4 + i * 0.08 }}
                className="relative overflow-hidden rounded-xl p-4"
                style={{
                  background: activeIndex === i + 4 ? 'linear-gradient(135deg, #0a0a0a, #1a1a1a)' : 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
                  border: activeIndex === i + 4 ? '2px solid var(--accent)' : '1px solid rgba(255,255,255,0.1)',
                  boxShadow: activeIndex === i + 4 ? '0 0 30px rgba(var(--accent-rgb), 0.3)' : 'none',
                  transition: 'all 0.3s ease'
                }}
              >
                <div className="absolute top-0 left-0 right-0 h-1" style={{ background: activeIndex === i + 4 ? 'linear-gradient(90deg, transparent, var(--accent), transparent)' : 'transparent' }} />
                <div className="flex items-center gap-2 mb-2">
                  <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ background: 'rgba(var(--accent-rgb), 0.2)', color: 'var(--accent)' }}>
                    {getIcon(lever.icon)}
                  </div>
                  <span className="text-white font-bold text-sm">{lever.name}</span>
                </div>
                <div className="text-2xl font-bold mb-1" style={{ color: 'var(--accent)' }}>{lever.impact}</div>
                <div className="text-neutral-400 text-xs">{lever.description}</div>
              </motion.div>
            ))}
          </div>
        </div>
      );
    };

    // Lever Detail Slide
    const LeverDetailSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="mb-6">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg" style={{ background: data.color }}>
              {data.leverNumber}
            </div>
            <div>
              <span className="text-xs font-semibold uppercase tracking-wider" style={{ color: data.color }}>Lever {data.leverNumber}</span>
              <h2 className="slide-title text-2xl md:text-3xl text-black">{data.name}</h2>
            </div>
          </div>

          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.2 }}
            className="inline-flex items-center gap-2 px-4 py-2 rounded-xl mb-6"
            style={{ background: 'linear-gradient(135deg, #0a0a0a, #1a1a1a)', border: `2px solid ${data.color}`, boxShadow: `0 0 30px ${data.color}30` }}
          >
            <Icons.TrendingUp />
            <span className="text-2xl font-bold text-white">{data.impact}</span>
            <span className="text-neutral-400 text-sm">LTV Impact</span>
          </motion.div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.15 }}
          className="rounded-xl p-6"
          style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', border: '1px solid rgba(255,255,255,0.1)' }}
        >
          <p className="text-neutral-300 text-base md:text-lg leading-relaxed">{data.body}</p>
        </motion.div>
      </div>
    );

    // Stacking Effect Slide
    const StackingSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
          <span className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: 'rgba(var(--accent-rgb), 0.1)', color: 'var(--accent)' }}>
            <Icons.Layers /> Compound Effect
          </span>
          <h2 className="slide-title text-2xl md:text-4xl text-black">{data.title}</h2>
        </motion.div>

        <div className="grid md:grid-cols-2 gap-6 mb-6">
          <motion.div
            initial={{ opacity: 0, x: -30 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: 0.1 }}
            className="rounded-xl p-6 text-center"
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', border: '1px solid rgba(255,255,255,0.1)' }}
          >
            <div className="text-neutral-400 text-xs uppercase tracking-wider mb-2">{data.before.label}</div>
            <div className="text-5xl md:text-6xl font-bold text-white mb-3">
              $<AnimatedCounter value={data.before.aov} duration={1} />
            </div>
            <div className="text-neutral-400 text-sm">{data.before.description}</div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, x: 30 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: 0.2 }}
            className="rounded-xl p-6 text-center relative overflow-hidden"
            style={{ background: 'linear-gradient(135deg, #0a0a0a, #1a1a1a)', border: '2px solid var(--accent)', boxShadow: '0 0 40px rgba(var(--accent-rgb), 0.3)' }}
          >
            <div className="absolute top-0 left-0 right-0 h-1" style={{ background: 'linear-gradient(90deg, transparent, var(--accent), transparent)' }} />
            <div className="text-xs uppercase tracking-wider mb-2" style={{ color: 'var(--accent)' }}>{data.after.label}</div>
            <div className="text-5xl md:text-6xl font-bold mb-3" style={{ color: 'var(--accent)' }}>
              $<AnimatedCounter value={data.after.aov} duration={1.5} />
            </div>
            <div className="text-neutral-300 text-sm">{data.after.description}</div>
            <div className="mt-4 inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-bold" style={{ background: 'rgba(34, 197, 94, 0.2)', color: '#22C55E' }}>
              +75% Total Increase
            </div>
          </motion.div>
        </div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="rounded-xl p-4 text-center"
          style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', border: '1px solid rgba(255,255,255,0.1)' }}
        >
          <Icons.Zap className="inline mr-2" style={{ color: 'var(--accent)' }} />
          <span className="text-neutral-300 text-sm">{data.insight}</span>
        </motion.div>
      </div>
    );

    // Priority Matrix Slide
    const PriorityMatrixSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
          <h2 className="slide-title text-2xl md:text-3xl text-black">{data.title}</h2>
        </motion.div>

        <div className="space-y-3">
          {data.priorities.map((item, i) => (
            <motion.div
              key={i}
              initial={{ opacity: 0, x: -30 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.1 + i * 0.1 }}
              className="flex items-center gap-4 rounded-xl p-4"
              style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', border: i === 0 ? '2px solid var(--accent)' : '1px solid rgba(255,255,255,0.1)', boxShadow: i === 0 ? '0 0 30px rgba(var(--accent-rgb), 0.2)' : 'none' }}
            >
              <div className="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold" style={{ background: i === 0 ? 'var(--accent)' : 'rgba(255,255,255,0.1)' }}>
                {item.rank}
              </div>
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-1">
                  <span className="text-white font-bold">{item.name}</span>
                  <span className="px-2 py-0.5 rounded text-xs font-medium" style={{ background: item.impact === 'High' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(251, 191, 36, 0.2)', color: item.impact === 'High' ? '#22C55E' : '#FBBF24' }}>
                    {item.impact} Impact
                  </span>
                  <span className="px-2 py-0.5 rounded text-xs font-medium" style={{ background: item.effort === 'Low' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(251, 191, 36, 0.2)', color: item.effort === 'Low' ? '#22C55E' : '#FBBF24' }}>
                    {item.effort} Effort
                  </span>
                </div>
                <p className="text-neutral-400 text-sm">{item.reason}</p>
              </div>
            </motion.div>
          ))}
        </div>
      </div>
    );

    // Mindset Shift Slide
    const MindsetShiftSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center items-center px-6 md:px-16 max-w-3xl mx-auto text-center slide-scroll overflow-y-auto py-8">
        <motion.div
          initial={{ opacity: 0, scale: 0.8 }}
          animate={{ opacity: 1, scale: 1 }}
          className="w-16 h-16 rounded-xl flex items-center justify-center mb-6"
          style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))', boxShadow: '0 0 40px rgba(var(--accent-rgb), 0.4)' }}
        >
          <Icons.Sliders />
        </motion.div>

        <motion.h2
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          className="slide-title text-2xl md:text-4xl text-black mb-6 leading-tight"
        >
          {data.title}
        </motion.h2>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.2 }}
          className="rounded-xl p-6 max-w-xl"
          style={{ background: 'linear-gradient(135deg, #0a0a0a, #1a1a1a)', border: '1px solid rgba(255,255,255,0.1)' }}
        >
          <p className="text-neutral-300 text-lg leading-relaxed">{data.insight}</p>
        </motion.div>
      </div>
    );

    // ============ STANDARD SLIDE COMPONENTS ============

    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      useEffect(() => { onShowGif(welcomeData.gif, '65%', gifSide); return () => onHideGif(); }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-2 md:mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg lg:text-xl mb-2 md:mb-3 max-w-lg leading-relaxed" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center justify-center gap-1.5 text-neutral-400 text-[10px] md:text-xs mb-2 md:mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-xl md:rounded-2xl p-3 md:p-5 mb-3 md:mb-4 max-w-sm w-full mx-auto">
              <p className="text-neutral-500 text-[9px] md:text-[11px] uppercase tracking-wider mb-2 md:mb-3">In this lesson</p>
              <ul className="space-y-1.5 md:space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>{i + 1}</span>
                    <span className="text-neutral-300 text-[11px] md:text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-6 md:px-7 py-2.5 md:py-3 rounded-xl text-white font-semibold text-sm md:text-base" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8 md:py-10 relative z-10">
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="mb-4 md:mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3 md:mb-4" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>The Hook</span>
            <h2 className="slide-title text-2xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-base md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
        </div>
        {data.brandImage && (
          <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3, duration: 0.5 }}
            className="absolute bottom-0 right-0 z-0 pointer-events-none hidden md:block" style={{ height: '30%', maxHeight: '200px', marginRight: '80px', marginBottom: '5%' }}>
            <img src={data.brandImage} alt={data.brandName || ''} className="h-full w-auto object-contain" style={{ opacity: 1 }} />
          </motion.div>
        )}
      </div>
    );

    const ImplementationSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-4">
          <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-2 bg-emerald-100 text-emerald-700">How To Do It</span>
          <h2 className="slide-title text-2xl md:text-3xl text-black">{data.title}</h2>
        </motion.div>
        <div className="space-y-3">
          {data.steps && data.steps.map((step, i) => (
            <motion.div key={i} initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 + i * 0.08 }} className="flex gap-4 rounded-xl p-4" style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', border: '1px solid rgba(255,255,255,0.1)' }}>
              <div className="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm flex-shrink-0" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))' }}>{step.step}</div>
              <div className="flex-1">
                <h4 className="font-semibold text-white text-sm mb-1">{step.title}</h4>
                <p className="text-neutral-400 text-xs leading-relaxed">{step.description}</p>
              </div>
            </motion.div>
          ))}
        </div>
        {data.toolUrl && <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.5 }} className="mt-6 text-center">
          <a href={data.toolUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl text-white font-medium text-sm" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))' }}>
            {data.cta || 'Get Started'} <Icons.ExternalLink />
          </a>
        </motion.div>}
      </div>
    );

    const QuizSlide = ({ data, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const celebrationGif = useMemo(() => getRandomCelebrationGif(), []);
      const empathyGif = useMemo(() => getRandomEmpathyGif(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      const handleSelect = (index) => { if (showFeedback) return; setSelected(index); setShowFeedback(true); };
      const isCorrect = selected === data.correctIndex;

      useEffect(() => { if (showFeedback) { if (isCorrect) { onShowGif(celebrationGif, '60%', gifSide); } else { onShowGif(empathyGif, '60%', gifSide); } } }, [showFeedback, isCorrect, celebrationGif, empathyGif, gifSide, onShowGif]);
      useEffect(() => { return () => onHideGif(); }, [onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col justify-center px-8 md:px-12 max-w-2xl mx-auto slide-scroll overflow-y-auto py-10 relative z-30">
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6 relative z-10">
              <p className="text-xs uppercase tracking-wider text-neutral-400 mb-3">Quick Check</p>
              <h2 className="slide-title text-xl md:text-2xl text-black leading-tight">{data.question}</h2>
            </motion.div>
            <div className="space-y-3 mb-6">
              {data.options.map((option, i) => (
                <motion.button key={i} initial={{ opacity: 0, x: -15 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.08 + i * 0.06 }} onClick={() => handleSelect(i)} disabled={showFeedback} className={`w-full p-4 rounded-xl text-left transition-all border-2 ${showFeedback ? i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-400 bg-red-50' : 'border-neutral-200 bg-white opacity-40' : 'border-neutral-200 bg-white hover:border-neutral-300'}`}>
                  <div className="flex items-center gap-3">
                    <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold transition-all ${showFeedback && i === data.correctIndex ? 'bg-green-500 text-white' : showFeedback && i === selected && !isCorrect ? 'bg-red-400 text-white' : 'bg-neutral-100 text-neutral-500'}`}>
                      {showFeedback && i === data.correctIndex ? <Icons.Check /> : showFeedback && i === selected && !isCorrect ? <Icons.X /> : String.fromCharCode(65 + i)}
                    </span>
                    <span className="text-neutral-700 text-sm md:text-base">{option}</span>
                  </div>
                </motion.button>
              ))}
            </div>
            <AnimatePresence>
              {showFeedback && (
                <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className={`p-5 rounded-xl ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                  <p className={`text-sm leading-relaxed ${isCorrect ? 'text-green-800' : 'text-amber-800'}`}>{isCorrect ? data.feedback.correct : data.feedback.incorrect}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      );
    };

    const CompletionSlide = ({ data }) => (
      <div className="h-full flex flex-col items-center justify-center text-center px-8 slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'spring', duration: 0.5 }} className="w-16 h-16 rounded-xl flex items-center justify-center mb-4 text-white" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))`, boxShadow: `0 6px 24px rgba(var(--accent-rgb), 0.35)` }}><Icons.Check /></motion.div>
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="slide-title text-2xl md:text-3xl text-black mb-3">Lesson Complete</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }} className="text-neutral-500 text-sm mb-5 max-w-md leading-relaxed">You now understand the 7 LTV levers. Price. COGS. Upsells. Downsells. Cross-sells. Financing. Payment terms. Stack them all for maximum impact.</motion.p>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }} className="bg-neutral-900 rounded-xl p-5 max-w-md w-full mb-4">
          <p className="text-neutral-500 text-xs uppercase tracking-wider mb-2">Up Next</p>
          <h3 className="text-white font-bold text-lg mb-1">{LESSON_CONFIG.nextLesson.title}</h3>
          <p className="text-neutral-400 text-xs">{LESSON_CONFIG.nextLesson.teaser}</p>
        </motion.div>
        {data?.sources && data.sources.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} className="bg-neutral-50 border border-neutral-200 rounded-xl p-4 max-w-md w-full">
            <p className="text-neutral-400 text-xs uppercase tracking-wider mb-2 flex items-center justify-center gap-1"><Icons.Link /> Relevant Sources</p>
            <div className="space-y-1.5">
              {data.sources.map((source, i) => (
                <a key={i} href={source.url} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-2 text-sm font-medium transition-colors hover:underline" style={{ color: 'var(--accent)' }}>
                  {source.name}
                  <Icons.ExternalLink />
                </a>
              ))}
            </div>
          </motion.div>
        )}
      </div>
    );

    // ============ MAIN APP ============

    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(getInitialSlide());
      const [direction, setDirection] = useState(1);
      const userName = useMemo(() => getUserName(), []);
      const currentSlideRef = React.useRef(0);
      const [gifConfig, setGifConfig] = useState(null);
      const [isAnimating, setIsAnimating] = useState(false);

      const showGif = useCallback((url, height, side) => setGifConfig({ url, height, side }), []);
      const hideGif = useCallback(() => setGifConfig(null), []);

      React.useEffect(() => { currentSlideRef.current = currentSlide; }, [currentSlide]);

      const goToSlide = useCallback((newSlide) => {
        if (isAnimating || newSlide < 0 || newSlide >= slides.length) return;
        setIsAnimating(true);
        setDirection(newSlide > currentSlideRef.current ? 1 : -1);
        setCurrentSlide(newSlide);
      }, [isAnimating]);

      const nextSlide = useCallback(() => { if (currentSlideRef.current + 1 < slides.length) goToSlide(currentSlideRef.current + 1); }, [goToSlide]);
      const prevSlide = useCallback(() => { if (currentSlideRef.current - 1 >= 0) goToSlide(currentSlideRef.current - 1); }, [goToSlide]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [nextSlide, prevSlide]);

      const slideVariants = {
        enter: (dir) => ({ x: dir > 0 ? '100%' : '-100%', opacity: 0 }),
        center: { x: 0, opacity: 1 },
        exit: (dir) => ({ x: dir > 0 ? '-100%' : '100%', opacity: 0 })
      };

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={nextSlide} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'control-panel': return <ControlPanelSlide data={slide} />;
          case 'lever-detail': return <LeverDetailSlide data={slide} />;
          case 'stacking': return <StackingSlide data={slide} />;
          case 'priority-matrix': return <PriorityMatrixSlide data={slide} />;
          case 'implementation': return <ImplementationSlide data={slide} />;
          case 'mindset-shift': return <MindsetShiftSlide data={slide} />;
          case 'quiz': return <QuizSlide data={slide} onShowGif={showGif} onHideGif={hideGif} />;
          case 'completion': return <CompletionSlide data={slide} />;
          default: return null;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction} onExitComplete={() => setIsAnimating(false)}>
              <motion.div key={currentSlide} custom={direction} variants={slideVariants} initial="enter" animate="center" exit="exit" transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => goToSlide(i)} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gifConfig && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }} className={`absolute ${gifConfig.side === 'left' ? 'left-4 md:left-8' : 'right-4 md:right-8'} bottom-0 pointer-events-none`} style={{ zIndex: 15, height: gifConfig.height }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom" style={{ background: 'transparent', border: 'none', boxShadow: 'none' }}>
                  <source src={gifConfig.url} type="video/mp4" />
                </video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    ReactDOM.render(<LessonApp />, document.getElementById('root'));
  </script>
</body>
</html>
