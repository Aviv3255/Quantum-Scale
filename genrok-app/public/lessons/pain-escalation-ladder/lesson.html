<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Pain Escalation Ladder | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #dc2626; --accent-dark: #b91c1c; --accent-light: #ef4444; --accent-rgb: 220, 38, 38; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => { const params = new URLSearchParams(window.location.search); return params.get('userName') || 'Builder'; };
    const getInitialSlide = () => { const params = new URLSearchParams(window.location.search); const slide = params.get('slide'); return slide ? parseInt(slide, 10) : 0; };

    const LESSON_CONFIG = {
      id: 'pain-escalation-ladder',
      title: 'The Pain Escalation Ladder',
      description: 'How to ethically escalate customer pain from "meh" to "I NEED this NOW"',
      accentColor: '#dc2626',
      duration: '8 min',
      nextLesson: { id: 'digital-pause-power', title: 'The Digital Pause', teaser: 'Why confident silence at checkout converts better than desperate discounts.' }
    };

    // Admin Reporter System
    let __isAdmin = false;
    window.addEventListener('message', function(e) { if (e.data?.type === 'ADMIN_STATUS') { __isAdmin = e.data.isAdmin; } });
    if (window.parent !== window) { window.parent.postMessage({ type: 'CHECK_ADMIN_STATUS' }, '*'); }
    const AdminSlideReportButton = ({ slideIndex, slideType }) => {
      const handleReport = (e) => { e.stopPropagation(); e.preventDefault(); if (window.parent !== window) { window.parent.postMessage({ type: 'ADMIN_REPORT_REQUEST', slideIndex, slideType, lessonSlug: LESSON_CONFIG.id, elementId: slideType + '-' + slideIndex }, '*'); } };
      return ( <button onClick={handleReport} title={`Report issue on Slide ${slideIndex + 1} (${slideType})`} style={{ position: 'absolute', top: '12px', right: '12px', width: '32px', height: '32px', borderRadius: '8px', backgroundColor: 'rgba(239, 68, 68, 0.9)', color: 'white', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, opacity: 0.6, transition: 'opacity 0.2s, transform 0.2s', boxShadow: '0 2px 8px rgba(0,0,0,0.15)' }} onMouseEnter={(e) => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.transform = 'scale(1.1)'; }} onMouseLeave={(e) => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.transform = 'scale(1)'; }}> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg> </button> );
    };

    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];
    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    // ============ ANIMATED COUNTER ============
    const AnimatedCounter = ({ target, suffix = '', prefix = '', duration = 2000, decimals = 0 }) => {
      const [count, setCount] = useState(0);
      useEffect(() => {
        let start = 0;
        const end = parseFloat(target);
        const increment = end / (duration / 16);
        const timer = setInterval(() => {
          start += increment;
          if (start >= end) { setCount(end); clearInterval(timer); }
          else { setCount(start); }
        }, 16);
        return () => clearInterval(timer);
      }, [target, duration]);
      return <span>{prefix}{decimals > 0 ? count.toFixed(decimals) : Math.round(count)}{suffix}</span>;
    };

    // ============ ICONS ============
    const Icons = {
      Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      Zap: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
      Link: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
      ExternalLink: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
      AlertTriangle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
      Eye: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
      EyeOff: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
      Flame: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>,
      TrendingUp: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
      Target: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
      MessageCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
      Mail: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
      ShoppingCart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>,
      Brain: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
      Lightbulb: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
      Quote: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" opacity="0.3"><path d="M11 7H7a4 4 0 0 0-4 4v7h7v-7H6a2 2 0 0 1 2-2h3V7zm10 0h-4a4 4 0 0 0-4 4v7h7v-7h-4a2 2 0 0 1 2-2h3V7z"/></svg>,
      ArrowUp: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>,
    };

    // ============ SLIDES DATA ============
    const slides = [
      {
        type: 'welcome',
        learningGoals: [
          'The 3 stages of pain escalation',
          'How to surface hidden problems customers ignore',
          'Where to use each stage in your funnel',
          'Transform "meh" into "I NEED this NOW"'
        ]
      },
      {
        type: 'hook',
        headline: 'Your customers have problems they do not even know they have.',
        subtext: 'They are numb to their own pain. They have normalized the frustration, the wasted time, the missed opportunities. Your job is not to CREATE pain. It is to make existing pain impossible to ignore.'
      },
      { type: 'pain-ladder-visual' },
      { type: 'stage-detail', stage: 1 },
      { type: 'stage-detail', stage: 2 },
      { type: 'stage-detail', stage: 3 },
      { type: 'funnel-mapping' },
      { type: 'playbook-grid' },
      { type: 'before-after-example' },
      {
        type: 'quiz',
        question: 'What is "Latent Pain" in the Pain Escalation Framework?',
        options: [
          'Pain the customer is actively complaining about',
          'Pain they have but do not consciously recognize',
          'Pain created by your marketing',
          'Pain from competitor products'
        ],
        correctIndex: 1,
        feedback: {
          correct: 'Exactly! Latent Pain is a problem customers have but do not consciously recognize. They have normalized it. Your first job is to surface this hidden frustration.',
          incorrect: 'Not quite. Latent Pain is a problem customers have but have become numb to. Your marketing does not create pain - it surfaces existing pain they have been ignoring.'
        }
      },
      { type: 'impact-stats' },
      { type: 'elite-insight' },
      {
        type: 'completion',
        sources: []
      }
    ];

    // ============ STAGE CONFIGURATIONS ============
    const STAGES = [
      { num: 1, name: 'Latent Pain', color: '#94a3b8', desc: 'A problem they have but do not consciously recognize - or have become numb to.', quote: '"My job is just okay."', icon: Icons.EyeOff, trigger: 'Awareness Questions', example: '"Is your morning coffee not hitting the same anymore?"' },
      { num: 2, name: 'Realized Pain', color: '#f97316', desc: 'You plant a seed and make them aware of the problem and its implications.', quote: '"Wait, I could be doing so much more. I actually hate my job."', icon: Icons.Eye, trigger: 'What-If Scenarios', example: '"Imagine another holiday passes and you still do not feel confident..."' },
      { num: 3, name: 'Extreme Pain', color: '#dc2626', desc: 'You articulate the true cost of inaction, making the status quo unbearable.', quote: '"If I do nothing, I will waste the next 10 years of my life."', icon: Icons.Flame, trigger: 'Cost of Inaction', example: '"In 5 years, will you look back wishing you started today?"' }
    ];

    // ============ CUSTOM SLIDE COMPONENTS ============

    // Pain Ladder Visualization - Animated 3-stage staircase
    const PainLadderVisualizationSlide = () => {
      const [activeStage, setActiveStage] = useState(0);
      useEffect(() => {
        const timer = setInterval(() => setActiveStage(s => (s + 1) % 3), 2500);
        return () => clearInterval(timer);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: 'rgba(220, 38, 38, 0.1)', color: 'var(--accent)' }}>The Framework</span>
            <h2 className="slide-title text-2xl md:text-4xl text-black">The Pain Escalation Ladder</h2>
          </motion.div>

          {/* Visual Ladder */}
          <div className="relative mb-8">
            {/* Pain Intensity Arrow */}
            <div className="absolute left-0 top-0 bottom-0 w-12 flex flex-col items-center justify-center">
              <div className="w-1 flex-1 rounded-full" style={{ background: 'linear-gradient(to top, #94a3b8, #f97316, #dc2626)' }} />
              <div className="mt-2 text-neutral-400"><Icons.ArrowUp /></div>
              <p className="text-xs text-neutral-500 mt-1 whitespace-nowrap transform -rotate-90 origin-center absolute top-1/2 -left-4">Pain Intensity</p>
            </div>

            {/* Stairs */}
            <div className="ml-16 space-y-3">
              {STAGES.slice().reverse().map((stage, i) => (
                <motion.div key={stage.num} initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: i * 0.2 }}
                  className="relative p-5 rounded-xl cursor-pointer transition-all" onClick={() => setActiveStage(2 - i)}
                  style={{
                    marginLeft: `${(2 - i) * 40}px`,
                    background: activeStage === 2 - i ? 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' : 'white',
                    border: `2px solid ${activeStage === 2 - i ? stage.color : '#e5e7eb'}`,
                    boxShadow: activeStage === 2 - i ? `0 0 30px ${stage.color}40` : 'none'
                  }}>
                  {activeStage === 2 - i && <div className="absolute top-0 left-0 right-0 h-1 rounded-t-xl" style={{ background: `linear-gradient(90deg, transparent, ${stage.color}, transparent)` }} />}

                  <div className="flex items-center gap-4">
                    <div className="w-12 h-12 rounded-xl flex items-center justify-center text-xl font-black text-white flex-shrink-0" style={{ background: stage.color }}>
                      {stage.num}
                    </div>
                    <div className="flex-1">
                      <h3 className={`font-bold text-lg ${activeStage === 2 - i ? 'text-white' : 'text-neutral-900'}`}>{stage.name}</h3>
                      <p className={`text-sm ${activeStage === 2 - i ? 'text-neutral-400' : 'text-neutral-600'}`}>{stage.desc}</p>
                    </div>
                    <div style={{ color: stage.color }}><stage.icon /></div>
                  </div>
                </motion.div>
              ))}
            </div>
          </div>

          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.6 }}
            className="p-4 rounded-xl text-center" style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' }}>
            <p className="text-white text-sm md:text-base">Your job is to take customers from <span className="font-bold" style={{ color: '#94a3b8' }}>"meh"</span> to <span className="font-bold" style={{ color: 'var(--accent)' }}>"I NEED this NOW"</span></p>
          </motion.div>
        </div>
      );
    };

    // Stage Detail Slide - Deep dive into each stage
    const StageDetailSlide = ({ stageNum }) => {
      const stage = STAGES[stageNum - 1];
      const [showExample, setShowExample] = useState(false);
      useEffect(() => { const timer = setTimeout(() => setShowExample(true), 1000); return () => clearTimeout(timer); }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="flex items-center gap-4 mb-6">
            <div className="w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-black text-white" style={{ background: stage.color, boxShadow: `0 0 30px ${stage.color}40` }}>
              {stage.num}
            </div>
            <div>
              <span className="text-xs font-semibold uppercase tracking-wider" style={{ color: stage.color }}>Stage {stage.num}</span>
              <h2 className="slide-title text-2xl md:text-3xl text-black">{stage.name}</h2>
            </div>
          </motion.div>

          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }}
            className="relative p-6 rounded-xl mb-6" style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' }}>
            <div className="absolute top-0 left-0 right-0 h-1 rounded-t-xl" style={{ background: `linear-gradient(90deg, transparent, ${stage.color}, transparent)` }} />
            <p className="text-white text-base md:text-lg mb-4">{stage.desc}</p>

            <div className="flex items-start gap-3 p-4 rounded-lg" style={{ background: `${stage.color}15`, border: `1px solid ${stage.color}40` }}>
              <Icons.Quote />
              <p className="text-sm md:text-base italic" style={{ color: stage.color }}>{stage.quote}</p>
            </div>
          </motion.div>

          <div className="grid md:grid-cols-2 gap-4">
            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.4 }}
              className="p-4 rounded-xl" style={{ background: 'white', border: '2px solid #e5e7eb' }}>
              <div className="flex items-center gap-2 mb-2">
                <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ background: `${stage.color}20`, color: stage.color }}>
                  <Icons.Target />
                </div>
                <span className="font-bold text-neutral-900">Trigger</span>
              </div>
              <p className="text-neutral-600 text-sm">{stage.trigger}</p>
            </motion.div>

            <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: showExample ? 1 : 0, x: showExample ? 0 : 20 }}
              className="p-4 rounded-xl" style={{ background: `${stage.color}10`, border: `2px solid ${stage.color}40` }}>
              <div className="flex items-center gap-2 mb-2">
                <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ background: `${stage.color}20`, color: stage.color }}>
                  <Icons.MessageCircle />
                </div>
                <span className="font-bold" style={{ color: stage.color }}>Example Copy</span>
              </div>
              <p className="text-neutral-700 text-sm italic">{stage.example}</p>
            </motion.div>
          </div>
        </div>
      );
    };

    // Funnel Mapping Slide - Which stage maps to which funnel part
    const FunnelMappingSlide = () => {
      const [activeIndex, setActiveIndex] = useState(0);
      useEffect(() => {
        const timer = setInterval(() => setActiveIndex(i => (i + 1) % 3), 2500);
        return () => clearInterval(timer);
      }, []);

      const mappings = [
        { stage: 'Latent → Realized', funnel: 'Ad Copy', icon: Icons.MessageCircle, color: '#f97316', desc: 'Use insightful questions to surface hidden pains in your ads.' },
        { stage: 'Realized → Extreme', funnel: 'Landing Page / VSL', icon: Icons.Eye, color: '#dc2626', desc: 'Agitate with "what if" scenarios and storytelling to escalate.' },
        { stage: 'Extreme Pain Reminder', funnel: 'Abandoned Cart Email', icon: Icons.Mail, color: '#7c3aed', desc: 'Remind them of the pain of NOT completing purchase.' }
      ];

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: 'rgba(220, 38, 38, 0.1)', color: 'var(--accent)' }}>Funnel Integration</span>
            <h2 className="slide-title text-2xl md:text-3xl text-black">Where to Use Each Stage</h2>
          </motion.div>

          <div className="grid md:grid-cols-3 gap-4">
            {mappings.map((m, i) => (
              <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: i * 0.15 }}
                className="relative p-5 rounded-xl cursor-pointer transition-all" onClick={() => setActiveIndex(i)}
                style={{
                  background: i === activeIndex ? 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' : 'white',
                  border: i === activeIndex ? `2px solid ${m.color}` : '2px solid #e5e7eb',
                  boxShadow: i === activeIndex ? `0 0 30px ${m.color}30` : 'none'
                }}>
                {i === activeIndex && <div className="absolute top-0 left-0 right-0 h-1 rounded-t-xl" style={{ background: `linear-gradient(90deg, transparent, ${m.color}, transparent)` }} />}

                <div className="flex items-center gap-3 mb-3">
                  <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: `${m.color}20`, color: m.color }}>
                    <m.icon />
                  </div>
                  <div className="px-2 py-1 rounded text-xs font-bold" style={{ background: `${m.color}20`, color: m.color }}>{m.stage}</div>
                </div>

                <h3 className={`font-bold text-lg mb-2 ${i === activeIndex ? 'text-white' : 'text-neutral-900'}`}>{m.funnel}</h3>
                <p className={`text-sm ${i === activeIndex ? 'text-neutral-400' : 'text-neutral-600'}`}>{m.desc}</p>
              </motion.div>
            ))}
          </div>
        </div>
      );
    };

    // Playbook Grid Slide - Actionable examples for each stage
    const PlaybookGridSlide = () => {
      const playbook = [
        { title: 'Ad Copy', stage: 'Latent → Realized', examples: ['"Is your morning coffee not hitting the same?"', '"Think your snack is healthy? It has more sugar than a donut."'], icon: Icons.MessageCircle, color: '#f97316' },
        { title: 'Landing Page', stage: 'Realized → Extreme', examples: ['"Imagine another holiday passes and you still feel invisible..."', '"Every day you wait, the gap between who you are and who you want to be grows."'], icon: Icons.Eye, color: '#dc2626' },
        { title: 'Abandoned Cart', stage: 'Extreme Reminder', examples: ['"You were so close to solving [problem] for good."', '"Do not let another week go by feeling [pain]."'], icon: Icons.ShoppingCart, color: '#7c3aed' }
      ];

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto py-8">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: 'rgba(220, 38, 38, 0.1)', color: 'var(--accent)' }}>E-commerce Playbook</span>
            <h2 className="slide-title text-2xl md:text-3xl text-black">Copy Templates by Stage</h2>
          </motion.div>

          <div className="grid md:grid-cols-3 gap-4">
            {playbook.map((p, i) => (
              <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: i * 0.15 }}
                className="relative p-5 rounded-xl" style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' }}>
                <div className="absolute top-0 left-0 right-0 h-1 rounded-t-xl" style={{ background: `linear-gradient(90deg, transparent, ${p.color}, transparent)` }} />

                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ background: `${p.color}20`, color: p.color }}>
                    <p.icon />
                  </div>
                  <div>
                    <h3 className="text-white font-bold">{p.title}</h3>
                    <span className="text-xs" style={{ color: p.color }}>{p.stage}</span>
                  </div>
                </div>

                <div className="space-y-2">
                  {p.examples.map((ex, j) => (
                    <div key={j} className="p-3 rounded-lg text-sm italic" style={{ background: 'rgba(255, 255, 255, 0.05)', color: '#d4d4d4' }}>
                      {ex}
                    </div>
                  ))}
                </div>
              </motion.div>
            ))}
          </div>
        </div>
      );
    };

    // Before/After Example Slide - Fitness product escalation
    const BeforeAfterExampleSlide = () => {
      const [showAfter, setShowAfter] = useState(false);
      useEffect(() => { const timer = setTimeout(() => setShowAfter(true), 1200); return () => clearTimeout(timer); }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: 'rgba(220, 38, 38, 0.1)', color: 'var(--accent)' }}>Real Example</span>
            <h2 className="slide-title text-2xl md:text-3xl text-black">Fitness Product Copy</h2>
          </motion.div>

          <div className="grid md:grid-cols-2 gap-6 mb-6">
            {/* Before - Weak */}
            <motion.div initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }}
              className="relative p-5 rounded-xl" style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' }}>
              <div className="absolute top-0 left-0 right-0 h-1 rounded-t-xl" style={{ background: 'linear-gradient(90deg, transparent, #94a3b8, transparent)' }} />
              <div className="flex items-center gap-2 mb-4">
                <div className="w-8 h-8 rounded-lg bg-neutral-700 flex items-center justify-center text-white"><Icons.X /></div>
                <span className="text-neutral-400 font-bold">No Escalation</span>
                <span className="ml-auto px-2 py-1 rounded text-xs font-bold bg-neutral-700 text-neutral-300">WEAK</span>
              </div>
              <p className="text-neutral-400 text-sm italic leading-relaxed">"Our workout program helps you get in shape. Features include 30+ exercises, nutrition guide, and progress tracking."</p>
            </motion.div>

            {/* After - Powerful */}
            <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: showAfter ? 1 : 0, x: showAfter ? 0 : 30 }}
              className="relative p-5 rounded-xl" style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', boxShadow: '0 0 30px rgba(220, 38, 38, 0.3)' }}>
              <div className="absolute top-0 left-0 right-0 h-1 rounded-t-xl" style={{ background: 'linear-gradient(90deg, transparent, var(--accent), transparent)' }} />
              <div className="absolute -top-3 -right-3 px-3 py-1 rounded-full text-xs font-bold" style={{ background: 'var(--accent)', color: 'white' }}>+340% CVR</div>
              <div className="flex items-center gap-2 mb-4">
                <div className="w-8 h-8 rounded-lg flex items-center justify-center text-white" style={{ background: 'var(--accent)' }}><Icons.Check /></div>
                <span className="text-white font-bold">Full Escalation</span>
                <span className="ml-auto px-2 py-1 rounded text-xs font-bold" style={{ background: 'rgba(220, 38, 38, 0.2)', color: 'var(--accent)' }}>POWERFUL</span>
              </div>
              <div className="space-y-2">
                <p className="text-sm leading-relaxed"><span className="px-1 rounded text-xs font-semibold" style={{ background: '#94a3b815', color: '#94a3b8' }}>L</span> <span className="text-neutral-300">"Remember when you used to feel confident taking your shirt off?"</span></p>
                <p className="text-sm leading-relaxed"><span className="px-1 rounded text-xs font-semibold" style={{ background: '#f9731615', color: '#f97316' }}>R</span> <span className="text-neutral-300">"Every summer that passes, the gap between who you are and who you want to be grows wider."</span></p>
                <p className="text-sm leading-relaxed"><span className="px-1 rounded text-xs font-semibold" style={{ background: 'rgba(220, 38, 38, 0.15)', color: 'var(--accent)' }}>E</span> <span className="text-neutral-300">"In 5 years, will you look back wishing you had started today?"</span></p>
              </div>
            </motion.div>
          </div>

          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: showAfter ? 1 : 0, y: showAfter ? 0 : 20 }}
            className="p-4 rounded-xl text-center" style={{ background: 'rgba(220, 38, 38, 0.1)', border: '1px solid rgba(220, 38, 38, 0.3)' }}>
            <p className="text-neutral-700 text-sm md:text-base">The second version walks through all <span className="font-bold" style={{ color: '#94a3b8' }}>L</span>atent → <span className="font-bold" style={{ color: '#f97316' }}>R</span>ealized → <span className="font-bold" style={{ color: 'var(--accent)' }}>E</span>xtreme stages, making pain progressively more urgent.</p>
          </motion.div>
        </div>
      );
    };

    // Impact Stats Slide
    const ImpactStatsSlide = () => {
      const stats = [
        { value: '7', suffix: 'x', label: 'More Likely to Act', sub: 'When pain is clearly articulated', color: 'var(--accent)' },
        { value: '83', suffix: '%', label: 'Decisions', sub: 'Made to avoid pain vs gain pleasure', color: '#f97316' },
        { value: '3', suffix: 'x', label: 'Conversion Increase', sub: 'With proper pain escalation', color: '#10b981' }
      ];

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">The Psychology of Action</motion.h2>

          <div className="grid md:grid-cols-3 gap-4">
            {stats.map((stat, i) => (
              <motion.div key={stat.label} initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: i * 0.15 }}
                className="relative p-6 rounded-xl text-center" style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', boxShadow: `0 0 30px ${stat.color}20` }}>
                <div className="absolute top-0 left-0 right-0 h-1 rounded-t-xl" style={{ background: `linear-gradient(90deg, transparent, ${stat.color}, transparent)` }} />
                <div className="text-5xl md:text-6xl font-black mb-2" style={{ color: stat.color }}>
                  <AnimatedCounter target={stat.value} suffix={stat.suffix} />
                </div>
                <div className="text-white font-semibold mb-1">{stat.label}</div>
                <div className="text-neutral-500 text-sm">{stat.sub}</div>
              </motion.div>
            ))}
          </div>
        </div>
      );
    };

    // Elite Insight Slide
    const EliteInsightSlide = () => (
      <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto py-8">
        <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }}
          className="relative p-8 rounded-2xl" style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', boxShadow: '0 0 60px rgba(220, 38, 38, 0.2)' }}>
          <div className="absolute top-0 left-0 right-0 h-1 rounded-t-2xl" style={{ background: 'linear-gradient(90deg, transparent, var(--accent), transparent)' }} />

          <div className="flex items-center gap-3 mb-6">
            <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ background: 'rgba(220, 38, 38, 0.2)', color: 'var(--accent)' }}>
              <Icons.Lightbulb />
            </div>
            <div>
              <p className="text-neutral-500 text-xs uppercase tracking-wider">Elite Insight</p>
              <h3 className="text-white font-bold text-lg">The Pain Paradox</h3>
            </div>
          </div>

          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.3 }}
            className="text-xl md:text-2xl text-white leading-relaxed mb-6">
            You do not create pain. You <span className="font-bold" style={{ color: 'var(--accent)' }}>surface existing pain</span> customers have been ignoring.
          </motion.p>

          <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.5 }}
            className="p-4 rounded-xl" style={{ background: 'rgba(220, 38, 38, 0.1)', border: '1px solid rgba(220, 38, 38, 0.3)' }}>
            <p className="text-neutral-300 text-sm md:text-base">Take them from <span className="font-bold" style={{ color: '#94a3b8' }}>Latent</span> (numb) to <span className="font-bold" style={{ color: '#f97316' }}>Realized</span> (aware) to <span className="font-bold" style={{ color: 'var(--accent)' }}>Extreme</span> (urgent). At Stage 3, NOT buying becomes more painful than buying. The sale becomes inevitable.</p>
          </motion.div>
        </motion.div>
      </div>
    );

    // ============ STANDARD SLIDE COMPONENTS ============
    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      useEffect(() => { onShowGif(welcomeData.gif, '65%', gifSide); return () => onHideGif(); }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-2 md:mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg lg:text-xl mb-2 md:mb-3 max-w-lg leading-relaxed" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center justify-center gap-1.5 text-neutral-400 text-[10px] md:text-xs mb-2 md:mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-xl md:rounded-2xl p-3 md:p-5 mb-3 md:mb-4 max-w-sm w-full mx-auto">
              <p className="text-neutral-500 text-[9px] md:text-[11px] uppercase tracking-wider mb-2 md:mb-3">In this lesson</p>
              <ul className="space-y-1.5 md:space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>{i + 1}</span>
                    <span className="text-neutral-300 text-[11px] md:text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-6 md:px-7 py-2.5 md:py-3 rounded-xl text-white font-semibold text-sm md:text-base" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8 md:py-10">
        <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="mb-4 md:mb-6">
          <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3 md:mb-4" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>The Hook</span>
          <h2 className="slide-title text-2xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
        </motion.div>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-base md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
      </div>
    );

    const QuizSlide = ({ data, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const celebrationGif = useMemo(() => getRandomCelebrationGif(), []);
      const empathyGif = useMemo(() => getRandomEmpathyGif(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      const handleSelect = (index) => { if (showFeedback) return; setSelected(index); setShowFeedback(true); };
      const isCorrect = selected === data.correctIndex;

      useEffect(() => { if (showFeedback) { if (isCorrect) { onShowGif(celebrationGif, '60%', gifSide); } else { onShowGif(empathyGif, '60%', gifSide); } } }, [showFeedback, isCorrect, celebrationGif, empathyGif, gifSide, onShowGif]);
      useEffect(() => { return () => onHideGif(); }, [onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col justify-center px-8 md:px-12 max-w-2xl mx-auto slide-scroll overflow-y-auto py-10 relative z-30">
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
              <p className="text-xs uppercase tracking-wider text-neutral-400 mb-3">Quick Check</p>
              <h2 className="slide-title text-xl md:text-2xl text-black leading-tight">{data.question}</h2>
            </motion.div>
            <div className="space-y-3 mb-6">
              {data.options.map((option, i) => (
                <motion.button key={i} initial={{ opacity: 0, x: -15 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.08 + i * 0.06 }} onClick={() => handleSelect(i)} disabled={showFeedback} className={`w-full p-4 rounded-xl text-left transition-all border-2 ${showFeedback ? i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-400 bg-red-50' : 'border-neutral-200 bg-white opacity-40' : 'border-neutral-200 bg-white hover:border-neutral-300'}`}>
                  <div className="flex items-center gap-3">
                    <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold transition-all ${showFeedback && i === data.correctIndex ? 'bg-green-500 text-white' : showFeedback && i === selected && !isCorrect ? 'bg-red-400 text-white' : 'bg-neutral-100 text-neutral-500'}`}>
                      {showFeedback && i === data.correctIndex ? <Icons.Check /> : showFeedback && i === selected && !isCorrect ? <Icons.X /> : String.fromCharCode(65 + i)}
                    </span>
                    <span className="text-neutral-700 text-sm md:text-base">{option}</span>
                  </div>
                </motion.button>
              ))}
            </div>
            <AnimatePresence>
              {showFeedback && (
                <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className={`p-5 rounded-xl ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                  <p className={`text-sm leading-relaxed ${isCorrect ? 'text-green-800' : 'text-amber-800'}`}>{isCorrect ? data.feedback.correct : data.feedback.incorrect}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      );
    };

    const CompletionSlide = ({ data }) => (
      <div className="h-full flex flex-col items-center justify-center text-center px-8 slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'spring', duration: 0.5 }} className="w-16 h-16 rounded-xl flex items-center justify-center mb-4 text-white" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))`, boxShadow: `0 6px 24px rgba(var(--accent-rgb), 0.35)` }}><Icons.Check /></motion.div>
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="slide-title text-2xl md:text-3xl text-black mb-3">Lesson Complete</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }} className="text-neutral-500 text-sm mb-5 max-w-md leading-relaxed">You now understand the Pain Escalation Ladder. Take customers from latent to realized to extreme pain to make the sale inevitable.</motion.p>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }} className="bg-neutral-900 rounded-xl p-5 max-w-md w-full mb-4">
          <p className="text-neutral-500 text-xs uppercase tracking-wider mb-2">Up Next</p>
          <h3 className="text-white font-bold text-lg mb-1">{LESSON_CONFIG.nextLesson.title}</h3>
          <p className="text-neutral-400 text-xs">{LESSON_CONFIG.nextLesson.teaser}</p>
        </motion.div>
      </div>
    );

    // ============ MAIN APP ============
    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(getInitialSlide());
      const [direction, setDirection] = useState(1);
      const userName = useMemo(() => getUserName(), []);
      const currentSlideRef = React.useRef(0);
      const [gifConfig, setGifConfig] = useState(null);
      const [isAnimating, setIsAnimating] = useState(false);

      const showGif = useCallback((url, height, side) => setGifConfig({ url, height, side }), []);
      const hideGif = useCallback(() => setGifConfig(null), []);

      React.useEffect(() => { currentSlideRef.current = currentSlide; }, [currentSlide]);

      useEffect(() => {
        window.parent.postMessage({ type: 'LESSON_SLIDE_UPDATE',
          totalSlides: slides.length, slideIndex: currentSlide, slideType: slides[currentSlide]?.type, lessonSlug: LESSON_CONFIG.id }, '*');
      }, [currentSlide]);

      const goToSlide = useCallback((newSlide) => {
        if (isAnimating || newSlide < 0 || newSlide >= slides.length) return;
        setIsAnimating(true);
        setDirection(newSlide > currentSlideRef.current ? 1 : -1);
        setCurrentSlide(newSlide);
      }, [isAnimating]);

      const nextSlide = useCallback(() => { if (currentSlideRef.current + 1 < slides.length) goToSlide(currentSlideRef.current + 1); }, [goToSlide]);
      const prevSlide = useCallback(() => { if (currentSlideRef.current - 1 >= 0) goToSlide(currentSlideRef.current - 1); }, [goToSlide]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [nextSlide, prevSlide]);

      const slideVariants = {
        enter: (dir) => ({ x: dir > 0 ? '100%' : '-100%', opacity: 0 }),
        center: { x: 0, opacity: 1 },
        exit: (dir) => ({ x: dir > 0 ? '-100%' : '100%', opacity: 0 })
      };

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={nextSlide} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'pain-ladder-visual': return <PainLadderVisualizationSlide />;
          case 'stage-detail': return <StageDetailSlide stageNum={slide.stage} />;
          case 'funnel-mapping': return <FunnelMappingSlide />;
          case 'playbook-grid': return <PlaybookGridSlide />;
          case 'before-after-example': return <BeforeAfterExampleSlide />;
          case 'quiz': return <QuizSlide data={slide} onShowGif={showGif} onHideGif={hideGif} />;
          case 'impact-stats': return <ImpactStatsSlide />;
          case 'elite-insight': return <EliteInsightSlide />;
          case 'completion': return <CompletionSlide data={slide} />;
          default: return null;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction} onExitComplete={() => setIsAnimating(false)}>
              <motion.div key={currentSlide} custom={direction} variants={slideVariants} initial="enter" animate="center" exit="exit" transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
                <AdminSlideReportButton slideIndex={currentSlide} slideType={slides[currentSlide].type} />
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => goToSlide(i)} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gifConfig && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }} className={`absolute ${gifConfig.side === 'left' ? 'left-4 md:left-8' : 'right-4 md:right-8'} bottom-0 pointer-events-none`} style={{ zIndex: 15, height: gifConfig.height }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom" style={{ background: 'transparent', border: 'none', boxShadow: 'none' }}>
                  <source src={gifConfig.url} type="video/mp4" />
                </video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    ReactDOM.render(<LessonApp />, document.getElementById('root'));
  </script>
</body>
</html>
