<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clean Signals: CAPI + Pixel Dual Tracking | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #3b82f6; --accent-dark: #2563eb; --accent-light: #93c5fd; --accent-rgb: 59, 130, 246; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => { const params = new URLSearchParams(window.location.search); return params.get('userName') || 'Builder'; };

    const LESSON_CONFIG = {
      id: 'meta-clean-signals',
      title: 'Clean Signals: CAPI + Pixel Dual Tracking',
      description: 'The AI is only as smart as your data. CAPI + Pixel with event_id deduplication, real value tracking, and value bidding power Andromeda.',
      accentColor: '#3b82f6',
      duration: '6 min',
      nextLesson: { id: 'dashboard', title: 'Back to Dashboard', teaser: 'Apply what you learned to your campaigns.' }
    };

    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];

    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    const slides = [
      { type: 'welcome', learningGoals: ['Why CAPI + Pixel together beat either alone', 'How event_id deduplication prevents double-counting', 'Value Bidding vs Volume Bidding explained'] },
      { type: 'hook', headline: 'You have the perfect campaign structure. 12 distinct creatives. Everything ready. But your data is garbage. Meta learns from noise. Andromeda optimizes for the wrong people. Your ROAS tanks.', subtext: 'The system is only as smart as your signals. Clean data = smart AI. Dirty data = expensive mistakes. Here\'s the data hygiene checklist.' , brandImage: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/framer-1.svg', brandName: 'Framer'},
      { type: 'content', title: 'Principle #3: The System is Only as Smart as Your Signals', body: 'Andromeda is powerful.\nBut it\'s not magic.\n\nIt learns from YOUR data:\n• Who clicked\n• Who converted\n• What they bought\n• How much they spent\n\nGarbage in = Garbage out.\n\nIf your tracking is broken, Andromeda optimizes for the wrong people.\nYou get clicks from people who never buy.\nYou get conversions worth $10 when you need $100.\n\nClean signals = Smart AI.' },
      { type: 'checklist', title: 'Data Hygiene Checklist', items: [
        { id: 1, item: 'CAPI + Pixel (both active)', status: 'Must have', description: 'Dual tracking catches what browser-only misses' },
        { id: 2, item: 'event_id deduplication', status: 'Must have', description: 'Prevents counting same event twice' },
        { id: 3, item: 'Send Real Value', status: 'Must have', description: 'Track actual revenue, not generic $1' },
        { id: 4, item: 'Value Bidding enabled', status: 'Recommended', description: 'Optimize for high-value customers' }
      ]},
      { type: 'content', title: 'CAPI + Pixel: Why Both Matter', body: 'Pixel = Browser-side tracking\n• JavaScript in browser\n• Blocked by ad blockers (30%+ users)\n• Affected by iOS privacy (50%+ iOS users)\n• Fast but incomplete\n\nCAPI = Server-side tracking\n• Sends data from YOUR server to Meta\n• Can\'t be blocked\n• Captures conversions Pixel misses\n• Slower but complete\n\nTogether = Best of both worlds.\nPixel catches instant events.\nCAPI fills the gaps.\n\nAndromeda sees the full picture.' },
      { type: 'signal-flow', title: 'How CAPI + Pixel Work Together', steps: [
        { num: 1, label: 'User clicks ad', detail: 'Pixel fires: "Click event sent"' },
        { num: 2, label: 'User converts', detail: 'Pixel fires: "Purchase $50" + CAPI sends: "Purchase $50"' },
        { num: 3, label: 'Meta receives both', detail: 'Same event_id = deduplication (counts once)' },
        { num: 4, label: 'Andromeda learns', detail: 'Clean signal: "This ad → $50 buyer"' }
      ]},
      { type: 'content', title: 'event_id: Preventing Double-Counting', body: 'Without event_id:\nPixel sends: "Purchase $50"\nCAPI sends: "Purchase $50"\nMeta counts: $100 (WRONG)\n\nWith event_id:\nPixel sends: "Purchase $50, event_id: abc123"\nCAPI sends: "Purchase $50, event_id: abc123"\nMeta deduplicates: $50 (CORRECT)\n\nevent_id is a unique identifier for each conversion.\nSame event_id from Pixel and CAPI = Meta knows it\'s the same event.\n\nCritical for accurate data.' },
      { type: 'value-bidding', title: 'Value Bidding vs Volume Bidding', data: {
        volume: { label: 'Volume Bidding', goal: 'Get as many conversions as possible', result: 'Meta finds cheap converters. Often low value.', example: '100 customers x $10 each = $1,000 revenue' },
        value: { label: 'Value Bidding', goal: 'Get highest total revenue', result: 'Meta finds high-value buyers. Fewer but better.', example: '20 customers x $100 each = $2,000 revenue' }
      }},
      { type: 'content', title: 'Send Real Value, Not Generic $1', body: 'Bad data:\nAll purchases = $1 value\nMeta can\'t tell difference between $5 buyer and $500 buyer\nOptimizes for volume, not value\n\nGood data:\nPurchase 1 = $47.50\nPurchase 2 = $230.00\nPurchase 3 = $15.99\n\nMeta sees: "$230 buyers look like THIS. Find more."\nAndromeda optimizes for high-value customers.\n\nYour tracking must send ACTUAL purchase value.\nNot placeholder. Not average. ACTUAL.' },
      { type: 'quote', data: {
        quote: 'Perfect campaign structure with dirty data loses to average structure with clean data. Every time.',
        context: 'Why data hygiene comes before creative optimization'
      }},
      { type: 'implementation', title: 'How to Implement Clean Signals', steps: [
        { step: '1. Install Meta Pixel', detail: 'Add to all pages, fire events (ViewContent, AddToCart, Purchase)' },
        { step: '2. Set up CAPI', detail: 'Server-side integration via Shopify app or custom code' },
        { step: '3. Add event_id', detail: 'Same unique ID sent by both Pixel and CAPI for each event' },
        { step: '4. Send real value', detail: 'Pass actual purchase amount, not generic $1' },
        { step: '5. Enable Value Bidding', detail: 'In campaign settings, choose "Maximize value of conversions"' }
      ]},
      { type: 'quiz', question: 'Why do you need BOTH CAPI and Pixel instead of just one?', options: ['It looks more professional to have both', 'Pixel catches instant browser events, CAPI fills gaps from ad blockers and iOS privacy', 'Meta requires both or campaigns won\'t run', 'CAPI is for Android, Pixel is for iOS'], correctIndex: 1, feedback: { correct: 'Exactly! Pixel = fast browser-side tracking (but blocked by 30%+ users). CAPI = server-side backup that can\'t be blocked. Together they give Andromeda the complete picture. Pixel alone misses 30-50% of conversions. CAPI alone is slow. Together = clean, complete data that powers smart optimization.', incorrect: 'Not quite. The reason is DATA COMPLETENESS. Pixel alone gets blocked by ad blockers (30%+ users) and iOS privacy (50%+ iOS users). CAPI alone is slow. Together: Pixel catches instant events, CAPI fills the gaps. Andromeda sees 100% of conversions, not 50%. Clean signals = smart AI.' }},
      { type: 'completion', sources: [{ name: 'Meta Conversions API Documentation', url: 'https://developers.facebook.com/docs/marketing-api/conversions-api' }, { name: 'Meta Pixel + CAPI Best Practices', url: 'https://www.facebook.com/business/help/server-side-api' }] }
    ];

    const Icons = {
      Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      Link: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
      Database: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
      AlertCircle: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
    };

    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      useEffect(() => { onShowGif(welcomeData.gif, '65%', gifSide); return () => onHideGif(); }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-2 md:mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg lg:text-xl mb-2 md:mb-3 max-w-lg leading-relaxed" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center justify-center gap-1.5 text-neutral-400 text-[10px] md:text-xs mb-2 md:mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-xl md:rounded-2xl p-3 md:p-5 mb-3 md:mb-4 max-w-sm w-full mx-auto">
              <p className="text-neutral-500 text-[9px] md:text-[11px] uppercase tracking-wider mb-2 md:mb-3">In this lesson</p>
              <ul className="space-y-1.5 md:space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>{i + 1}</span>
                    <span className="text-neutral-300 text-[11px] md:text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-6 md:px-7 py-2.5 md:py-3 rounded-xl text-white font-semibold text-sm md:text-base" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-8 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-10 relative z-10">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-4" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>The Hook</span>
            <h2 className="slide-title text-3xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-lg md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
        </div>
        {data.brandImage && (
          <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3, duration: 0.5 }}
            className="absolute bottom-0 right-0 z-0 pointer-events-none" style={{ height: '30%', maxHeight: '200px', marginRight: '3%', marginBottom: '5%' }}>
            <img src={data.brandImage} alt={data.brandName || ''} className="h-full w-auto object-contain" style={{ opacity: 0.2 }} />
          </motion.div>
        )}
      </div>
    );

    const ContentSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-8 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-10">
        <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl lg:text-4xl text-black mb-6">{data.title}</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-base md:text-lg text-neutral-600 leading-relaxed whitespace-pre-line">{data.body}</motion.p>
      </div>
    );

    const ChecklistSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">{data.title}</motion.h2>
        <div className="space-y-3">
          {data.items.map((item, i) => (
            <motion.div key={i} initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 + i * 0.1 }} className="bg-white border-2 border-blue-200 rounded-xl p-5">
              <div className="flex items-start gap-4">
                <div className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 bg-blue-500 text-white font-bold">{item.id}</div>
                <div className="flex-1">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="font-bold text-lg text-black">{item.item}</h3>
                    <span className={`text-xs px-2 py-1 rounded-full ${item.status === 'Must have' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{item.status}</span>
                  </div>
                  <p className="text-sm text-neutral-600">{item.description}</p>
                </div>
              </div>
            </motion.div>
          ))}
        </div>
      </div>
    );

    const SignalFlowSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">{data.title}</motion.h2>
        <div className="space-y-3">
          {data.steps.map((step, i) => (
            <motion.div key={i} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 + i * 0.1 }} className="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-5">
              <div className="flex items-center gap-4 mb-2">
                <div className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 text-white font-bold text-lg" style={{ background: 'var(--accent)' }}>{step.num}</div>
                <h3 className="font-bold text-lg text-black">{step.label}</h3>
              </div>
              <p className="text-sm text-neutral-600 ml-14">{step.detail}</p>
            </motion.div>
          ))}
        </div>
      </div>
    );

    const ValueBiddingSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">{data.title}</motion.h2>
        <div className="grid md:grid-cols-2 gap-6">
          <motion.div initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 }} className="bg-orange-50 border-2 border-orange-200 rounded-xl p-6">
            <div className="text-center mb-4">
              <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-orange-500 text-white">{data.data.volume.label}</span>
            </div>
            <div className="space-y-3">
              <div>
                <p className="text-xs text-neutral-500 mb-1">Goal:</p>
                <p className="text-sm font-semibold text-neutral-700">{data.data.volume.goal}</p>
              </div>
              <div>
                <p className="text-xs text-neutral-500 mb-1">Result:</p>
                <p className="text-sm text-neutral-600">{data.data.volume.result}</p>
              </div>
              <div className="bg-orange-100 rounded-lg p-3">
                <p className="text-xs text-orange-700">{data.data.volume.example}</p>
              </div>
            </div>
          </motion.div>
          <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.2 }} className="bg-green-50 border-2 border-green-200 rounded-xl p-6">
            <div className="text-center mb-4">
              <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-green-500 text-white">{data.data.value.label}</span>
            </div>
            <div className="space-y-3">
              <div>
                <p className="text-xs text-neutral-500 mb-1">Goal:</p>
                <p className="text-sm font-semibold text-neutral-700">{data.data.value.goal}</p>
              </div>
              <div>
                <p className="text-xs text-neutral-500 mb-1">Result:</p>
                <p className="text-sm text-neutral-600">{data.data.value.result}</p>
              </div>
              <div className="bg-green-100 rounded-lg p-3">
                <p className="text-xs text-green-700 font-semibold">{data.data.value.example}</p>
              </div>
            </div>
          </motion.div>
        </div>
      </div>
    );

    const ImplementationSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">{data.title}</motion.h2>
        <div className="space-y-3 max-w-2xl mx-auto">
          {data.steps.map((item, i) => (
            <motion.div key={i} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 + i * 0.08 }} className="bg-white border-2 border-blue-200 rounded-xl p-4">
              <div className="font-bold text-base text-black mb-2">{item.step}</div>
              <div className="text-sm text-neutral-600">{item.detail}</div>
            </motion.div>
          ))}
        </div>
      </div>
    );

    const QuoteSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-8 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-10">
        <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} transition={{ duration: 0.5 }} className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-2xl p-8 md:p-12">
          <div className="text-6xl mb-6 text-center" style={{ color: 'var(--accent)' }}>"</div>
          <p className="text-xl md:text-2xl font-semibold text-black text-center mb-6 leading-relaxed">{data.data.quote}</p>
          <p className="text-sm text-neutral-500 text-center italic">{data.data.context}</p>
        </motion.div>
      </div>
    );

    const QuizSlide = ({ data, onAnswer, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [answered, setAnswered] = useState(false);
      const handleSelect = (index) => {
        if (answered) return;
        setSelected(index);
        setAnswered(true);
        const isCorrect = index === data.correctIndex;
        const gif = isCorrect ? getRandomCelebrationGif() : getRandomEmpathyGif();
        onShowGif(gif, '50%', 'center');
        setTimeout(() => onHideGif(), 3000);
        onAnswer(isCorrect);
      };

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8">
          <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>Knowledge Check</span>
            <h2 className="slide-title text-xl md:text-2xl text-black">{data.question}</h2>
          </motion.div>
          <div className="space-y-3 mb-6">
            {data.options.map((option, i) => (
              <motion.button key={i} initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 + i * 0.05 }} onClick={() => handleSelect(i)} disabled={answered} className={`w-full text-left p-4 rounded-xl border-2 transition-all ${answered ? (i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-500 bg-red-50' : 'border-neutral-200 bg-neutral-50') : 'border-neutral-200 bg-white hover:border-blue-300 hover:bg-blue-50'}`}>
                <div className="flex items-center gap-3">
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 ${answered ? (i === data.correctIndex ? 'bg-green-500' : i === selected ? 'bg-red-500' : 'bg-neutral-300') : 'bg-neutral-200'}`}>
                    {answered && i === data.correctIndex && <Icons.Check className="text-white" />}
                    {answered && i === selected && i !== data.correctIndex && <Icons.X className="text-white" />}
                  </div>
                  <span className="text-sm md:text-base text-neutral-700">{option}</span>
                </div>
              </motion.button>
            ))}
          </div>
          <AnimatePresence>
            {answered && (
              <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`rounded-xl p-4 ${selected === data.correctIndex ? 'bg-green-50 border-2 border-green-200' : 'bg-blue-50 border-2 border-blue-200'}`}>
                <p className="text-sm text-neutral-700 leading-relaxed">{selected === data.correctIndex ? data.feedback.correct : data.feedback.incorrect}</p>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    const CompletionSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center items-center text-center px-6 py-10">
        <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} transition={{ type: 'spring', duration: 0.6 }}>
          <div className="w-20 h-20 rounded-full flex items-center justify-center mb-4 mx-auto" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>
            <Icons.Check className="text-white" />
          </div>
        </motion.div>
        <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="slide-title text-3xl md:text-4xl text-black mb-3">Series Complete!</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3 }} className="text-neutral-600 text-base md:text-lg mb-6 max-w-md">You now understand the complete Andromeda playbook: Retrieval, Consolidation, Diversity, Angles, and Clean Signals.</motion.p>
        {data.sources && data.sources.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4 }} className="bg-neutral-50 rounded-xl p-4 max-w-md w-full mb-6">
            <p className="text-xs uppercase tracking-wider text-neutral-400 mb-2">Sources</p>
            {data.sources.map((source, i) => (
              <a key={i} href={source.url} target="_blank" rel="noopener noreferrer" className="text-sm hover:underline flex items-center gap-1 mb-1" style={{ color: 'var(--accent)' }}><Icons.Link />{source.name}</a>
            ))}
          </motion.div>
        )}
        <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.5 }} onClick={() => window.location.href = '/dashboard'} className="px-6 py-3 rounded-xl text-white font-semibold" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Back to Dashboard</motion.button>
      </div>
    );

    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(0);
      const [direction, setDirection] = useState(0);
      const [userName] = useState(getUserName());
      const [gif, setGif] = useState({ src: null, opacity: 0, side: 'center' });

      const showGif = useCallback((src, opacity, side) => { setGif({ src, opacity, side }); }, []);
      const hideGif = useCallback(() => { setGif(prev => ({ ...prev, opacity: 0 })); }, []);

      const nextSlide = useCallback(() => {
        if (currentSlide < slides.length - 1) {
          setDirection(1);
          setCurrentSlide(prev => prev + 1);
        }
      }, [currentSlide]);

      const prevSlide = useCallback(() => {
        if (currentSlide > 0) {
          setDirection(-1);
          setCurrentSlide(prev => prev - 1);
        }
      }, [currentSlide]);

      const startLesson = useCallback(() => {
        setDirection(1);
        setCurrentSlide(1);
      }, []);

      const handleAnswer = useCallback((correct) => {
        setTimeout(nextSlide, 3000);
      }, [nextSlide]);

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={startLesson} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'content': return <ContentSlide data={slide} />;
          case 'checklist': return <ChecklistSlide data={slide} />;
          case 'signal-flow': return <SignalFlowSlide data={slide} />;
          case 'value-bidding': return <ValueBiddingSlide data={slide} />;
          case 'implementation': return <ImplementationSlide data={slide} />;
          case 'quote': return <QuoteSlide data={slide} />;
          case 'quiz': return <QuizSlide data={slide} onAnswer={handleAnswer} onShowGif={showGif} onHideGif={hideGif} />;
          case 'completion': return <CompletionSlide data={slide} />;
          default: return <ContentSlide data={slide} />;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction}>
              <motion.div key={currentSlide} custom={direction} initial={{ opacity: 0, x: direction > 0 ? '100%' : '-100%' }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: direction > 0 ? '-100%' : '100%' }} transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => { setDirection(i > currentSlide ? 1 : -1); setCurrentSlide(i); }} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gif.src && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: gif.opacity === 0 ? 0 : 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }} className={`absolute ${gif.side === 'left' ? 'left-4 md:left-8' : gif.side === 'right' ? 'right-4 md:right-8' : 'left-1/2 -translate-x-1/2'} bottom-0 pointer-events-none`} style={{ zIndex: 15, height: '65%' }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom" style={{ background: 'transparent', border: 'none', boxShadow: 'none' }}>
                  <source src={gif.src} type="video/mp4" />
                </video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<LessonApp />);
  </script>
</body>
</html>