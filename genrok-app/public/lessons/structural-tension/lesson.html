<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Structural Tension | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #f43f5e; --accent-dark: #e11d48; --accent-light: #fb7185; --accent-rgb: 244, 63, 94; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => { const params = new URLSearchParams(window.location.search); return params.get('userName') || 'Builder'; };
    const getInitialSlide = () => { const params = new URLSearchParams(window.location.search); const slide = params.get('slide'); return slide ? parseInt(slide, 10) : 0; };

    const LESSON_CONFIG = {
      id: 'structural-tension',
      title: 'Structural Tension',
      description: 'The invisible force that keeps readers glued to every word. Master the art of creating anticipation.',
      accentColor: '#f43f5e',
      duration: '9 min',
      nextLesson: { id: 'three-growth-levers', title: 'The Three Growth Levers', teaser: 'The only three ways to grow any business. Master the math behind revenue.' }
    };

    // ============ ADMIN REPORTER SYSTEM ============
    let __isAdmin = false;
    window.addEventListener('message', function(e) {
      if (e.data?.type === 'ADMIN_STATUS') { __isAdmin = e.data.isAdmin; }
    });
    if (window.parent !== window) { window.parent.postMessage({ type: 'CHECK_ADMIN_STATUS' }, '*'); }

    const AdminSlideReportButton = ({ slideIndex, slideType }) => {
      const handleReport = (e) => {
        e.stopPropagation();
        e.preventDefault();
        if (window.parent !== window) {
          window.parent.postMessage({ type: 'ADMIN_REPORT_REQUEST', slideIndex, slideType, lessonSlug: LESSON_CONFIG.id, elementId: slideType + '-' + slideIndex }, '*');
        }
      };
      return (
        <button onClick={handleReport} title={`Report issue on Slide ${slideIndex + 1} (${slideType})`}
          style={{ position: 'absolute', top: '12px', right: '12px', width: '32px', height: '32px', borderRadius: '8px', backgroundColor: 'rgba(239, 68, 68, 0.9)', color: 'white', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, opacity: 0.6, transition: 'opacity 0.2s, transform 0.2s', boxShadow: '0 2px 8px rgba(0,0,0,0.15)' }}
          onMouseEnter={(e) => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.transform = 'scale(1.1)'; }}
          onMouseLeave={(e) => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.transform = 'scale(1)'; }}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/>
            <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/>
            <path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/>
            <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/>
          </svg>
        </button>
      );
    };
    // ============ END ADMIN REPORTER SYSTEM ============

    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];

    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    const slides = [
      { type: 'welcome', learningGoals: ['What structural tension is and why it hooks readers', 'The 4 core tension techniques that captivate any audience', 'How to open loops without feeling like clickbait'] },
      { type: 'hook', headline: 'Why do you keep reading articles you know will disappoint you?', subtext: 'Because your brain physically cannot handle an unfinished story. Structural tension is the invisible psychological force that keeps readers glued to every word—even when they want to leave. Master this, and people read your copy like a thriller novel they cannot put down.' },
      { type: 'rubber-band', title: 'What Is Structural Tension?', concept: 'Like a rubber band stretched between two fingers—that pull you feel is structural tension.' },
      { type: 'tension-stats', title: 'The Tension Arc', stats: [
        { value: '89', suffix: '%', label: 'Higher Engagement', subtext: 'When tension is used correctly' },
        { value: '3', suffix: 'x', label: 'Read-Through Rate', subtext: 'Vs. copy without tension' },
        { value: '100', suffix: '%', label: 'Great Stories', subtext: 'Use structural tension' }
      ]},
      { type: 'four-techniques', title: 'The 4 Tension Techniques' },
      { type: 'technique-detail', techniqueIndex: 0 },
      { type: 'technique-detail', techniqueIndex: 1 },
      { type: 'technique-detail', techniqueIndex: 2 },
      { type: 'technique-detail', techniqueIndex: 3 },
      { type: 'zeigarnik', title: 'The Psychology Behind It', effect: 'Zeigarnik Effect' },
      { type: 'tension-example', scenario: 'Email Subject Line', before: { label: 'No Tension', text: 'New guide available: 10 marketing tips for your business' }, after: { label: 'Strong Tension', text: 'The mistake that is costing you 47% of your subscribers (and the 3-minute fix)' }, insight: 'The second creates an open loop. What mistake? What is the fix? The brain demands answers.' },
      { type: 'mistakes-grid', title: 'Common Mistakes to Avoid' },
      { type: 'tension-example', scenario: 'Landing Page Copy', before: { label: 'Boring', text: 'Our product has feature A, feature B, and feature C. Click here to buy now for $99.' }, after: { label: 'Engaging', text: 'What do 10,000+ marketers know that you do not? (Keep scrolling to discover the secret they use to 3x their ROI...)' }, insight: 'Creates curiosity gap. Forces scroll. Each section reveals a piece while raising new questions.' },
      { type: 'quiz', question: 'What psychological effect makes readers unable to stop reading when tension is created?', options: ['The Dopamine Effect', 'The Zeigarnik Effect', 'The Curiosity Principle', 'The Attention Span Theory'], correctIndex: 1, feedback: { correct: 'Exactly! The Zeigarnik Effect is why our brains remember incomplete tasks better than completed ones. An open loop creates a mental itch that demands scratching.', incorrect: 'Not quite. It is the Zeigarnik Effect—our brains remember incomplete tasks better than completed ones, creating a mental itch that demands scratching.' }},
      { type: 'completion', sources: [] }
    ];

    const TECHNIQUES = [
      { name: 'The Open Loop', icon: 'Loop', color: '#f43f5e', description: 'Start with a promise but delay the payoff. Your reader desperately wants closure.', example: '"There is one technique that tripled my conversion rate—I will reveal it in a moment, but first..."' },
      { name: 'Progressive Revelation', icon: 'Layers', color: '#8b5cf6', description: 'Reveal information in layers. Like peeling an onion, each layer creates hunger for the next.', example: 'General problem → specific manifestation → personal consequence → unique solution.' },
      { name: 'The Contrast Gap', icon: 'Split', color: '#06b6d4', description: 'Show painful present vs. desirable future. The bigger the gap, the stronger the pull.', example: 'Where you are now (struggling) vs. where you could be (thriving).' },
      { name: 'Timed Stakes', icon: 'Clock', color: '#f59e0b', description: 'Add urgency by showing what happens if action is not taken. Time transforms interest into engagement.', example: '"Every day without this knowledge costs you opportunities..."' }
    ];

    const MISTAKES = [
      { title: 'Resolving Too Early', description: 'Resist giving everything away immediately. Build desire first, then satisfy it.', icon: 'FastForward' },
      { title: 'Creating False Tension', description: 'Clickbait destroys trust. Every loop must close with genuine value.', icon: 'AlertTriangle' },
      { title: 'Overcomplicating Loops', description: 'Too many loops confuse readers. Stick to one or two main tension threads.', icon: 'Shuffle' }
    ];

    const Icons = {
      Clock: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      Zap: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
      Loop: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>,
      Layers: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
      Split: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"/><path d="m15 9 6-6"/></svg>,
      Brain: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M12 18v4"/></svg>,
      FastForward: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/></svg>,
      AlertTriangle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
      Shuffle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>,
      TrendingUp: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
      Target: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
      Lightbulb: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
      Link: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
      ExternalLink: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
    };

    // AnimatedCounter component
    const AnimatedCounter = ({ value, duration = 2000, prefix = '', suffix = '' }) => {
      const [count, setCount] = useState(0);
      useEffect(() => {
        let startTime;
        const animate = (currentTime) => {
          if (!startTime) startTime = currentTime;
          const progress = Math.min((currentTime - startTime) / duration, 1);
          setCount(Math.floor(progress * value));
          if (progress < 1) requestAnimationFrame(animate);
        };
        requestAnimationFrame(animate);
      }, [value, duration]);
      return <span>{prefix}{count}{suffix}</span>;
    };

    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      useEffect(() => { onShowGif(welcomeData.gif, '65%', gifSide); return () => onHideGif(); }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-2 md:mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg lg:text-xl mb-2 md:mb-3 max-w-lg leading-relaxed" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center justify-center gap-1.5 text-neutral-400 text-[10px] md:text-xs mb-2 md:mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-xl md:rounded-2xl p-3 md:p-5 mb-3 md:mb-4 max-w-sm w-full mx-auto">
              <p className="text-neutral-500 text-[9px] md:text-[11px] uppercase tracking-wider mb-2 md:mb-3">In this lesson</p>
              <ul className="space-y-1.5 md:space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>{i + 1}</span>
                    <span className="text-neutral-300 text-[11px] md:text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-6 md:px-7 py-2.5 md:py-3 rounded-xl text-white font-semibold text-sm md:text-base" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8 md:py-10 relative z-10">
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="mb-4 md:mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3 md:mb-4" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>The Hook</span>
            <h2 className="slide-title text-2xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-base md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
        </div>
      </div>
    );

    // CUSTOM: Rubber Band Visualization Slide
    const RubberBandSlide = ({ data }) => {
      const [stretch, setStretch] = useState(0);

      useEffect(() => {
        const interval = setInterval(() => {
          setStretch(s => s >= 100 ? 0 : s + 2);
        }, 50);
        return () => clearInterval(interval);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
            <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold mb-4" style={{ background: 'rgba(244, 63, 94, 0.1)', color: '#f43f5e' }}>
              <Icons.Target />
              <span>The Core Concept</span>
            </div>
            <h2 className="slide-title text-2xl md:text-4xl text-black">{data.title}</h2>
          </motion.div>

          {/* Rubber Band Animation */}
          <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} transition={{ delay: 0.2 }}
            className="relative mx-auto mb-8" style={{ width: '100%', maxWidth: '500px', height: '200px' }}>
            {/* Left finger */}
            <div style={{ position: 'absolute', left: '10%', top: '50%', transform: 'translateY(-50%)', width: '40px', height: '80px', background: 'linear-gradient(135deg, #fcd34d, #f59e0b)', borderRadius: '20px 20px 8px 8px' }} />
            {/* Right finger */}
            <div style={{ position: 'absolute', right: '10%', top: '50%', transform: 'translateY(-50%)', width: '40px', height: '80px', background: 'linear-gradient(135deg, #fcd34d, #f59e0b)', borderRadius: '20px 20px 8px 8px' }} />
            {/* Rubber band */}
            <motion.div
              animate={{ scaleX: 1 + (stretch / 200) }}
              style={{
                position: 'absolute',
                left: 'calc(10% + 40px)',
                right: 'calc(10% + 40px)',
                top: '50%',
                transform: 'translateY(-50%)',
                height: `${12 - stretch / 20}px`,
                background: `linear-gradient(90deg, #f43f5e, #e11d48)`,
                borderRadius: '10px',
                boxShadow: `0 0 ${10 + stretch / 5}px rgba(244, 63, 94, ${0.3 + stretch / 200})`
              }}
            />
            {/* Tension label */}
            <motion.div animate={{ opacity: 0.5 + stretch / 200 }}
              style={{ position: 'absolute', bottom: '20px', left: '50%', transform: 'translateX(-50%)', fontSize: '14px', fontWeight: 'bold', color: '#f43f5e' }}>
              TENSION: {Math.round(stretch)}%
            </motion.div>
          </motion.div>

          {/* Concept Card */}
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3 }}
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '16px', padding: '24px', position: 'relative', overflow: 'hidden' }}>
            <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: 'linear-gradient(90deg, transparent, #f43f5e, transparent)' }} />
            <p className="text-white text-center text-lg leading-relaxed">{data.concept}</p>
            <p className="text-neutral-400 text-center text-sm mt-3">The psychological gap between where your reader <strong className="text-white">is</strong> and where they <strong className="text-white">want to be</strong>.</p>
          </motion.div>
        </div>
      );
    };

    // CUSTOM: Tension Stats Slide with AnimatedCounter
    const TensionStatsSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
          <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold mb-4" style={{ background: 'rgba(244, 63, 94, 0.1)', color: '#f43f5e' }}>
            <Icons.TrendingUp />
            <span>The Impact</span>
          </div>
          <h2 className="slide-title text-2xl md:text-4xl text-black">{data.title}</h2>
        </motion.div>

        <div className="grid md:grid-cols-3 gap-4">
          {data.stats.map((stat, i) => (
            <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 + i * 0.15 }}
              style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '16px', padding: '28px 20px', position: 'relative', overflow: 'hidden', boxShadow: '0 0 30px rgba(244, 63, 94, 0.15)' }}>
              <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: 'linear-gradient(90deg, transparent, #f43f5e, transparent)' }} />
              <div className="text-center">
                <div className="text-5xl md:text-6xl font-bold mb-2" style={{ color: '#f43f5e' }}>
                  <AnimatedCounter value={parseInt(stat.value)} suffix={stat.suffix} duration={1500 + i * 300} />
                </div>
                <div className="text-white font-semibold mb-1">{stat.label}</div>
                <div className="text-neutral-400 text-sm">{stat.subtext}</div>
              </div>
            </motion.div>
          ))}
        </div>
      </div>
    );

    // CUSTOM: Four Techniques Overview Slide
    const FourTechniquesSlide = ({ data }) => {
      const [activeIndex, setActiveIndex] = useState(0);

      useEffect(() => {
        const interval = setInterval(() => {
          setActiveIndex(i => (i + 1) % 4);
        }, 2500);
        return () => clearInterval(interval);
      }, []);

      const TechniqueIcon = ({ technique }) => {
        switch(technique.icon) {
          case 'Loop': return <Icons.Loop />;
          case 'Layers': return <Icons.Layers />;
          case 'Split': return <Icons.Split />;
          case 'Clock': return <Icons.Clock />;
          default: return <Icons.Zap />;
        }
      };

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
            <h2 className="slide-title text-2xl md:text-4xl text-black">{data.title}</h2>
            <p className="text-neutral-500 mt-2">Master these four to captivate any audience</p>
          </motion.div>

          <div className="grid grid-cols-2 gap-4">
            {TECHNIQUES.map((tech, i) => (
              <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 + i * 0.1 }}
                style={{
                  background: activeIndex === i ? 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' : 'white',
                  border: activeIndex === i ? 'none' : '2px solid #e5e5e5',
                  borderRadius: '16px',
                  padding: '20px',
                  position: 'relative',
                  overflow: 'hidden',
                  transform: activeIndex === i ? 'scale(1.02)' : 'scale(1)',
                  transition: 'all 0.3s ease',
                  boxShadow: activeIndex === i ? `0 0 30px ${tech.color}30` : 'none'
                }}>
                {activeIndex === i && (
                  <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: `linear-gradient(90deg, transparent, ${tech.color}, transparent)` }} />
                )}
                <div className="flex items-center gap-3 mb-2">
                  <div style={{ width: '40px', height: '40px', borderRadius: '10px', background: activeIndex === i ? `${tech.color}20` : '#f5f5f5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: tech.color }}>
                    <TechniqueIcon technique={tech} />
                  </div>
                  <div style={{ width: '24px', height: '24px', borderRadius: '6px', background: tech.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: 'bold' }}>
                    {i + 1}
                  </div>
                </div>
                <h3 className="font-bold mb-1" style={{ color: activeIndex === i ? 'white' : '#1a1a1a' }}>{tech.name}</h3>
                <p className="text-sm leading-relaxed" style={{ color: activeIndex === i ? '#a3a3a3' : '#737373' }}>{tech.description}</p>
              </motion.div>
            ))}
          </div>
        </div>
      );
    };

    // CUSTOM: Technique Detail Slide
    const TechniqueDetailSlide = ({ data }) => {
      const technique = TECHNIQUES[data.techniqueIndex];

      const TechniqueIcon = () => {
        switch(technique.icon) {
          case 'Loop': return <Icons.Loop />;
          case 'Layers': return <Icons.Layers />;
          case 'Split': return <Icons.Split />;
          case 'Clock': return <Icons.Clock />;
          default: return <Icons.Zap />;
        }
      };

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-3xl mx-auto">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
            <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold mb-4" style={{ background: `${technique.color}20`, color: technique.color }}>
              <span>Technique {data.techniqueIndex + 1} of 4</span>
            </div>
          </motion.div>

          <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} transition={{ delay: 0.1 }}
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '20px', padding: '32px', position: 'relative', overflow: 'hidden', boxShadow: `0 0 40px ${technique.color}25` }}>
            <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '4px', background: `linear-gradient(90deg, transparent, ${technique.color}, transparent)` }} />

            <div className="flex items-center gap-4 mb-6">
              <div style={{ width: '56px', height: '56px', borderRadius: '14px', background: `${technique.color}20`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: technique.color }}>
                <TechniqueIcon />
              </div>
              <h2 className="slide-title text-2xl md:text-3xl text-white">{technique.name}</h2>
            </div>

            <p className="text-neutral-300 text-lg leading-relaxed mb-6">{technique.description}</p>

            <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: '12px', padding: '20px', borderLeft: `4px solid ${technique.color}` }}>
              <p className="text-neutral-400 text-xs uppercase tracking-wider mb-2">Example</p>
              <p className="text-white italic leading-relaxed">{technique.example}</p>
            </div>
          </motion.div>
        </div>
      );
    };

    // CUSTOM: Zeigarnik Effect Slide
    const ZeigarnikSlide = ({ data }) => {
      const [showOpen, setShowOpen] = useState(true);

      useEffect(() => {
        const interval = setInterval(() => {
          setShowOpen(s => !s);
        }, 3000);
        return () => clearInterval(interval);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
            <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold mb-4" style={{ background: 'rgba(139, 92, 246, 0.1)', color: '#8b5cf6' }}>
              <Icons.Brain />
              <span>The Science</span>
            </div>
            <h2 className="slide-title text-2xl md:text-4xl text-black">{data.title}</h2>
          </motion.div>

          {/* Brain comparison */}
          <div className="grid md:grid-cols-2 gap-6 mb-6">
            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.2 }}
              style={{
                background: showOpen ? 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' : 'white',
                border: showOpen ? 'none' : '2px solid #e5e5e5',
                borderRadius: '16px',
                padding: '24px',
                position: 'relative',
                overflow: 'hidden',
                transition: 'all 0.5s ease',
                boxShadow: showOpen ? '0 0 30px rgba(244, 63, 94, 0.2)' : 'none'
              }}>
              {showOpen && <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: 'linear-gradient(90deg, transparent, #f43f5e, transparent)' }} />}
              <div className="text-center">
                <Icons.Loop />
                <h3 className="font-bold text-lg mt-3 mb-2" style={{ color: showOpen ? 'white' : '#1a1a1a' }}>Open Loop</h3>
                <p className="text-sm mb-4" style={{ color: showOpen ? '#a3a3a3' : '#737373' }}>Incomplete task / unanswered question</p>
                <div style={{ display: 'flex', justifyContent: 'center', gap: '8px' }}>
                  {[1,2,3,4,5].map(i => (
                    <motion.div key={i} animate={{ opacity: showOpen ? [0.3, 1, 0.3] : 0.3 }}
                      transition={{ duration: 1.5, repeat: showOpen ? Infinity : 0, delay: i * 0.2 }}
                      style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#f43f5e' }} />
                  ))}
                </div>
                <p className="text-xs mt-3" style={{ color: showOpen ? '#f43f5e' : '#a3a3a3' }}>{showOpen ? 'ACTIVE - Brain keeps processing' : 'Waiting...'}</p>
              </div>
            </motion.div>

            <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3 }}
              style={{
                background: !showOpen ? 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' : 'white',
                border: !showOpen ? 'none' : '2px solid #e5e5e5',
                borderRadius: '16px',
                padding: '24px',
                position: 'relative',
                overflow: 'hidden',
                transition: 'all 0.5s ease',
                boxShadow: !showOpen ? '0 0 30px rgba(34, 197, 94, 0.2)' : 'none'
              }}>
              {!showOpen && <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: 'linear-gradient(90deg, transparent, #22c55e, transparent)' }} />}
              <div className="text-center">
                <Icons.Check />
                <h3 className="font-bold text-lg mt-3 mb-2" style={{ color: !showOpen ? 'white' : '#1a1a1a' }}>Closed Loop</h3>
                <p className="text-sm mb-4" style={{ color: !showOpen ? '#a3a3a3' : '#737373' }}>Completed task / answered question</p>
                <div style={{ display: 'flex', justifyContent: 'center', gap: '8px' }}>
                  {[1,2,3,4,5].map(i => (
                    <div key={i} style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#22c55e', opacity: !showOpen ? 1 : 0.3 }} />
                  ))}
                </div>
                <p className="text-xs mt-3" style={{ color: !showOpen ? '#22c55e' : '#a3a3a3' }}>{!showOpen ? 'RESOLVED - Brain moves on' : 'Forgotten...'}</p>
              </div>
            </motion.div>
          </div>

          {/* Insight card */}
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4 }}
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden' }}>
            <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: 'linear-gradient(90deg, transparent, #8b5cf6, transparent)' }} />
            <div className="flex items-start gap-4">
              <div style={{ width: '40px', height: '40px', borderRadius: '10px', background: 'rgba(139, 92, 246, 0.2)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#8b5cf6', flexShrink: 0 }}>
                <Icons.Lightbulb />
              </div>
              <div>
                <h4 className="text-white font-bold mb-1">{data.effect}</h4>
                <p className="text-neutral-400 text-sm leading-relaxed">Our brains remember <strong className="text-white">incomplete tasks</strong> better than completed ones. An open loop creates a mental itch that demands scratching—keeping readers engaged until resolution.</p>
              </div>
            </div>
          </motion.div>
        </div>
      );
    };

    // CUSTOM: Tension Example Slide (Before/After)
    const TensionExampleSlide = ({ data }) => {
      const [showWinner, setShowWinner] = useState(false);

      useEffect(() => {
        const timer = setTimeout(() => setShowWinner(true), 1500);
        return () => clearTimeout(timer);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
            <span className="inline-block px-4 py-2 rounded-full text-sm font-semibold mb-3" style={{ background: 'rgba(244, 63, 94, 0.1)', color: '#f43f5e' }}>Real Example</span>
            <h2 className="slide-title text-xl md:text-3xl text-black">{data.scenario}</h2>
          </motion.div>

          <div className="grid md:grid-cols-2 gap-4 mb-6">
            {/* Before */}
            <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 }}
              style={{ background: 'white', border: '2px solid #fecaca', borderRadius: '16px', padding: '20px', position: 'relative' }}>
              <div className="flex items-center gap-2 mb-3">
                <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: '#ef4444', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}>
                  <Icons.X />
                </div>
                <span className="font-bold text-red-600 text-sm">{data.before.label}</span>
              </div>
              <p className="text-neutral-700 text-sm leading-relaxed italic">"{data.before.text}"</p>
            </motion.div>

            {/* After */}
            <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.2 }}
              style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '16px', padding: '20px', position: 'relative', overflow: 'hidden', boxShadow: '0 0 30px rgba(34, 197, 94, 0.15)' }}>
              <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: 'linear-gradient(90deg, transparent, #22c55e, transparent)' }} />
              {showWinner && (
                <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }}
                  style={{ position: 'absolute', top: '-10px', right: '-10px', background: '#22c55e', color: 'white', padding: '4px 12px', borderRadius: '20px', fontSize: '11px', fontWeight: 'bold', transform: 'rotate(12deg)' }}>
                  WINS
                </motion.div>
              )}
              <div className="flex items-center gap-2 mb-3">
                <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: '#22c55e', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}>
                  <Icons.Check />
                </div>
                <span className="font-bold text-green-400 text-sm">{data.after.label}</span>
              </div>
              <p className="text-white text-sm leading-relaxed italic">"{data.after.text}"</p>
            </motion.div>
          </div>

          {/* Insight */}
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3 }}
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '12px', padding: '16px', position: 'relative', overflow: 'hidden' }}>
            <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: 'linear-gradient(90deg, transparent, #f43f5e, transparent)' }} />
            <div className="flex items-center gap-3">
              <div style={{ color: '#f43f5e' }}><Icons.Zap /></div>
              <p className="text-neutral-300 text-sm">{data.insight}</p>
            </div>
          </motion.div>
        </div>
      );
    };

    // CUSTOM: Mistakes Grid Slide
    const MistakesGridSlide = ({ data }) => {
      const [activeIndex, setActiveIndex] = useState(0);

      useEffect(() => {
        const interval = setInterval(() => {
          setActiveIndex(i => (i + 1) % 3);
        }, 3000);
        return () => clearInterval(interval);
      }, []);

      const MistakeIcon = ({ icon }) => {
        switch(icon) {
          case 'FastForward': return <Icons.FastForward />;
          case 'AlertTriangle': return <Icons.AlertTriangle />;
          case 'Shuffle': return <Icons.Shuffle />;
          default: return <Icons.AlertTriangle />;
        }
      };

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto">
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-8">
            <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold mb-4" style={{ background: 'rgba(239, 68, 68, 0.1)', color: '#ef4444' }}>
              <Icons.AlertTriangle />
              <span>Watch Out</span>
            </div>
            <h2 className="slide-title text-2xl md:text-4xl text-black">{data.title}</h2>
          </motion.div>

          <div className="grid md:grid-cols-3 gap-4">
            {MISTAKES.map((mistake, i) => (
              <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 + i * 0.1 }}
                style={{
                  background: activeIndex === i ? 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' : 'white',
                  border: activeIndex === i ? 'none' : '2px solid #fecaca',
                  borderRadius: '16px',
                  padding: '24px',
                  position: 'relative',
                  overflow: 'hidden',
                  transform: activeIndex === i ? 'scale(1.03)' : 'scale(1)',
                  transition: 'all 0.3s ease',
                  boxShadow: activeIndex === i ? '0 0 30px rgba(239, 68, 68, 0.2)' : 'none'
                }}>
                {activeIndex === i && (
                  <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '3px', background: 'linear-gradient(90deg, transparent, #ef4444, transparent)' }} />
                )}
                <div style={{ width: '48px', height: '48px', borderRadius: '12px', background: activeIndex === i ? 'rgba(239, 68, 68, 0.2)' : '#fef2f2', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#ef4444', marginBottom: '16px' }}>
                  <MistakeIcon icon={mistake.icon} />
                </div>
                <h3 className="font-bold mb-2" style={{ color: activeIndex === i ? 'white' : '#1a1a1a' }}>{mistake.title}</h3>
                <p className="text-sm leading-relaxed" style={{ color: activeIndex === i ? '#a3a3a3' : '#737373' }}>{mistake.description}</p>
              </motion.div>
            ))}
          </div>
        </div>
      );
    };

    const QuizSlide = ({ data, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const celebrationGif = useMemo(() => getRandomCelebrationGif(), []);
      const empathyGif = useMemo(() => getRandomEmpathyGif(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      const handleSelect = (index) => { if (showFeedback) return; setSelected(index); setShowFeedback(true); };
      const isCorrect = selected === data.correctIndex;

      useEffect(() => { if (showFeedback) { onShowGif(isCorrect ? celebrationGif : empathyGif, '60%', gifSide); } }, [showFeedback, isCorrect, celebrationGif, empathyGif, gifSide, onShowGif]);
      useEffect(() => { return () => onHideGif(); }, [onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col justify-center px-8 md:px-12 max-w-2xl mx-auto slide-scroll overflow-y-auto py-10 relative z-30">
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
              <p className="text-xs uppercase tracking-wider text-neutral-400 mb-3">Quick Check</p>
              <h2 className="slide-title text-xl md:text-2xl text-black leading-tight">{data.question}</h2>
            </motion.div>
            <div className="space-y-3 mb-6">
              {data.options.map((option, i) => (
                <motion.button key={i} initial={{ opacity: 0, x: -15 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.08 + i * 0.06 }} onClick={() => handleSelect(i)} disabled={showFeedback}
                  className={`w-full p-4 rounded-xl text-left transition-all border-2 ${showFeedback ? i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-400 bg-red-50' : 'border-neutral-200 bg-white opacity-40' : 'border-neutral-200 bg-white hover:border-neutral-300'}`}>
                  <div className="flex items-center gap-3">
                    <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold transition-all ${showFeedback && i === data.correctIndex ? 'bg-green-500 text-white' : showFeedback && i === selected && !isCorrect ? 'bg-red-400 text-white' : 'bg-neutral-100 text-neutral-500'}`}>
                      {showFeedback && i === data.correctIndex ? <Icons.Check /> : showFeedback && i === selected && !isCorrect ? <Icons.X /> : String.fromCharCode(65 + i)}
                    </span>
                    <span className="text-neutral-700 text-sm md:text-base">{option}</span>
                  </div>
                </motion.button>
              ))}
            </div>
            <AnimatePresence>
              {showFeedback && (
                <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className={`p-5 rounded-xl ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                  <p className={`text-sm leading-relaxed ${isCorrect ? 'text-green-800' : 'text-amber-800'}`}>{isCorrect ? data.feedback.correct : data.feedback.incorrect}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      );
    };

    const CompletionSlide = ({ data }) => (
      <div className="h-full flex flex-col items-center justify-center text-center px-8 slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'spring', duration: 0.5 }} className="w-16 h-16 rounded-xl flex items-center justify-center mb-4 text-white" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))`, boxShadow: `0 6px 24px rgba(var(--accent-rgb), 0.35)` }}><Icons.Check /></motion.div>
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="slide-title text-2xl md:text-3xl text-black mb-3">Lesson Complete</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }} className="text-neutral-500 text-sm mb-5 max-w-md leading-relaxed">You now understand structural tension: the invisible force that keeps readers engaged. Use open loops, progressive revelation, contrast gaps, and timed stakes to captivate any audience.</motion.p>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }} className="bg-neutral-900 rounded-xl p-5 max-w-md w-full mb-4">
          <p className="text-neutral-500 text-xs uppercase tracking-wider mb-2">Up Next</p>
          <h3 className="text-white font-bold text-lg mb-1">{LESSON_CONFIG.nextLesson.title}</h3>
          <p className="text-neutral-400 text-xs">{LESSON_CONFIG.nextLesson.teaser}</p>
        </motion.div>
      </div>
    );

    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(getInitialSlide());
      const [direction, setDirection] = useState(1);
      const userName = useMemo(() => getUserName(), []);
      const currentSlideRef = React.useRef(0);
      const [gifConfig, setGifConfig] = useState(null);
      const [isAnimating, setIsAnimating] = useState(false);

      const showGif = useCallback((url, height, side) => setGifConfig({ url, height, side }), []);
      const hideGif = useCallback(() => setGifConfig(null), []);

      React.useEffect(() => { currentSlideRef.current = currentSlide; }, [currentSlide]);

      useEffect(() => {
        window.parent.postMessage({ type: 'LESSON_SLIDE_UPDATE', slideIndex: currentSlide, slideType: slides[currentSlide]?.type, lessonSlug: LESSON_CONFIG.id }, '*');
      }, [currentSlide]);

      const goToSlide = useCallback((newSlide) => {
        if (isAnimating || newSlide < 0 || newSlide >= slides.length) return;
        setIsAnimating(true);
        setDirection(newSlide > currentSlideRef.current ? 1 : -1);
        setCurrentSlide(newSlide);
      }, [isAnimating]);

      const nextSlide = useCallback(() => { if (currentSlideRef.current + 1 < slides.length) goToSlide(currentSlideRef.current + 1); }, [goToSlide]);
      const prevSlide = useCallback(() => { if (currentSlideRef.current - 1 >= 0) goToSlide(currentSlideRef.current - 1); }, [goToSlide]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [nextSlide, prevSlide]);

      const slideVariants = {
        enter: (dir) => ({ x: dir > 0 ? '100%' : '-100%', opacity: 0 }),
        center: { x: 0, opacity: 1 },
        exit: (dir) => ({ x: dir > 0 ? '-100%' : '100%', opacity: 0 })
      };

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={nextSlide} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'rubber-band': return <RubberBandSlide data={slide} />;
          case 'tension-stats': return <TensionStatsSlide data={slide} />;
          case 'four-techniques': return <FourTechniquesSlide data={slide} />;
          case 'technique-detail': return <TechniqueDetailSlide data={slide} />;
          case 'zeigarnik': return <ZeigarnikSlide data={slide} />;
          case 'tension-example': return <TensionExampleSlide data={slide} />;
          case 'mistakes-grid': return <MistakesGridSlide data={slide} />;
          case 'quiz': return <QuizSlide data={slide} onShowGif={showGif} onHideGif={hideGif} />;
          case 'completion': return <CompletionSlide data={slide} />;
          default: return null;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction} onExitComplete={() => setIsAnimating(false)}>
              <motion.div key={currentSlide} custom={direction} variants={slideVariants} initial="enter" animate="center" exit="exit" transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
                <AdminSlideReportButton slideIndex={currentSlide} slideType={slides[currentSlide].type} />
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => goToSlide(i)} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gifConfig && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }} className={`absolute ${gifConfig.side === 'left' ? 'left-4 md:left-8' : 'right-4 md:right-8'} bottom-0 pointer-events-none`} style={{ zIndex: 15, height: gifConfig.height }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom" style={{ background: 'transparent', border: 'none', boxShadow: 'none' }}>
                  <source src={gifConfig.url} type="video/mp4" />
                </video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<LessonApp />);
  </script>
</body>
</html>
