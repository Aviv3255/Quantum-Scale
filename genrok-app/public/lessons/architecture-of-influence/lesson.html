<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Architecture of Influence | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #88da1c; --accent-dark: #6fb816; --accent-light: #a3e635; --accent-rgb: 136, 218, 28; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => { const params = new URLSearchParams(window.location.search); return params.get('userName') || 'Builder'; };
    const getInitialSlide = () => { const params = new URLSearchParams(window.location.search); const slide = params.get('slide'); return slide ? parseInt(slide, 10) : 0; };

    const LESSON_CONFIG = {
      id: 'architecture-of-influence',
      title: 'Architecture of Influence',
      description: 'Learn the invisible framework that transforms words into persuasion engines.',
      accentColor: '#88da1c',
      duration: '6 min',
      nextLesson: { id: 'wiifm-principle', title: 'The WIIFM Principle', teaser: 'The only question your reader is asking. Answer it or lose them forever.' }
    };

    // ============ ADMIN REPORTER SYSTEM ============
    let __isAdmin = false;
    window.addEventListener('message', function(e) { if (e.data?.type === 'ADMIN_STATUS') { __isAdmin = e.data.isAdmin; } });
    if (window.parent !== window) { window.parent.postMessage({ type: 'CHECK_ADMIN_STATUS' }, '*'); }

    const AdminSlideReportButton = ({ slideIndex, slideType }) => {
      const handleReport = (e) => {
        e.stopPropagation(); e.preventDefault();
        if (window.parent !== window) {
          window.parent.postMessage({ type: 'ADMIN_REPORT_REQUEST', slideIndex, slideType, lessonSlug: LESSON_CONFIG.id, elementId: slideType + '-' + slideIndex }, '*');
        }
      };
      return (
        <button onClick={handleReport} title={`Report issue on Slide ${slideIndex + 1}`}
          style={{ position: 'absolute', top: '12px', right: '12px', width: '32px', height: '32px', borderRadius: '8px', backgroundColor: 'rgba(239, 68, 68, 0.9)', color: 'white', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, opacity: 0.6, transition: 'opacity 0.2s, transform 0.2s' }}
          onMouseEnter={(e) => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.transform = 'scale(1.1)'; }}
          onMouseLeave={(e) => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.transform = 'scale(1)'; }}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>
        </button>
      );
    };

    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_playing_air_guitar_light_headbanging_rockstar__0702007e-9e84-4d9e-8f99-8ee23d0b65f8_2.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];

    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_covering_face_with_palm_facepalm_gesture_disap_211b0566-078f-4d42-9c41-547b14f5827c_0.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    // ============================================
    // SLIDE DATA
    // ============================================
    const slides = [
      { type: 'welcome', learningGoals: [
        'Why 80% of Shopify stores write copy that doesn\'t convert',
        'The 3-layer pyramid that separates winning product pages from losers',
        'How to build persuasion that feels effortless to your customer'
      ]},

      { type: 'hook', headline: 'Here\'s the Truth Nobody Tells You', subtext: 'You can have the perfect headline. Punchy. Emotional. All the copywriting tricks checked off. And it still won\'t convert a single sale.' },

      { type: 'content', title: 'Most Stores Start Backwards', body: 'They obsess over tactics. A/B testing headlines. Tweaking CTAs. Polishing bullet points.\n\nMeanwhile, their foundation is crumbling.\n\nGreat copy isn\'t written. It\'s engineered.' },

      { type: 'pyramid-visual', title: 'The Pyramid of Persuasion', characterVideo: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_pointing_at_a_chart_presentingexplaining_100_p_d3ddf2c8-5905-4952-b8cc-0eaed3e8b732_3.mp4', characterPosition: 'left' },

      { type: 'content', title: 'Layer 1: The Bedrock', body: 'Your core promise. The transformation you deliver. The problem you solve.\n\nThis is what everything builds upon.\n\nWeak foundation = everything above it collapses.', characterVideo: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_building_something_with_tools_constructing_100_52683f04-d09a-47c4-89a1-84b57476d150_2.mp4', characterPosition: 'right' },

      { type: 'before-after', headline: 'Foundation Example',
        before: { title: 'Weak Foundation', items: ['We sell premium yoga mats', 'For fitness enthusiasts', 'Product-focused'] },
        after: { title: 'Strong Foundation', items: ['Transform from couch potato', 'To 6am yogi in 30 days', 'Transformation-focused'] },
        insight: 'The foundation isn\'t what you sell. It\'s the transformation your customer becomes.' },

      { type: 'content', title: 'Layer 2: The Structure', body: 'Who exactly are you talking to? What do they believe? What do they fear? How will you reach them?\n\nYour strategy shapes every tactical decision.\n\nWithout clear pillars, your tactics crumble.' },

      { type: 'icon-grid', title: 'The 5 Strategic Pillars', items: [
        { icon: 'user', title: 'Avatar', description: 'Who is this for? Be specific. "Busy moms" is not specific enough.' },
        { icon: 'eye', title: 'Awareness', description: 'What do they already know? Problem-aware? Solution-aware?' },
        { icon: 'megaphone', title: 'Channel', description: 'Where will you reach them? Facebook? TikTok? Email?' }
      ] },

      { type: 'content', title: 'Layer 3: The Tactics', body: 'Headlines that stop thumbs. Hooks that hold attention. Stories that stick. Proof that convinces. CTAs that convert.\n\nThis is where most marketers start. But it\'s actually the LAST layer you should build.' },

      { type: 'comparison-visual', title: 'The Critical Mistake', characterVideo: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_pointing_at_a_chart_presentingexplaining_100_p_d3ddf2c8-5905-4952-b8cc-0eaed3e8b732_3.mp4', characterPosition: 'right' },

      { type: 'content', title: 'The MAYA Principle', body: 'Most Advanced Yet Acceptable.\n\nHumans are torn between two forces: love of novelty and fear of the new.\n\nThe sweet spot? Familiar enough to feel safe, novel enough to be interesting.\n\nToo familiar = boring. Too novel = scary. MAYA = perfect.' },

      { type: 'before-after', headline: 'MAYA in Action',
        before: { title: 'Too Familiar', items: ['High-quality yoga mat', 'With non-slip grip', 'Boring, forgettable'] },
        after: { title: 'MAYA Zone', items: ['The yoga mat that grips', 'Like Lululemon but costs 60% less', 'Familiar reference + twist'] },
        insight: 'Use a familiar reference (Lululemon) with an unexpected twist (60% less). That\'s MAYA.' },

      { type: 'icon-grid', title: 'The 3 Principles of Influence', items: [
        { icon: 'scale', title: 'Balance New & Known', description: 'Find the edge where curiosity meets comfort' },
        { icon: 'filter', title: 'Select, Don\'t Sell', description: 'The best copy qualifies customers, it doesn\'t chase them' },
        { icon: 'heart', title: 'Empathize, Then Frame', description: 'Show you understand their world, then reshape how they see it' }
      ], characterVideo: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_weighing_options_scales_in_hands_100_pure_whit_8cbe7780-615e-48f5-aafe-2184114c1b33_2.mp4', characterPosition: 'right' },

      { type: 'quote', text: 'Great persuasion doesn\'t feel like persuasion. It feels like the reader finally found someone who gets them.', attribution: 'The Architecture of Influence' },

      { type: 'quiz', question: 'A Shopify store is A/B testing headlines but conversion is still 1.2%. What\'s the real problem?', options: ['They need better traffic sources', 'Their foundation and strategy are weak', 'They need more product images', 'Their checkout process is too long'], correctIndex: 1, feedback: { correct: 'Exactly! You can\'t optimize your way out of a weak foundation. Tactics (headlines) mean nothing if your core promise and strategy aren\'t solid.', incorrect: 'Think bigger. Headlines are tactics - the TOP of the pyramid. If conversion is that low, the problem is deeper. Fix the foundation and strategy first.' }},

      { type: 'completion', sources: [] }
    ];

    // ============================================
    // ICONS
    // ============================================
    const Icons = {
      Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      Zap: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
      Sparkles: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
      User: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
      Eye: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
      Megaphone: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 11 18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>,
      Scale: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
      Filter: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
      Heart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
    };

    const getIcon = (name) => {
      const iconMap = { user: Icons.User, eye: Icons.Eye, megaphone: Icons.Megaphone, scale: Icons.Scale, filter: Icons.Filter, heart: Icons.Heart };
      const IconComponent = iconMap[name] || Icons.Zap;
      return <IconComponent />;
    };

    // ============================================
    // ANIMATED COUNTER
    // ============================================
    const AnimatedCounter = ({ target, suffix = '', decimals = 0, duration = 2000 }) => {
      const [count, setCount] = useState(0);
      useEffect(() => {
        let start = 0;
        const increment = target / (duration / 16);
        const timer = setInterval(() => {
          start += increment;
          if (start >= target) { setCount(target); clearInterval(timer); }
          else { setCount(decimals > 0 ? parseFloat(start.toFixed(decimals)) : Math.floor(start)); }
        }, 16);
        return () => clearInterval(timer);
      }, [target, duration, decimals]);
      return <span>{decimals > 0 ? count.toFixed(decimals) : count}{suffix}</span>;
    };

    // ============================================
    // CUSTOM VISUAL: Pyramid
    // ============================================
    const PyramidVisual = ({ characterVideo, characterPosition }) => {
      const levels = [
        { label: 'Layer 3', name: 'TACTICAL EXECUTION', sublabel: 'Headlines, hooks, CTAs', width: '55%', importance: 20 },
        { label: 'Layer 2', name: 'STRATEGIC PILLARS', sublabel: 'Avatar, awareness, channel', width: '75%', importance: 30 },
        { label: 'Layer 1', name: 'FOUNDATION', sublabel: 'Core promise, transformation', width: '95%', importance: 50 }
      ];
      return (
        <div className="h-full flex items-center justify-center p-6 md:p-8 relative">
          <div className="bg-black rounded-2xl p-6 md:p-10 w-full max-w-xl" style={{ boxShadow: '0 8px 32px rgba(0,0,0,0.4), 0 0 60px rgba(var(--accent-rgb), 0.08)' }}>
            <p className="text-center text-neutral-500 text-sm mb-8 uppercase tracking-widest">The Pyramid of Persuasion</p>
            <div className="flex flex-col items-center gap-4">
              {levels.map((level, i) => (
                <motion.div key={level.label} initial={{ opacity: 0, scale: 0.8, y: -20 }} animate={{ opacity: 1, scale: 1, y: 0 }} transition={{ delay: 0.2 + i * 0.15, type: 'spring' }} style={{ width: level.width }}>
                  <div className="py-4 px-5 rounded-xl text-center text-white relative overflow-hidden" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))', boxShadow: '0 4px 24px rgba(var(--accent-rgb), 0.4)' }}>
                    <div className="absolute top-2 right-3 text-xs font-bold opacity-40">{level.importance}%</div>
                    <div className="text-xs opacity-60 uppercase tracking-wider mb-1">{level.label}</div>
                    <div className="text-lg md:text-xl font-bold tracking-wide">{level.name}</div>
                    <div className="text-sm opacity-70 mt-1">{level.sublabel}</div>
                  </div>
                </motion.div>
              ))}
            </div>
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.9 }} className="mt-8 space-y-3">
              <div className="flex justify-between text-xs text-neutral-500 uppercase tracking-wider">
                <span>Importance Weight</span><span>100%</span>
              </div>
              <div className="flex gap-1 h-2">
                <motion.div initial={{ width: 0 }} animate={{ width: '50%' }} transition={{ delay: 1.0, duration: 0.8 }} className="rounded-l-full" style={{ background: 'var(--accent)' }} />
                <motion.div initial={{ width: 0 }} animate={{ width: '30%' }} transition={{ delay: 1.2, duration: 0.6 }} style={{ background: 'var(--accent)', opacity: 0.7 }} />
                <motion.div initial={{ width: 0 }} animate={{ width: '20%' }} transition={{ delay: 1.4, duration: 0.4 }} className="rounded-r-full" style={{ background: 'var(--accent)', opacity: 0.4 }} />
              </div>
              <div className="flex justify-between text-[10px] text-neutral-600">
                <span>Foundation 50%</span><span>Strategy 30%</span><span>Tactics 20%</span>
              </div>
            </motion.div>
          </div>
          {characterVideo && (
            <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.5 }}
              className={`absolute bottom-0 ${characterPosition === 'left' ? 'left-4' : 'right-4'} z-0 pointer-events-none hidden md:block`}
              style={{ height: '35%', maxHeight: '280px' }}>
              <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom"><source src={characterVideo} type="video/mp4" /></video>
            </motion.div>
          )}
        </div>
      );
    };

    // ============================================
    // CUSTOM VISUAL: Comparison (Tactics First vs Foundation First)
    // ============================================
    const ComparisonVisualSlide = ({ characterVideo, characterPosition }) => (
      <div className="h-full flex items-center justify-center p-6 md:p-8 relative">
        <div className="w-full max-w-3xl">
          <p className="text-center text-neutral-400 text-sm mb-8 uppercase tracking-widest">The Critical Mistake</p>
          <div className="grid md:grid-cols-2 gap-5">
            {/* Tactics First - Bad */}
            <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }}
              className="bg-black rounded-2xl p-6" style={{ boxShadow: '0 4px 24px rgba(0,0,0,0.3), 0 0 40px rgba(239, 68, 68, 0.08)' }}>
              <div className="flex items-center gap-3 mb-5">
                <div className="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center text-red-400"><Icons.X /></div>
                <div>
                  <span className="text-red-400 text-xs font-medium uppercase tracking-wider">Most Stores</span>
                  <p className="text-white font-semibold text-lg">Tactics First</p>
                </div>
              </div>
              <p className="text-neutral-400 text-sm italic mb-5">"Let me A/B test 50 headlines and hope one works..."</p>
              <div className="pt-4 border-t border-neutral-800">
                <p className="text-neutral-500 text-sm mb-2">Result: Optimizing on a broken foundation</p>
                <div className="flex justify-between text-xs mb-2">
                  <span className="text-neutral-500">Conversion Rate</span>
                  <span className="text-red-400 font-bold text-lg"><AnimatedCounter target={1.2} decimals={1} suffix="%" /></span>
                </div>
                <div className="w-full h-2 bg-neutral-800 rounded-full overflow-hidden">
                  <motion.div initial={{ width: 0 }} animate={{ width: '12%' }} transition={{ delay: 0.5, duration: 1 }} className="h-full bg-red-500 rounded-full" />
                </div>
              </div>
            </motion.div>

            {/* Foundation First - Good */}
            <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }}
              className="bg-black rounded-2xl p-6" style={{ boxShadow: '0 4px 24px rgba(0,0,0,0.3), 0 0 40px rgba(var(--accent-rgb), 0.15)' }}>
              <div className="flex items-center gap-3 mb-5">
                <div className="w-12 h-12 rounded-xl flex items-center justify-center text-white" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))' }}><Icons.Check /></div>
                <div>
                  <span style={{ color: 'var(--accent)' }} className="text-xs font-medium uppercase tracking-wider">Smart Stores</span>
                  <p className="text-white font-semibold text-lg">Foundation First</p>
                </div>
              </div>
              <p className="text-neutral-300 text-sm italic mb-5">"Clear promise, solid strategy, then optimize tactics"</p>
              <div className="pt-4 border-t border-neutral-800">
                <p style={{ color: 'var(--accent)' }} className="text-sm mb-2">Result: Every layer reinforces the others</p>
                <div className="flex justify-between text-xs mb-2">
                  <span className="text-neutral-500">Conversion Rate</span>
                  <span className="font-bold text-lg" style={{ color: '#22C55E' }}><AnimatedCounter target={7.3} decimals={1} suffix="%" /></span>
                </div>
                <div className="w-full h-2 bg-neutral-800 rounded-full overflow-hidden">
                  <motion.div initial={{ width: 0 }} animate={{ width: '73%' }} transition={{ delay: 0.7, duration: 1 }} className="h-full rounded-full" style={{ background: '#22C55E' }} />
                </div>
              </div>
            </motion.div>
          </div>

          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.6 }} className="mt-6 text-center">
            <div className="inline-flex items-center gap-3 bg-black rounded-xl px-6 py-3" style={{ boxShadow: '0 4px 20px rgba(var(--accent-rgb), 0.2)' }}>
              <span className="text-neutral-400 text-sm">That's a</span>
              <span className="text-3xl font-bold" style={{ color: 'var(--accent)' }}><AnimatedCounter target={508} suffix="%" /></span>
              <span className="text-neutral-400 text-sm">improvement</span>
            </div>
          </motion.div>
        </div>

        {characterVideo && (
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.5 }}
            className={`absolute bottom-0 ${characterPosition === 'left' ? 'left-4' : 'right-4'} z-0 pointer-events-none hidden md:block`}
            style={{ height: '35%', maxHeight: '280px' }}>
            <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom"><source src={characterVideo} type="video/mp4" /></video>
          </motion.div>
        )}
      </div>
    );

    // ============================================
    // LIBRARY COMPONENT: BeforeAfter
    // ============================================
    const BeforeAfter = ({ headline, before, after, insight }) => {
      const CardSection = ({ type, title, items }) => {
        const isBefore = type === 'before';
        return (
          <motion.div initial={{ opacity: 0, x: isBefore ? -20 : 20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: isBefore ? 0.15 : 0.25 }}
            className={`rounded-xl p-5 ${isBefore ? 'bg-red-50 border-2 border-red-200' : 'bg-green-50 border-2 border-green-200'}`}>
            <div className="flex items-center gap-2 mb-4">
              <div className={`w-7 h-7 rounded-full flex items-center justify-center text-white ${isBefore ? 'bg-red-500' : 'bg-green-500'}`}>
                {isBefore ? <Icons.X /> : <Icons.Check />}
              </div>
              <span className={`font-bold text-sm ${isBefore ? 'text-red-700' : 'text-green-700'}`}>{title}</span>
            </div>
            <ul className="space-y-2">
              {items.map((item, i) => (
                <li key={i} className="text-neutral-700 text-sm leading-relaxed">{item}</li>
              ))}
            </ul>
          </motion.div>
        );
      };

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto slide-scroll overflow-y-auto py-8">
          <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-2" style={{ background: 'rgba(var(--accent-rgb), 0.1)', color: 'var(--accent)' }}>Real Example</span>
            <h2 className="slide-title text-xl md:text-2xl lg:text-3xl text-black">{headline}</h2>
          </motion.div>
          <div className="grid md:grid-cols-2 gap-4 mb-6">
            <CardSection type="before" title={before.title} items={before.items} />
            <CardSection type="after" title={after.title} items={after.items} />
          </div>
          <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }} className="bg-neutral-900 rounded-xl p-4">
            <p className="text-neutral-300 text-sm text-center flex items-center justify-center gap-2">
              <Icons.Zap /> {insight}
            </p>
          </motion.div>
        </div>
      );
    };

    // ============================================
    // LIBRARY COMPONENT: IconGrid
    // ============================================
    const IconGrid = ({ title, items, characterVideo, characterPosition }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto relative slide-scroll overflow-y-auto py-8">
        <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-6">{title}</motion.h2>
        <div className={`grid gap-4 ${items.length === 3 ? 'md:grid-cols-3' : 'md:grid-cols-2'}`}>
          {items.map((item, i) => (
            <motion.div key={i} initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 + i * 0.08 }}
              className="bg-white border-2 border-neutral-200 rounded-xl p-5 hover:border-neutral-300 transition-colors">
              <div className="w-10 h-10 rounded-lg flex items-center justify-center mb-3 text-white" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))' }}>
                {getIcon(item.icon)}
              </div>
              <h3 className="font-bold text-neutral-900 mb-2 text-base">{item.title}</h3>
              <p className="text-neutral-600 text-sm leading-relaxed">{item.description}</p>
            </motion.div>
          ))}
        </div>
        {characterVideo && (
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.5 }}
            className={`absolute bottom-0 ${characterPosition === 'left' ? 'left-4' : 'right-4'} z-0 pointer-events-none hidden md:block`}
            style={{ height: '35%', maxHeight: '280px' }}>
            <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom"><source src={characterVideo} type="video/mp4" /></video>
          </motion.div>
        )}
      </div>
    );

    // ============================================
    // FIXED TEMPLATES
    // ============================================
    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      useEffect(() => { onShowGif(welcomeData.gif, '65%', gifSide); return () => onHideGif(); }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg mb-3 max-w-lg" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center gap-1.5 text-neutral-400 text-xs mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-2xl p-5 mb-4 max-w-sm w-full">
              <p className="text-neutral-500 text-[11px] uppercase tracking-wider mb-3">In this lesson</p>
              <ul className="space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))' }}>{i + 1}</span>
                    <span className="text-neutral-300 text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-7 py-3 rounded-xl text-white font-semibold text-base" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))' }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-10">
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-4" style={{ background: 'rgba(var(--accent-rgb), 0.1)', color: 'var(--accent)' }}>The Hook</span>
            <h2 className="slide-title text-2xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-base md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
        </div>
      </div>
    );

    const ContentSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-8 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-10 relative">
        <motion.h2 initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl lg:text-4xl text-black mb-6">{data.title}</motion.h2>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-base md:text-lg text-neutral-600 leading-relaxed whitespace-pre-line">{data.body}</motion.div>
        {data.characterVideo && (
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4 }}
            className={`absolute bottom-0 ${data.characterPosition === 'left' ? 'left-6' : 'right-6'} z-0 pointer-events-none hidden md:block`}
            style={{ height: '35%', maxHeight: '280px' }}>
            <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom"><source src={data.characterVideo} type="video/mp4" /></video>
          </motion.div>
        )}
      </div>
    );

    const QuoteSlide = ({ data }) => (
      <div className="h-full flex items-center justify-center px-8 slide-scroll overflow-y-auto py-10">
        <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="bg-neutral-900 rounded-2xl p-8 md:p-12 max-w-xl text-center">
          <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} transition={{ delay: 0.15, type: 'spring' }} className="w-14 h-14 rounded-xl flex items-center justify-center mx-auto mb-8 text-white" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))' }}><Icons.Sparkles /></motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }} className="text-white text-xl md:text-2xl leading-relaxed mb-5">"{data.text}"</motion.p>
          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.4 }} style={{ color: 'var(--accent)' }} className="text-sm font-medium">{data.attribution}</motion.p>
        </motion.div>
      </div>
    );

    const QuizSlide = ({ data, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const celebrationGif = useMemo(() => getRandomCelebrationGif(), []);
      const empathyGif = useMemo(() => getRandomEmpathyGif(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      const handleSelect = (index) => { if (showFeedback) return; setSelected(index); setShowFeedback(true); };
      const isCorrect = selected === data.correctIndex;

      useEffect(() => { if (showFeedback) { onShowGif(isCorrect ? celebrationGif : empathyGif, '60%', gifSide); } }, [showFeedback, isCorrect, celebrationGif, empathyGif, gifSide, onShowGif]);
      useEffect(() => { return () => onHideGif(); }, [onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col justify-center px-8 md:px-12 max-w-2xl mx-auto slide-scroll overflow-y-auto py-10 relative z-30">
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
              <p className="text-xs uppercase tracking-wider text-neutral-400 mb-3">Quick Check</p>
              <h2 className="slide-title text-xl md:text-2xl text-black leading-tight">{data.question}</h2>
            </motion.div>
            <div className="space-y-3 mb-6">
              {data.options.map((option, i) => (
                <motion.button key={i} initial={{ opacity: 0, x: -15 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.08 + i * 0.06 }} onClick={() => handleSelect(i)} disabled={showFeedback}
                  className={`w-full p-4 rounded-xl text-left transition-all border-2 ${showFeedback ? i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-400 bg-red-50' : 'border-neutral-200 bg-white opacity-40' : 'border-neutral-200 bg-white hover:border-neutral-300'}`}>
                  <div className="flex items-center gap-3">
                    <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${showFeedback && i === data.correctIndex ? 'bg-green-500 text-white' : showFeedback && i === selected && !isCorrect ? 'bg-red-400 text-white' : 'bg-neutral-100 text-neutral-500'}`}>
                      {showFeedback && i === data.correctIndex ? <Icons.Check /> : showFeedback && i === selected && !isCorrect ? <Icons.X /> : String.fromCharCode(65 + i)}
                    </span>
                    <span className="text-neutral-700 text-sm">{option}</span>
                  </div>
                </motion.button>
              ))}
            </div>
            <AnimatePresence>
              {showFeedback && (
                <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className={`p-5 rounded-xl ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                  <p className={`text-sm leading-relaxed ${isCorrect ? 'text-green-800' : 'text-amber-800'}`}>{isCorrect ? data.feedback.correct : data.feedback.incorrect}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      );
    };

    const CompletionSlide = ({ data }) => (
      <div className="h-full flex flex-col items-center justify-center text-center px-8 slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'spring', duration: 0.5 }} className="w-16 h-16 rounded-xl flex items-center justify-center mb-4 text-white" style={{ background: 'linear-gradient(135deg, var(--accent), var(--accent-dark))', boxShadow: '0 6px 24px rgba(var(--accent-rgb), 0.35)' }}><Icons.Check /></motion.div>
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="slide-title text-2xl md:text-3xl text-black mb-3">Lesson Complete</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }} className="text-neutral-500 text-sm mb-5 max-w-md leading-relaxed">You now understand the invisible architecture that separates copy that sells from copy that fails. Build your pyramid from the foundation up.</motion.p>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }} className="bg-neutral-900 rounded-xl p-5 max-w-md w-full mb-4">
          <p className="text-neutral-500 text-xs uppercase tracking-wider mb-2">Up Next</p>
          <h3 className="text-white font-bold text-lg mb-1">{LESSON_CONFIG.nextLesson.title}</h3>
          <p className="text-neutral-400 text-xs">{LESSON_CONFIG.nextLesson.teaser}</p>
        </motion.div>
      </div>
    );

    // ============================================
    // MAIN APP
    // ============================================
    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(getInitialSlide());
      const [direction, setDirection] = useState(1);
      const userName = useMemo(() => getUserName(), []);
      const currentSlideRef = React.useRef(0);
      const [gifConfig, setGifConfig] = useState(null);
      const [isAnimating, setIsAnimating] = useState(false);

      const showGif = useCallback((url, height, side) => setGifConfig({ url, height, side }), []);
      const hideGif = useCallback(() => setGifConfig(null), []);

      React.useEffect(() => { currentSlideRef.current = currentSlide; }, [currentSlide]);

      useEffect(() => {
        window.parent.postMessage({ type: 'LESSON_SLIDE_UPDATE', totalSlides: slides.length, slideIndex: currentSlide, slideType: slides[currentSlide]?.type, lessonSlug: LESSON_CONFIG.id }, '*');
      }, [currentSlide]);

      const goToSlide = useCallback((newSlide) => {
        if (isAnimating || newSlide < 0 || newSlide >= slides.length) return;
        setIsAnimating(true);
        setDirection(newSlide > currentSlideRef.current ? 1 : -1);
        setCurrentSlide(newSlide);
      }, [isAnimating]);

      const nextSlide = useCallback(() => { if (currentSlideRef.current + 1 < slides.length) goToSlide(currentSlideRef.current + 1); }, [goToSlide]);
      const prevSlide = useCallback(() => { if (currentSlideRef.current - 1 >= 0) goToSlide(currentSlideRef.current - 1); }, [goToSlide]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [nextSlide, prevSlide]);

      const slideVariants = {
        enter: (dir) => ({ x: dir > 0 ? '100%' : '-100%', opacity: 0 }),
        center: { x: 0, opacity: 1 },
        exit: (dir) => ({ x: dir > 0 ? '-100%' : '100%', opacity: 0 })
      };

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={nextSlide} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'content': return <ContentSlide data={slide} />;
          case 'pyramid-visual': return <PyramidVisual characterVideo={slide.characterVideo} characterPosition={slide.characterPosition} />;
          case 'comparison-visual': return <ComparisonVisualSlide characterVideo={slide.characterVideo} characterPosition={slide.characterPosition} />;
          case 'before-after': return <BeforeAfter headline={slide.headline} before={slide.before} after={slide.after} insight={slide.insight} />;
          case 'icon-grid': return <IconGrid title={slide.title} items={slide.items} characterVideo={slide.characterVideo} characterPosition={slide.characterPosition} />;
          case 'quote': return <QuoteSlide data={slide} />;
          case 'quiz': return <QuizSlide data={slide} onShowGif={showGif} onHideGif={hideGif} />;
          case 'completion': return <CompletionSlide data={slide} />;
          default: return null;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction} onExitComplete={() => setIsAnimating(false)}>
              <motion.div key={currentSlide} custom={direction} variants={slideVariants} initial="enter" animate="center" exit="exit" transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
                <AdminSlideReportButton slideIndex={currentSlide} slideType={slides[currentSlide].type} />
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => goToSlide(i)} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gifConfig && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }}
                className={`absolute ${gifConfig.side === 'left' ? 'left-4 md:left-8' : 'right-4 md:right-8'} bottom-16 pointer-events-none`}
                style={{ zIndex: 50, height: gifConfig.height, maxHeight: '40%' }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom"><source src={gifConfig.url} type="video/mp4" /></video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    ReactDOM.render(<LessonApp />, document.getElementById('root'));
  </script>
</body>
</html>
