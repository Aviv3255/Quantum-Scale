<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feed Your Winners: The Easiest Win | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #f97316; --accent-dark: #ea580c; --accent-light: #fdba74; --accent-rgb: 249, 115, 22; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => { const params = new URLSearchParams(window.location.search); return params.get('userName') || 'Builder'; };
    const getInitialSlide = () => { const params = new URLSearchParams(window.location.search); const slide = params.get('slide'); return slide ? parseInt(slide, 10) : 0; };

    const LESSON_CONFIG = {
      id: 'google-budget-reallocation',
      title: 'Feed Your Winners: The Easiest Win',
      description: 'How to go from 2.8x to 5.1x ROAS by reallocating budget',
      accentColor: '#f97316',
      duration: '4 min',
      nextLesson: { id: 'google-brand-moat', title: 'Brand is the Ultimate Moat', teaser: 'Learn why brand is the barrier competitors can\'t copy.' }
    };

    // ============ ADMIN REPORTER SYSTEM ============
    // Per-slide bug reporting for admin users
    let __isAdmin = false;

    // Listen for admin status from parent
    window.addEventListener('message', function(e) {
      if (e.data?.type === 'ADMIN_STATUS') {
        __isAdmin = e.data.isAdmin;
      }
    });

    // Request admin status on load
    if (window.parent !== window) {
      window.parent.postMessage({ type: 'CHECK_ADMIN_STATUS' }, '*');
    }

    // Admin Report Button Component
    const AdminSlideReportButton = ({ slideIndex, slideType }) => {
      // TEMP: if (!__isAdmin) return null; // TODO: restore before going live

      const handleReport = (e) => {
        e.stopPropagation();
        e.preventDefault();
        if (window.parent !== window) {
          window.parent.postMessage({
            type: 'ADMIN_REPORT_REQUEST',
            slideIndex: slideIndex,
            slideType: slideType,
            lessonSlug: LESSON_CONFIG.id,
            elementId: slideType + '-' + slideIndex
          }, '*');
        }
      };

      return (
        <button
          onClick={handleReport}
          title={`Report issue on Slide ${slideIndex + 1} (${slideType})`}
          style={{
            position: 'absolute',
            top: '12px',
            right: '12px',
            width: '32px',
            height: '32px',
            borderRadius: '8px',
            backgroundColor: 'rgba(239, 68, 68, 0.9)',
            color: 'white',
            border: 'none',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            opacity: 0.6,
            transition: 'opacity 0.2s, transform 0.2s',
            boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
          }}
          onMouseEnter={(e) => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.transform = 'scale(1.1)'; }}
          onMouseLeave={(e) => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.transform = 'scale(1)'; }}
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/>
            <path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/>
            <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/>
            <path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/>
            <path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/>
            <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/>
            <path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/>
          </svg>
        </button>
      );
    };
    // ============ END ADMIN REPORTER SYSTEM ============


    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_playing_air_guitar_light_headbanging_rockstar__0702007e-9e84-4d9e-8f99-8ee23d0b65f8_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_the_running_man_dance_move_vintage_cool__25682b0f-cf4c-4e93-8dcb-6c3dac8135cd_0.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_standing_and_clapping_enthusiastically_mouth_o_992ac4fd-9a0e-4963-bbcc-a5271f25f4fd_3.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];

    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_covering_face_with_palm_facepalm_gesture_disap_211b0566-078f-4d42-9c41-547b14f5827c_0.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_looking_down_sadly_shoulders_slumped_disappoin_790d48bd-e49e-40ea-9979-d3e86fa3a422_2.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    const slides = [
      { type: 'welcome', learningGoals: ['Why spreading budget evenly is killing your ROAS', 'The fastest way to improve account performance without new campaigns', 'How to identify your winners and losers', 'Real example: Going from 2.8x to 5.1x ROAS through smart reallocation'] },
      { type: 'hook', headline: 'Most advertisers spread their budget evenly across campaigns. Campaign A gets $1,000. Campaign B gets $1,000. Campaign C gets $1,000. Seems fair, right? Wrong.', subtext: 'One of those campaigns is delivering 6x ROAS. Another is barely breaking even. By spreading budget evenly, you\'re literally throwing money away on losers while starving your winners.' },
      { type: 'content', title: 'The Biggest Mistake: Even Splits', body: 'It sounds simple, but it\'s one of the fastest ways to improve overall account performance.\n\nMost advertisers default to spreading their budget evenly:\n- 4 campaigns running\n- Each gets $1,000/month\n- "Fair" distribution\n\nBut here\'s the problem: Not all campaigns perform equally. Some are crushing it. Others are bleeding money. When you spread budget evenly, you\'re funding mediocrity.\n\nThe fix? Don\'t spread your budget evenly. Concentrate it where it works best.\n\nFeed your winners. Starve your losers.' },
      { type: 'mockup', title: 'Before vs After: Budget Reallocation', description: 'Same total budget. Massive difference in results. This is the power of feeding your winners.', mockupType: 'budget-reallocation' },
      { type: 'content', title: 'The Math That Changes Everything', body: 'Let\'s break down exactly what happens when you reallocate:\n\nBEFORE (Even Split):\nCampaign A: $1,000 budget → 1.5x ROAS → $1,500 revenue\nCampaign B: $1,000 budget → 2.0x ROAS → $2,000 revenue\nCampaign C: $1,000 budget → 1.8x ROAS → $1,800 revenue\nCampaign D: $1,000 budget → 6.0x ROAS → $6,000 revenue\n\nTotal: $4,000 spend → $11,200 revenue = 2.8x ROAS\n\nAFTER (Smart Reallocation):\nCampaign A: $500 budget → 1.5x ROAS → $750 revenue\nCampaign B: $500 budget → 2.0x ROAS → $1,000 revenue\nCampaign C: $500 budget → 1.8x ROAS → $900 revenue\nCampaign D: $2,500 budget → 6.0x ROAS → $15,000 revenue\n\nTotal: $4,000 spend → $17,650 revenue = 4.4x ROAS\n\nSame budget. 57% better ROAS. Just by feeding the winner.' },
      { type: 'content', title: 'How to Find Your Winners', body: 'Continuously audit your campaigns and feed your winners. Here\'s how:\n\n1. Pull Campaign Performance Data\nLook at the last 30 days. Which campaigns have the highest ROAS? Which have the lowest? Don\'t just look at spend - look at return.\n\n2. Identify Clear Winners and Losers\nWinners: ROAS significantly above account average\nLosers: ROAS below breakeven or dragging down average\n\n3. Reallocate Ruthlessly\nCut budget from losers (or pause them entirely). Triple budget on winners. Watch your account ROAS skyrocket.\n\n4. Repeat Monthly\nPerformance changes. What worked last month might not work this month. Continuously audit and reallocate.\n\nThis isn\'t a one-time fix. It\'s a monthly habit that compounds results over time.' },
      { type: 'quiz', question: 'Why is budget reallocation one of the fastest wins in Google Ads?', options: ['It creates new campaigns automatically', 'It concentrates budget on high-performing campaigns without needing new creative or testing', 'It lowers your cost per click', 'It improves Quality Score across all campaigns'], correctIndex: 1, feedback: { correct: 'Exactly! Budget reallocation is powerful because it requires zero new work - no new campaigns, no new creative, no testing. You simply move money from losers to winners. Campaign D was already delivering 6x ROAS. By giving it more budget, you get more of those 6x returns. It\'s the fastest way to improve account performance because you\'re leveraging what already works instead of trying to fix what doesn\'t.', incorrect: 'Not quite. The power of budget reallocation is that it concentrates money on what\'s already working. Campaign D is delivering 6x ROAS. Instead of giving it $1,000, you give it $2,500. Same campaign, same creative, same targeting - just more budget going to the proven winner. No new campaigns needed. No testing required. Just smart allocation of existing resources. This is why it\'s the fastest win - you\'re not building something new, you\'re scaling what already works.' }},
      { type: 'completion', sources: [{ name: 'Google Ads Budget Optimization', url: 'https://ads.google.com' }] }
    ];

    const Icons = {
      Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
    };

    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      useEffect(() => { onShowGif(welcomeData.gif, '65%', gifSide); return () => onHideGif(); }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-2 md:mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg lg:text-xl mb-2 md:mb-3 max-w-lg leading-relaxed" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center justify-center gap-1.5 text-neutral-400 text-[10px] md:text-xs mb-2 md:mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-xl md:rounded-2xl p-3 md:p-5 mb-3 md:mb-4 max-w-sm w-full mx-auto">
              <p className="text-neutral-500 text-[9px] md:text-[11px] uppercase tracking-wider mb-2 md:mb-3">In this lesson</p>
              <ul className="space-y-1.5 md:space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>{i + 1}</span>
                    <span className="text-neutral-300 text-[11px] md:text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-6 md:px-7 py-2.5 md:py-3 rounded-xl text-white font-semibold text-sm md:text-base" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8 md:py-10 relative z-10">
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="mb-4 md:mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3 md:mb-4" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>The Hook</span>
            <h2 className="slide-title text-2xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-base md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
        </div>
        {data.characterVideo && (
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3, duration: 0.6 }}
            className={`absolute bottom-0 ${data.characterPosition === 'left' ? 'left-6' : 'right-6'} z-0 pointer-events-none hidden md:block`}
            style={{ height: '52%', maxHeight: '400px' }}>
            <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom">
              <source src={data.characterVideo} type="video/mp4" />
            </video>
          </motion.div>
        )}
        {data.brandImage && (
          <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3, duration: 0.5 }}
            className="absolute bottom-0 right-0 z-0 pointer-events-none hidden md:block" style={{ height: '30%', maxHeight: '200px', marginRight: '80px', marginBottom: '5%' }}>
            <img src={data.brandImage} alt={data.brandName || ''} className="h-full w-auto object-contain" style={{ opacity: 1 }} />
          </motion.div>
        )}
      </div>
    );

    
    const ContentSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-8 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-10">
        <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl lg:text-4xl text-black mb-6">{data.title}</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-base md:text-lg text-neutral-600 leading-relaxed whitespace-pre-line">{data.body}</motion.p>
      
        {data.characterVideo && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.4, duration: 0.5 }}
            className={`absolute bottom-0 ${data.characterPosition === 'left' ? 'left-4' : 'right-4'} z-0 pointer-events-none`}
            style={{ height: '25%', maxHeight: '180px', marginBottom: '3%' }}>
            <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom">
              <source src={data.characterVideo} type="video/mp4" />
            </video>
          </motion.div>
        )}
      </div>
    );

    const MockupSlide = ({ data }) => {
      if (data.mockupType === 'budget-reallocation') {
        return (
          <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto slide-scroll overflow-y-auto py-8">
            <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-4">{data.title}</motion.h2>
            <motion.p initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-sm text-neutral-600 text-center mb-8 max-w-2xl mx-auto">{data.description}</motion.p>
            <div className="relative w-full max-w-4xl mx-auto">
              <svg viewBox="0 0 800 500" className="w-full">
                <defs>
                  <linearGradient id="orangeGradient" x1="0%" y1="100%" x2="0%" y2="0%">
                    <stop offset="0%" stopColor="#f97316" stopOpacity="0.8" />
                    <stop offset="100%" stopColor="#ea580c" stopOpacity="0.3" />
                  </linearGradient>
                  <linearGradient id="grayGradient" x1="0%" y1="100%" x2="0%" y2="0%">
                    <stop offset="0%" stopColor="#9ca3af" stopOpacity="0.6" />
                    <stop offset="100%" stopColor="#6b7280" stopOpacity="0.3" />
                  </linearGradient>
                </defs>

                {/* BEFORE Section */}
                <motion.g initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.2 }}>
                  <text x="200" y="40" fontSize="18" fontWeight="700" textAnchor="middle" fill="#1f2937">BEFORE: Even Split</text>
                  <text x="200" y="65" fontSize="14" textAnchor="middle" fill="#6b7280">Total ROAS: 2.8x</text>

                  {/* Campaign bars */}
                  {/* Campaign A */}
                  <rect x="50" y="350" width="60" height="60" fill="url(#grayGradient)" stroke="#9ca3af" strokeWidth="2" rx="4"/>
                  <text x="80" y="425" fontSize="11" fontWeight="600" textAnchor="middle" fill="#374151">A</text>
                  <text x="80" y="440" fontSize="9" textAnchor="middle" fill="#6b7280">$1k</text>
                  <text x="80" y="455" fontSize="9" textAnchor="middle" fill="#9ca3af">1.5x</text>

                  {/* Campaign B */}
                  <rect x="130" y="330" width="60" height="80" fill="url(#grayGradient)" stroke="#9ca3af" strokeWidth="2" rx="4"/>
                  <text x="160" y="425" fontSize="11" fontWeight="600" textAnchor="middle" fill="#374151">B</text>
                  <text x="160" y="440" fontSize="9" textAnchor="middle" fill="#6b7280">$1k</text>
                  <text x="160" y="455" fontSize="9" textAnchor="middle" fill="#9ca3af">2.0x</text>

                  {/* Campaign C */}
                  <rect x="210" y="340" width="60" height="70" fill="url(#grayGradient)" stroke="#9ca3af" strokeWidth="2" rx="4"/>
                  <text x="240" y="425" fontSize="11" fontWeight="600" textAnchor="middle" fill="#374151">C</text>
                  <text x="240" y="440" fontSize="9" textAnchor="middle" fill="#6b7280">$1k</text>
                  <text x="240" y="455" fontSize="9" textAnchor="middle" fill="#9ca3af">1.8x</text>

                  {/* Campaign D - The Winner */}
                  <rect x="290" y="200" width="60" height="210" fill="url(#orangeGradient)" stroke="#f97316" strokeWidth="2" rx="4"/>
                  <text x="320" y="425" fontSize="11" fontWeight="700" textAnchor="middle" fill="#7c2d12">D</text>
                  <text x="320" y="440" fontSize="9" textAnchor="middle" fill="#ea580c">$1k</text>
                  <text x="320" y="455" fontSize="9" fontWeight="700" textAnchor="middle" fill="#f97316">6.0x</text>

                  {/* Star on winner */}
                  <text x="320" y="180" fontSize="20" textAnchor="middle">⭐</text>

                  {/* Baseline */}
                  <line x1="40" y1="410" x2="360" y2="410" stroke="#d4d4d8" strokeWidth="2"/>
                </motion.g>

                {/* Divider */}
                <motion.line
                  initial={{ scaleY: 0 }}
                  animate={{ scaleY: 1 }}
                  transition={{ delay: 0.4 }}
                  x1="400" y1="80" x2="400" y2="470"
                  stroke="#d4d4d8"
                  strokeWidth="3"
                  strokeDasharray="8,8"
                  style={{ transformOrigin: 'center' }}
                />

                {/* AFTER Section */}
                <motion.g initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3 }}>
                  <text x="600" y="40" fontSize="18" fontWeight="700" textAnchor="middle" fill="#f97316">AFTER: Smart Reallocation</text>
                  <text x="600" y="65" fontSize="14" fontWeight="700" textAnchor="middle" fill="#15803d">Total ROAS: 4.4x</text>

                  {/* Campaign bars - smaller losers, bigger winner */}
                  {/* Campaign A - reduced */}
                  <rect x="450" y="380" width="60" height="30" fill="url(#grayGradient)" stroke="#9ca3af" strokeWidth="2" rx="4" opacity="0.5"/>
                  <text x="480" y="425" fontSize="11" fontWeight="600" textAnchor="middle" fill="#374151">A</text>
                  <text x="480" y="440" fontSize="9" textAnchor="middle" fill="#6b7280">$500</text>
                  <text x="480" y="455" fontSize="9" textAnchor="middle" fill="#9ca3af">1.5x</text>

                  {/* Campaign B - reduced */}
                  <rect x="530" y="370" width="60" height="40" fill="url(#grayGradient)" stroke="#9ca3af" strokeWidth="2" rx="4" opacity="0.5"/>
                  <text x="560" y="425" fontSize="11" fontWeight="600" textAnchor="middle" fill="#374151">B</text>
                  <text x="560" y="440" fontSize="9" textAnchor="middle" fill="#6b7280">$500</text>
                  <text x="560" y="455" fontSize="9" textAnchor="middle" fill="#9ca3af">2.0x</text>

                  {/* Campaign C - reduced */}
                  <rect x="610" y="375" width="60" height="35" fill="url(#grayGradient)" stroke="#9ca3af" strokeWidth="2" rx="4" opacity="0.5"/>
                  <text x="640" y="425" fontSize="11" fontWeight="600" textAnchor="middle" fill="#374151">C</text>
                  <text x="640" y="440" fontSize="9" textAnchor="middle" fill="#6b7280">$500</text>
                  <text x="640" y="455" fontSize="9" textAnchor="middle" fill="#9ca3af">1.8x</text>

                  {/* Campaign D - MASSIVE increase */}
                  <motion.rect
                    x="690"
                    y="100"
                    width="70"
                    height="310"
                    fill="url(#orangeGradient)"
                    stroke="#f97316"
                    strokeWidth="3"
                    rx="4"
                    initial={{ height: 0, y: 410 }}
                    animate={{ height: 310, y: 100 }}
                    transition={{ delay: 0.6, duration: 0.8, type: "spring" }}
                  />
                  <text x="725" y="425" fontSize="12" fontWeight="900" textAnchor="middle" fill="#7c2d12">D</text>
                  <text x="725" y="442" fontSize="10" fontWeight="700" textAnchor="middle" fill="#ea580c">$2,500</text>
                  <text x="725" y="458" fontSize="10" fontWeight="900" textAnchor="middle" fill="#f97316">6.0x</text>

                  {/* Multiple stars on winner */}
                  <text x="710" y="75" fontSize="24" textAnchor="middle">⭐</text>
                  <text x="740" y="75" fontSize="24" textAnchor="middle">⭐</text>
                  <text x="725" y="55" fontSize="24" textAnchor="middle">⭐</text>

                  {/* Baseline */}
                  <line x1="440" y1="410" x2="770" y2="410" stroke="#d4d4d8" strokeWidth="2"/>
                </motion.g>

                {/* Arrow showing improvement */}
                <motion.g
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  transition={{ delay: 1 }}
                >
                  <path d="M 380,100 L 420,100" stroke="#15803d" strokeWidth="3" markerEnd="url(#arrowhead)"/>
                  <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                      <polygon points="0 0, 10 5, 0 10" fill="#15803d"/>
                    </marker>
                  </defs>
                  <text x="400" y="90" fontSize="12" fontWeight="700" textAnchor="middle" fill="#15803d">+57% ROAS</text>
                </motion.g>

                {/* Bottom insight */}
                <motion.text
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  transition={{ delay: 1.2 }}
                  x="400" y="490" fontSize="13" textAnchor="middle" fill="#6b7280">
                  Same total budget ($4,000) - Just reallocated to the winner
                </motion.text>
              </svg>
            </div>
          </div>
        );
      }
    };

    const QuizSlide = ({ data, onAnswer, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [answered, setAnswered] = useState(false);
      const handleSelect = (index) => {
        if (answered) return;
        setSelected(index);
        setAnswered(true);
        const isCorrect = index === data.correctIndex;
        const gif = isCorrect ? getRandomCelebrationGif() : getRandomEmpathyGif();
        onShowGif(gif, '50%', 'center');
        setTimeout(() => onHideGif(), 3000);
        onAnswer(isCorrect);
      };

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8">
          <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>Knowledge Check</span>
            <h2 className="slide-title text-xl md:text-2xl text-black">{data.question}</h2>
          </motion.div>
          <div className="space-y-3 mb-6">
            {data.options.map((option, i) => (
              <motion.button key={i} initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 + i * 0.05 }} onClick={() => handleSelect(i)} disabled={answered} className={`w-full text-left p-4 rounded-xl border-2 transition-all ${answered ? (i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-500 bg-red-50' : 'border-neutral-200 bg-neutral-50') : 'border-neutral-200 bg-white hover:border-orange-300 hover:bg-orange-50'}`}>
                <div className="flex items-center gap-3">
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 ${answered ? (i === data.correctIndex ? 'bg-green-500' : i === selected ? 'bg-red-500' : 'bg-neutral-300') : 'bg-neutral-200'}`}>
                    {answered && i === data.correctIndex && <Icons.Check className="text-white" />}
                    {answered && i === selected && i !== data.correctIndex && <Icons.X className="text-white" />}
                  </div>
                  <span className="text-sm md:text-base text-neutral-700">{option}</span>
                </div>
              </motion.button>
            ))}
          </div>
          <AnimatePresence>
            {answered && (
              <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className={`rounded-xl p-4 ${selected === data.correctIndex ? 'bg-green-50 border-2 border-green-200' : 'bg-orange-50 border-2 border-orange-200'}`}>
                <p className="text-sm text-neutral-700 leading-relaxed">{selected === data.correctIndex ? data.feedback.correct : data.feedback.incorrect}</p>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    const CompletionSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center items-center text-center px-6 py-10">
        <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} transition={{ type: 'spring', duration: 0.6 }}>
          <div className="w-20 h-20 rounded-full flex items-center justify-center mb-4 mx-auto" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>
            <Icons.Check className="text-white" />
          </div>
        </motion.div>
        <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="slide-title text-3xl md:text-4xl text-black mb-3">Lesson Complete!</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3 }} className="text-neutral-600 text-base md:text-lg mb-6 max-w-md">You now know how to dramatically improve ROAS by feeding your winners and starving your losers.</motion.p>
        {data.sources && data.sources.length > 0 && (
          <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.4 }} className="bg-neutral-50 rounded-xl p-4 max-w-md w-full mb-6">
            <p className="text-xs uppercase tracking-wider text-neutral-400 mb-2">Sources</p>
            {data.sources.map((source, i) => (
              <a key={i} href={source.url} target="_blank" rel="noopener noreferrer" className="text-sm hover:underline block mb-1" style={{ color: 'var(--accent)' }}>{source.name}</a>
            ))}
          </motion.div>
        )}
        <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.5 }} onClick={() => window.location.href = '/dashboard'} className="px-6 py-3 rounded-xl text-white font-semibold" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Back to Dashboard</motion.button>
      </div>
    );

    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(getInitialSlide());
      const [direction, setDirection] = useState(1);
      const userName = useMemo(() => getUserName(), []);
      const currentSlideRef = React.useRef(0);
      const [gifConfig, setGifConfig] = useState(null);
      const [isAnimating, setIsAnimating] = useState(false);

      const showGif = useCallback((url, height, side) => setGifConfig({ url, height, side }), []);
      const hideGif = useCallback(() => setGifConfig(null), []);

      React.useEffect(() => { currentSlideRef.current = currentSlide; }, [currentSlide]);

      // Send slide update to parent for admin issue tracking
      useEffect(() => {
        window.parent.postMessage({
          type: 'LESSON_SLIDE_UPDATE',
          slideIndex: currentSlide,
          slideType: slides[currentSlide]?.type,
          lessonSlug: LESSON_CONFIG.id
        }, '*');
      }, [currentSlide]);

      const goToSlide = useCallback((newSlide) => {
        if (isAnimating || newSlide < 0 || newSlide >= slides.length) return;
        setIsAnimating(true);
        setDirection(newSlide > currentSlideRef.current ? 1 : -1);
        setCurrentSlide(newSlide);
      }, [isAnimating]);

      const nextSlide = useCallback(() => { if (currentSlideRef.current + 1 < slides.length) goToSlide(currentSlideRef.current + 1); }, [goToSlide]);
      const prevSlide = useCallback(() => { if (currentSlideRef.current - 1 >= 0) goToSlide(currentSlideRef.current - 1); }, [goToSlide]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [nextSlide, prevSlide]);

      const slideVariants = {
        enter: (dir) => ({ x: dir > 0 ? '100%' : '-100%', opacity: 0 }),
        center: { x: 0, opacity: 1 },
        exit: (dir) => ({ x: dir > 0 ? '-100%' : '100%', opacity: 0 })
      };

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={nextSlide} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'content': return <ContentSlide data={slide} />;
          case 'mockup': return <MockupSlide data={slide} />;
          case 'quiz': return <QuizSlide data={slide} onShowGif={showGif} onHideGif={hideGif} />;
          case 'completion': return <CompletionSlide data={slide} />;
          default: return <ContentSlide data={slide} />;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction} onExitComplete={() => setIsAnimating(false)}>
              <motion.div key={currentSlide} custom={direction} variants={slideVariants} initial="enter" animate="center" exit="exit" transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
                <AdminSlideReportButton slideIndex={currentSlide} slideType={slides[currentSlide].type} />
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => goToSlide(i)} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gifConfig && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }} className={`absolute ${gifConfig.side === 'left' ? 'left-4 md:left-8' : 'right-4 md:right-8'} bottom-0 pointer-events-none`} style={{ zIndex: 15, height: gifConfig.height }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom" style={{ background: 'transparent', border: 'none', boxShadow: 'none' }}>
                  <source src={gifConfig.url} type="video/mp4" />
                </video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<LessonApp />);
  </script>
</body>
</html>
