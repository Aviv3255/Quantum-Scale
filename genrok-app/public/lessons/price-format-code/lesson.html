<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Price Format Code | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #f59e0b;
      --accent-dark: #d97706;
      --accent-light: #fbbf24;
      --accent-rgb: 245, 158, 11;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => {
      const params = new URLSearchParams(window.location.search);
      return params.get('userName') || 'Builder';
    };

    const LESSON_CONFIG = {
      id: 'price-format-code',
      title: 'The Price Format Code',
      description: 'How you FORMAT your price changes how it\'s perceived.',
      accentColor: '#f59e0b',
      duration: '6 min',
      nextLesson: {
        id: 'conversion-psychology',
        title: 'Conversion Psychology Mastery',
        teaser: 'More psychological triggers that turn browsers into buyers.'
      }
    };

    // ============ ELITE CONFIGURATION ARRAYS ============

    const PRICE_FORMATS = [
      { format: '$12.00', label: 'Full Format', result: 'Worst', perception: 'Payment pain emphasized', color: '#ef4444', icon: 'X' },
      { format: 'Twelve Dollars', label: 'Written Out', result: 'Second', perception: 'Less transactional', color: '#f59e0b', icon: 'Minus' },
      { format: '12', label: 'Simple Numeral', result: 'Best', perception: 'Minimal friction', color: '#10b981', icon: 'Check' }
    ];

    const FORMAT_RULES = [
      { category: 'Everyday Items', format: '12', example: 'Supplements, consumables', icon: 'ShoppingCart', color: '#10b981', desc: 'No symbol, no decimals. Feels lighter, casual.' },
      { category: 'Deals & Bargains', format: '$39', example: 'Fashion, accessories', icon: 'Tag', color: '#f59e0b', desc: 'Charm pricing signals value. "9" triggers bargain psychology.' },
      { category: 'Luxury Products', format: '$250', example: 'Premium goods, tech', icon: 'Diamond', color: '#8b5cf6', desc: 'Rounded = confidence. No gimmicks, worth it.' }
    ];

    const CHARM_PRICING_DATA = {
      prices: [
        { price: '$34', sales: 38, color: '#ef4444' },
        { price: '$39', sales: 52, color: '#10b981' },
        { price: '$44', sales: 35, color: '#f59e0b' }
      ],
      winner: '$39'
    };

    const LUXURY_COMPARISON = {
      wrong: { price: '$1,499.99', perception: 'Discount hunting', trust: 23, problems: ['Undermines premium', 'Signals price competition', 'Cognitive dissonance'] },
      right: { price: '$1,500', perception: 'Confident, honest', trust: 87, benefits: ['No gimmicks', 'Worth exactly this', 'Respects luxury buyers'] }
    };

    const IMPACT_STATS = [
      { value: 14, suffix: '%', label: 'Conversion Increase', subtext: 'Simple numerals vs $XX.00' },
      { value: 23, suffix: '%', label: 'Sales Volume', subtext: 'Charm pricing boost' },
      { value: 30, suffix: '%', label: 'Format Swing', subtext: 'Matched vs mismatched' }
    ];

    // ============ ADMIN REPORTER SYSTEM ============
    let __isAdmin = false;
    window.addEventListener('message', function(e) {
      if (e.data?.type === 'ADMIN_STATUS') __isAdmin = e.data.isAdmin;
    });
    if (window.parent !== window) window.parent.postMessage({ type: 'CHECK_ADMIN_STATUS' }, '*');

    const AdminSlideReportButton = ({ slideIndex, slideType }) => {
      const handleReport = (e) => {
        e.stopPropagation();
        e.preventDefault();
        if (window.parent !== window) {
          window.parent.postMessage({
            type: 'ADMIN_REPORT_REQUEST',
            slideIndex: slideIndex,
            slideType: slideType,
            lessonSlug: LESSON_CONFIG.id,
            elementId: slideType + '-' + slideIndex
          }, '*');
        }
      };

      return (
        <button onClick={handleReport} title={`Report issue on Slide ${slideIndex + 1} (${slideType})`}
          style={{ position: 'absolute', top: '12px', right: '12px', width: '32px', height: '32px', borderRadius: '8px',
            backgroundColor: 'rgba(239, 68, 68, 0.9)', color: 'white', border: 'none', cursor: 'pointer',
            display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, opacity: 0.6,
            transition: 'opacity 0.2s, transform 0.2s', boxShadow: '0 2px 8px rgba(0,0,0,0.15)' }}
          onMouseEnter={(e) => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.transform = 'scale(1.1)'; }}
          onMouseLeave={(e) => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.transform = 'scale(1)'; }}>
          <img src="https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/bug-icon.svg"
            width="16" height="16" alt="Report" style={{ filter: 'invert(1)' }}
            onError={(e) => { e.target.style.display = 'none'; e.target.parentNode.innerHTML = 'ðŸ›'; }} />
        </button>
      );
    };
    // ============ END ADMIN REPORTER SYSTEM ============

    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];

    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    // ============ ICONS ============
    const Icons = {
      Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      Minus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      Zap: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
      ShoppingCart: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>,
      Tag: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
      Diamond: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0Z"/></svg>,
      DollarSign: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
      TrendingUp: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
      Target: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
      Lightbulb: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
      Brain: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-1.54"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-1.54"/></svg>,
      Crown: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>,
      Shield: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
      AlertCircle: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
    };

    const IconComponents = {
      ShoppingCart: Icons.ShoppingCart,
      Tag: Icons.Tag,
      Diamond: Icons.Diamond,
      DollarSign: Icons.DollarSign,
      TrendingUp: Icons.TrendingUp,
      Target: Icons.Target,
      Lightbulb: Icons.Lightbulb,
      Brain: Icons.Brain,
      Crown: Icons.Crown,
      Shield: Icons.Shield,
      AlertCircle: Icons.AlertCircle,
      Check: Icons.Check,
      X: Icons.X,
      Minus: Icons.Minus
    };

    // ============ ANIMATED COUNTER ============
    const AnimatedCounter = ({ value, suffix = '', prefix = '', duration = 2000 }) => {
      const [count, setCount] = useState(0);
      useEffect(() => {
        let start = 0;
        const end = parseInt(value);
        if (start === end) return;
        const timer = setInterval(() => {
          start += Math.ceil(end / (duration / 50));
          if (start >= end) { setCount(end); clearInterval(timer); }
          else { setCount(start); }
        }, 50);
        return () => clearInterval(timer);
      }, [value, duration]);
      return <span>{prefix}{count}{suffix}</span>;
    };

    // ============ SLIDES DATA ============
    const slides = [
      { type: 'welcome', learningGoals: [
        'The 3 price formats and when to use each one',
        'How Cornell study proved simple numerals reduce payment pain',
        'MIT research on charm pricing and the psychology of $39 vs $34'
      ]},
      { type: 'hook', headline: '$12.00 vs 12 vs $12. Same price. Wildly different results.', subtext: 'A Cornell study tested the exact same menu items at three different price formats. "$12.00" performed the worst. "Twelve dollars" came in second. But "12" - just the numeral, no dollar sign, no decimals - outsold both significantly. The price didn\'t change. The FORMAT did. And format changes perception.', brandImage: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/Visa_Inc._logo.svg.png', brandName: 'Visa' },
      { type: 'price-format-battle' },
      { type: 'content', title: 'Price Format Psychology', body: 'Your brain processes price formats differently based on context and product category. The FORMAT you choose signals whether you\'re selling everyday items, deals, or luxury goods. Get it right, and customers buy easier. Get it wrong, and you create friction where none should exist.' },
      { type: 'three-format-rules' },
      { type: 'content', title: 'Rule 1: Everyday Purchases', body: 'For supplements, consumables, routine purchases - use simple numerals. No dollar signs. No decimals. Just "19" instead of "$19.00". Why? The dollar sign triggers loss aversion. Decimals emphasize exactness of payment. Simple numerals feel lighter, easier, more casual. Less friction = more conversions.' },
      { type: 'example', scenario: 'Supplement Store', before: { label: 'High Friction Format', text: 'Daily Vitamins: $19.00 per bottle' }, after: { label: 'Low Friction Format', text: 'Daily Vitamins: 19 per bottle' }, insight: 'Conversion rate increased 14%. Customers perceived the purchase as smaller and more casual.' },
      { type: 'charm-pricing-study' },
      { type: 'content', title: 'Rule 2: Charm Pricing for Deals', body: 'MIT and University of Chicago tested identical garments at $34, $39, and $44. The $39 version outsold $34 despite being MORE expensive. Why? The "9" ending signals a deal. It triggers bargain-hunter psychology. Use this for fashion, accessories, anything where customers are comparison shopping.' },
      { type: 'example', scenario: 'Fashion Accessories Store', before: { label: 'Rounded Pricing', text: 'Handbag Collection: $50, $75, $100' }, after: { label: 'Charm Pricing', text: 'Handbag Collection: $49, $79, $99' }, insight: 'Sales volume increased 23%. Customers perceived items as better deals.' },
      { type: 'luxury-psychology' },
      { type: 'content', title: 'Rule 3: Luxury = Rounded Numbers', body: 'Premium watch at $1,499.99? The ".99" signals discount hunting. Luxury buyers see through it. Creates cognitive dissonance - "Is this actually premium?" But $1,500? Clean, confident, no gimmicks. Signals "This is worth exactly this much, maybe more." Aligns with premium positioning. Luxury buyers respect the honesty.' },
      { type: 'example', scenario: 'Premium Watch Store', before: { label: 'Charm Pricing (Wrong)', text: 'Luxury Timepiece: $1,499.99 - undermines premium positioning' }, after: { label: 'Rounded Pricing (Right)', text: 'Luxury Timepiece: $1,500 - signals confidence and quality' }, insight: 'Perceived value increased. Buyers reported higher satisfaction.' },
      { type: 'impact-stats' },
      { type: 'elite-insight' },
      { type: 'quiz', question: 'Why did the garment priced at $39 outsell the same garment at $34 in the MIT study?', options: ['$39 is actually a more attractive number visually', 'The "9" ending signals a deal and triggers bargain-hunter psychology', 'Customers assumed $39 was higher quality', 'The study was conducted in a region where $39 is lucky'], correctIndex: 1, feedback: { correct: 'Exactly! Charm pricing (ending in 9) triggers deal-seeking psychology. Even at a higher price, $39 FELT like a better bargain than $34 because the format signaled "discounted from something higher."', incorrect: 'Not quite. The power is in psychological signaling. The "9" ending makes the brain think "This was discounted" even when it wasn\'t. It triggers bargain-hunting instincts that rounded numbers don\'t activate.' }},
      { type: 'completion' }
    ];

    // ============ SLIDE COMPONENTS ============

    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);

      useEffect(() => {
        onShowGif(welcomeData.gif, '65%', gifSide);
        return () => onHideGif();
      }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-2 md:mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg lg:text-xl mb-2 md:mb-3 max-w-lg leading-relaxed" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center justify-center gap-1.5 text-neutral-400 text-[10px] md:text-xs mb-2 md:mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-xl md:rounded-2xl p-3 md:p-5 mb-3 md:mb-4 max-w-sm w-full mx-auto">
              <p className="text-neutral-500 text-[9px] md:text-[11px] uppercase tracking-wider mb-2 md:mb-3">In this lesson</p>
              <ul className="space-y-1.5 md:space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>{i + 1}</span>
                    <span className="text-neutral-300 text-[11px] md:text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-6 md:px-7 py-2.5 md:py-3 rounded-xl text-white font-semibold text-sm md:text-base" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8 md:py-10 relative z-10">
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="mb-4 md:mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3 md:mb-4" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>The Hook</span>
            <h2 className="slide-title text-2xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-base md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
        </div>
        {data.brandImage && (
          <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3, duration: 0.5 }}
            className="absolute bottom-0 right-0 z-0 pointer-events-none hidden md:block" style={{ height: '30%', maxHeight: '200px', marginRight: '80px', marginBottom: '5%' }}>
            <img src={data.brandImage} alt={data.brandName || ''} className="h-full w-auto object-contain" style={{ opacity: 1 }} />
          </motion.div>
        )}
      </div>
    );

    const ContentSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-8 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-10">
        <motion.h2 initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl lg:text-4xl text-black mb-6 relative z-10">{data.title}</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-base md:text-lg text-neutral-600 leading-relaxed relative z-10">{data.body}</motion.p>
      </div>
    );

    // ============ CUSTOM ELITE SLIDES ============

    // Price Format Battle: $12.00 vs 12 vs $12 with auto-cycling
    const PriceFormatBattleSlide = () => {
      const [activeFormat, setActiveFormat] = useState(2);

      useEffect(() => {
        const timer = setInterval(() => {
          setActiveFormat(prev => (prev + 1) % PRICE_FORMATS.length);
        }, 2500);
        return () => clearInterval(timer);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-2">
            The Cornell Menu Study
          </motion.h2>
          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.1 }} className="text-neutral-500 text-center mb-8">
            Same price, three formats, wildly different results
          </motion.p>

          <div className="grid md:grid-cols-3 gap-4">
            {PRICE_FORMATS.map((format, i) => {
              const IconComponent = IconComponents[format.icon];
              return (
                <motion.div key={i}
                  initial={{ opacity: 0, y: 30 }}
                  animate={{ opacity: 1, y: 0, scale: i === activeFormat ? 1.05 : 1 }}
                  transition={{ delay: 0.1 + i * 0.1 }}
                  style={{
                    background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
                    borderRadius: '16px',
                    padding: '24px',
                    border: i === activeFormat ? `2px solid ${format.color}` : '1px solid rgba(255,255,255,0.1)',
                    boxShadow: i === activeFormat ? `0 0 30px ${format.color}20` : 'none'
                  }}>
                  <div style={{ height: '4px', background: `linear-gradient(90deg, transparent, ${format.color}, transparent)`, marginBottom: '20px', borderRadius: '2px' }} />

                  <div className="text-center">
                    <div className="text-4xl md:text-5xl font-bold text-white mb-3">{format.format}</div>
                    <p className="text-neutral-400 text-sm mb-4">{format.label}</p>

                    <div className="flex items-center justify-center gap-2 mb-3">
                      <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ background: format.color }}>
                        {IconComponent && <IconComponent />}
                      </div>
                      <span className="font-bold text-lg" style={{ color: format.color }}>{format.result}</span>
                    </div>

                    <p className="text-neutral-300 text-xs">{format.perception}</p>
                  </div>

                  {i === 2 && (
                    <div className="absolute -top-2 -right-2 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded-lg">
                      WINNER
                    </div>
                  )}
                </motion.div>
              );
            })}
          </div>
        </div>
      );
    };

    // Three Format Rules: Category grid with icons
    const ThreeFormatRulesSlide = () => {
      const [activeRule, setActiveRule] = useState(0);

      useEffect(() => {
        const timer = setInterval(() => {
          setActiveRule(prev => (prev + 1) % FORMAT_RULES.length);
        }, 3000);
        return () => clearInterval(timer);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">
            The 3 Price Format Rules
          </motion.h2>

          <div className="grid md:grid-cols-3 gap-4">
            {FORMAT_RULES.map((rule, i) => {
              const IconComponent = IconComponents[rule.icon];
              return (
                <motion.div key={i}
                  initial={{ opacity: 0, y: 30 }}
                  animate={{ opacity: 1, y: 0, scale: i === activeRule ? 1.03 : 1 }}
                  transition={{ delay: 0.1 + i * 0.1 }}
                  style={{
                    background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
                    borderRadius: '16px',
                    padding: '24px',
                    border: i === activeRule ? `2px solid ${rule.color}` : '1px solid rgba(255,255,255,0.1)',
                    boxShadow: i === activeRule ? `0 0 30px ${rule.color}20` : 'none'
                  }}>
                  <div style={{ height: '3px', background: `linear-gradient(90deg, transparent, ${rule.color}, transparent)`, marginBottom: '16px', borderRadius: '2px' }} />

                  <div className="flex items-center gap-3 mb-4">
                    <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ background: `${rule.color}20`, color: rule.color }}>
                      {IconComponent && <IconComponent />}
                    </div>
                    <div>
                      <h3 className="text-white font-bold text-sm">{rule.category}</h3>
                      <div className="text-2xl font-bold" style={{ color: rule.color }}>{rule.format}</div>
                    </div>
                  </div>

                  <p className="text-neutral-400 text-xs mb-2">{rule.example}</p>
                  <p className="text-neutral-300 text-sm leading-relaxed">{rule.desc}</p>
                </motion.div>
              );
            })}
          </div>
        </div>
      );
    };

    // Charm Pricing Study: $34 vs $39 vs $44 with bars
    const CharmPricingStudySlide = () => {
      const [showBars, setShowBars] = useState(false);

      useEffect(() => {
        const timer = setTimeout(() => setShowBars(true), 500);
        return () => clearTimeout(timer);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-2">
            The MIT Charm Pricing Study
          </motion.h2>
          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.1 }} className="text-neutral-500 text-center mb-8">
            Same garment, three prices - which won?
          </motion.p>

          <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }}
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '20px', padding: '32px' }}>
            <div style={{ height: '4px', background: 'linear-gradient(90deg, transparent, #f59e0b, transparent)', marginBottom: '24px', borderRadius: '2px' }} />

            <div className="space-y-6">
              {CHARM_PRICING_DATA.prices.map((item, i) => (
                <div key={i} className="flex items-center gap-4">
                  <div className="w-20 text-right">
                    <span className="text-2xl font-bold" style={{ color: item.color }}>{item.price}</span>
                  </div>
                  <div className="flex-1 h-10 rounded-lg overflow-hidden" style={{ background: 'rgba(255,255,255,0.1)' }}>
                    <motion.div
                      initial={{ width: 0 }}
                      animate={{ width: showBars ? `${item.sales}%` : 0 }}
                      transition={{ duration: 1, delay: i * 0.2 }}
                      className="h-full rounded-lg flex items-center justify-end px-3"
                      style={{ background: `linear-gradient(90deg, ${item.color}80, ${item.color})` }}>
                      <span className="text-white font-bold text-sm">{item.sales}%</span>
                    </motion.div>
                  </div>
                  {item.price === CHARM_PRICING_DATA.winner && (
                    <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }} transition={{ delay: 1.5 }}
                      className="bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                      WINNER
                    </motion.div>
                  )}
                </div>
              ))}
            </div>

            <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 2 }}
              className="text-center text-neutral-300 text-sm mt-6 pt-4 border-t border-neutral-700">
              $39 outsold $34 despite being <span className="text-amber-400 font-bold">MORE expensive</span>. The "9" ending signals a deal.
            </motion.p>
          </motion.div>
        </div>
      );
    };

    // Luxury Psychology: Rounded vs Charm with trust meters
    const LuxuryPsychologySlide = () => {
      const [showMeters, setShowMeters] = useState(false);

      useEffect(() => {
        const timer = setTimeout(() => setShowMeters(true), 500);
        return () => clearTimeout(timer);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">
            Luxury Pricing Psychology
          </motion.h2>

          <div className="grid md:grid-cols-2 gap-6">
            {/* Wrong Way */}
            <motion.div initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 }}
              style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '16px', padding: '24px', border: '2px solid #ef4444' }}>
              <div style={{ height: '4px', background: 'linear-gradient(90deg, transparent, #ef4444, transparent)', marginBottom: '20px', borderRadius: '2px' }} />

              <div className="flex items-center gap-2 mb-4">
                <div className="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center text-white"><Icons.X /></div>
                <span className="text-red-400 font-bold">WRONG</span>
              </div>

              <div className="text-4xl font-bold text-white mb-2">{LUXURY_COMPARISON.wrong.price}</div>
              <p className="text-neutral-400 text-sm mb-4">{LUXURY_COMPARISON.wrong.perception}</p>

              <div className="mb-4">
                <div className="flex justify-between text-xs text-neutral-400 mb-1">
                  <span>Trust Level</span>
                  <span>{LUXURY_COMPARISON.wrong.trust}%</span>
                </div>
                <div className="h-3 rounded-full overflow-hidden" style={{ background: 'rgba(255,255,255,0.1)' }}>
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: showMeters ? `${LUXURY_COMPARISON.wrong.trust}%` : 0 }}
                    transition={{ duration: 1 }}
                    className="h-full rounded-full bg-red-500" />
                </div>
              </div>

              <ul className="space-y-1">
                {LUXURY_COMPARISON.wrong.problems.map((p, i) => (
                  <li key={i} className="flex items-center gap-2 text-xs text-neutral-400">
                    <Icons.AlertCircle />
                    <span>{p}</span>
                  </li>
                ))}
              </ul>
            </motion.div>

            {/* Right Way */}
            <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.2 }}
              style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', borderRadius: '16px', padding: '24px', border: '2px solid #10b981' }}>
              <div style={{ height: '4px', background: 'linear-gradient(90deg, transparent, #10b981, transparent)', marginBottom: '20px', borderRadius: '2px' }} />

              <div className="flex items-center gap-2 mb-4">
                <div className="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white"><Icons.Check /></div>
                <span className="text-green-400 font-bold">RIGHT</span>
              </div>

              <div className="text-4xl font-bold text-white mb-2">{LUXURY_COMPARISON.right.price}</div>
              <p className="text-neutral-400 text-sm mb-4">{LUXURY_COMPARISON.right.perception}</p>

              <div className="mb-4">
                <div className="flex justify-between text-xs text-neutral-400 mb-1">
                  <span>Trust Level</span>
                  <span>{LUXURY_COMPARISON.right.trust}%</span>
                </div>
                <div className="h-3 rounded-full overflow-hidden" style={{ background: 'rgba(255,255,255,0.1)' }}>
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: showMeters ? `${LUXURY_COMPARISON.right.trust}%` : 0 }}
                    transition={{ duration: 1, delay: 0.3 }}
                    className="h-full rounded-full bg-green-500" />
                </div>
              </div>

              <ul className="space-y-1">
                {LUXURY_COMPARISON.right.benefits.map((b, i) => (
                  <li key={i} className="flex items-center gap-2 text-xs text-green-400">
                    <Icons.Check />
                    <span>{b}</span>
                  </li>
                ))}
              </ul>
            </motion.div>
          </div>
        </div>
      );
    };

    // Impact Stats: AnimatedCounter
    const ImpactStatsSlide = () => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">
          The Format Effect
        </motion.h2>

        <div className="grid md:grid-cols-3 gap-6">
          {IMPACT_STATS.map((stat, i) => (
            <motion.div key={i}
              initial={{ opacity: 0, y: 30 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.1 + i * 0.15 }}
              style={{
                background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
                borderRadius: '16px',
                padding: '32px',
                textAlign: 'center'
              }}>
              <div style={{ height: '4px', background: 'linear-gradient(90deg, transparent, #f59e0b, transparent)', marginBottom: '24px', borderRadius: '2px' }} />

              <div className="text-5xl md:text-6xl font-bold mb-3" style={{ color: '#f59e0b' }}>
                <AnimatedCounter value={stat.value} suffix={stat.suffix} />
              </div>
              <p className="text-white font-semibold mb-1">{stat.label}</p>
              <p className="text-neutral-400 text-sm">{stat.subtext}</p>
            </motion.div>
          ))}
        </div>
      </div>
    );

    // Elite Insight
    const EliteInsightSlide = () => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-3xl mx-auto py-8">
        <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }}
          style={{
            background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
            borderRadius: '24px',
            padding: '40px',
            border: '1px solid rgba(245, 158, 11, 0.3)',
            boxShadow: '0 0 60px rgba(245, 158, 11, 0.1)'
          }}>
          <div style={{ height: '4px', background: 'linear-gradient(90deg, transparent, #f59e0b, transparent)', marginBottom: '32px', borderRadius: '2px' }} />

          <div className="flex items-center justify-center gap-3 mb-6">
            <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ background: 'rgba(245, 158, 11, 0.2)' }}>
              <Icons.Lightbulb />
            </div>
            <span className="text-amber-400 text-xs font-bold uppercase tracking-wider">Elite Insight</span>
          </div>

          <h3 className="slide-title text-2xl md:text-3xl text-white text-center mb-6">
            "The Format Paradox"
          </h3>

          <p className="text-neutral-300 text-center text-lg leading-relaxed mb-6">
            The price hasn't changed - only your customer's perception of it. Format is invisible psychology.
            Most stores get this wrong because they apply one format everywhere. But Everyday, Deals, and Luxury
            require different codes. Master the format code, and you change what customers feel about your prices
            without changing the prices themselves.
          </p>

          <div className="flex items-center justify-center gap-2 text-amber-400">
            <Icons.Target />
            <span className="font-semibold">Match the format to the category. Always.</span>
          </div>
        </motion.div>
      </div>
    );

    // ============ STANDARD SLIDES ============

    const ExampleSlide = ({ data }) => (
      <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
          <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-2" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>Real Example</span>
          <h2 className="slide-title text-xl md:text-2xl text-black">{data.scenario}</h2>
        </motion.div>
        <div className="grid md:grid-cols-2 gap-4 mb-6">
          <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 }}
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', border: '2px solid #dc2626', borderRadius: '16px', padding: '20px' }}>
            <div style={{ height: '3px', background: 'linear-gradient(90deg, transparent, #dc2626, transparent)', marginBottom: '16px', borderRadius: '2px' }} />
            <div className="flex items-center gap-2 mb-3">
              <div className="w-6 h-6 rounded-full bg-red-500 flex items-center justify-center text-white"><Icons.X /></div>
              <span className="font-semibold text-red-400 text-sm">{data.before.label}</span>
            </div>
            <p className="text-neutral-300 text-sm leading-relaxed">{data.before.text}</p>
          </motion.div>
          <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.2 }}
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)', border: '2px solid #10b981', borderRadius: '16px', padding: '20px' }}>
            <div style={{ height: '3px', background: 'linear-gradient(90deg, transparent, #10b981, transparent)', marginBottom: '16px', borderRadius: '2px' }} />
            <div className="flex items-center gap-2 mb-3">
              <div className="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-white"><Icons.Check /></div>
              <span className="font-semibold text-emerald-400 text-sm">{data.after.label}</span>
            </div>
            <p className="text-neutral-300 text-sm leading-relaxed">{data.after.text}</p>
          </motion.div>
        </div>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3 }}
          className="p-4 text-center rounded-xl" style={{ background: 'rgba(245, 158, 11, 0.1)' }}>
          <p className="text-amber-700 text-sm font-medium"><Icons.Zap className="inline mr-2" />{data.insight}</p>
        </motion.div>
      </div>
    );

    const QuizSlide = ({ data, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const celebrationGif = useMemo(() => getRandomCelebrationGif(), []);
      const empathyGif = useMemo(() => getRandomEmpathyGif(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      const handleSelect = (index) => { if (showFeedback) return; setSelected(index); setShowFeedback(true); };
      const isCorrect = selected === data.correctIndex;

      useEffect(() => {
        if (showFeedback) {
          if (isCorrect) { onShowGif(celebrationGif, '60%', gifSide); } else { onShowGif(empathyGif, '60%', gifSide); }
        }
      }, [showFeedback, isCorrect, celebrationGif, empathyGif, gifSide, onShowGif]);

      useEffect(() => { return () => onHideGif(); }, [onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col justify-center px-8 md:px-12 max-w-2xl mx-auto slide-scroll overflow-y-auto py-10 relative z-30">
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
              <p className="text-xs uppercase tracking-wider text-neutral-400 mb-3">Quick Check</p>
              <h2 className="slide-title text-xl md:text-2xl text-black leading-tight">{data.question}</h2>
            </motion.div>
            <div className="space-y-3 mb-6">
              {data.options.map((option, i) => (
                <motion.button key={i} initial={{ opacity: 0, x: -15 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.08 + i * 0.06 }} onClick={() => handleSelect(i)} disabled={showFeedback} className={`w-full p-4 rounded-xl text-left transition-all border-2 ${showFeedback ? i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-400 bg-red-50' : 'border-neutral-200 bg-white opacity-40' : 'border-neutral-200 bg-white hover:border-neutral-300'}`}>
                  <div className="flex items-center gap-3">
                    <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold transition-all ${showFeedback && i === data.correctIndex ? 'bg-green-500 text-white' : showFeedback && i === selected && !isCorrect ? 'bg-red-400 text-white' : 'bg-neutral-100 text-neutral-500'}`}>
                      {showFeedback && i === data.correctIndex ? <Icons.Check /> : showFeedback && i === selected && !isCorrect ? <Icons.X /> : String.fromCharCode(65 + i)}
                    </span>
                    <span className="text-neutral-700 text-sm md:text-base">{option}</span>
                  </div>
                </motion.button>
              ))}
            </div>
            <AnimatePresence>
              {showFeedback && (
                <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className={`p-5 rounded-xl ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                  <p className={`text-sm leading-relaxed ${isCorrect ? 'text-green-800' : 'text-amber-800'}`}>{isCorrect ? data.feedback.correct : data.feedback.incorrect}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      );
    };

    const CompletionSlide = () => (
      <div className="h-full flex flex-col items-center justify-center text-center px-8 slide-scroll overflow-y-auto py-10">
        <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'spring', duration: 0.5 }} className="w-20 h-20 rounded-xl flex items-center justify-center mb-6 text-white" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))`, boxShadow: `0 6px 24px rgba(var(--accent-rgb), 0.35)` }}><Icons.Check /></motion.div>
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="slide-title text-3xl md:text-4xl text-black mb-4">Lesson Complete</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }} className="text-neutral-500 text-base mb-8 max-w-md leading-relaxed">Price format changes perception. Match format to product category. Everyday = simple numerals. Deals = charm pricing. Luxury = rounded numbers.</motion.p>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }} className="bg-neutral-900 rounded-xl p-6 max-w-md w-full">
          <p className="text-neutral-500 text-xs uppercase tracking-wider mb-3">Up Next</p>
          <h3 className="text-white font-bold text-xl mb-2">{LESSON_CONFIG.nextLesson.title}</h3>
          <p className="text-neutral-400 text-sm">{LESSON_CONFIG.nextLesson.teaser}</p>
        </motion.div>
      </div>
    );

    // ============ MAIN APP ============

    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(0);
      const [direction, setDirection] = useState(1);
      const userName = useMemo(() => getUserName(), []);
      const currentSlideRef = React.useRef(0);
      const [gifConfig, setGifConfig] = useState(null);
      const [isAnimating, setIsAnimating] = useState(false);

      const showGif = useCallback((url, height, side) => setGifConfig({ url, height, side }), []);
      const hideGif = useCallback(() => setGifConfig(null), []);

      React.useEffect(() => { currentSlideRef.current = currentSlide; }, [currentSlide]);

      useEffect(() => {
        window.parent.postMessage({
          type: 'LESSON_SLIDE_UPDATE',
          slideIndex: currentSlide,
          slideType: slides[currentSlide]?.type,
          lessonSlug: LESSON_CONFIG.id
        }, '*');
      }, [currentSlide]);

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const slideParam = params.get('slide');
        if (slideParam) {
          const slideIndex = parseInt(slideParam, 10);
          if (!isNaN(slideIndex) && slideIndex >= 0 && slideIndex < slides.length) {
            setCurrentSlide(slideIndex);
          }
        }
      }, []);

      const goToSlide = useCallback((newSlide) => {
        if (isAnimating || newSlide < 0 || newSlide >= slides.length) return;
        setIsAnimating(true);
        setDirection(newSlide > currentSlideRef.current ? 1 : -1);
        setCurrentSlide(newSlide);
      }, [isAnimating]);

      const nextSlide = useCallback(() => { if (currentSlideRef.current + 1 < slides.length) goToSlide(currentSlideRef.current + 1); }, [goToSlide]);
      const prevSlide = useCallback(() => { if (currentSlideRef.current - 1 >= 0) goToSlide(currentSlideRef.current - 1); }, [goToSlide]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [nextSlide, prevSlide]);

      const slideVariants = {
        enter: (dir) => ({ x: dir > 0 ? '100%' : '-100%', opacity: 0 }),
        center: { x: 0, opacity: 1 },
        exit: (dir) => ({ x: dir > 0 ? '-100%' : '100%', opacity: 0 })
      };

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={nextSlide} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'content': return <ContentSlide data={slide} />;
          case 'example': return <ExampleSlide data={slide} />;
          case 'price-format-battle': return <PriceFormatBattleSlide />;
          case 'three-format-rules': return <ThreeFormatRulesSlide />;
          case 'charm-pricing-study': return <CharmPricingStudySlide />;
          case 'luxury-psychology': return <LuxuryPsychologySlide />;
          case 'impact-stats': return <ImpactStatsSlide />;
          case 'elite-insight': return <EliteInsightSlide />;
          case 'quiz': return <QuizSlide data={slide} onShowGif={showGif} onHideGif={hideGif} />;
          case 'completion': return <CompletionSlide />;
          default: return null;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction} onExitComplete={() => setIsAnimating(false)}>
              <motion.div key={currentSlide} custom={direction} variants={slideVariants} initial="enter" animate="center" exit="exit" transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
                <AdminSlideReportButton slideIndex={currentSlide} slideType={slides[currentSlide].type} />
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => goToSlide(i)} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gifConfig && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }} className={`absolute ${gifConfig.side === 'left' ? 'left-4 md:left-8' : 'right-4 md:right-8'} bottom-0 pointer-events-none`} style={{ zIndex: 15, height: gifConfig.height }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom" style={{ background: 'transparent', border: 'none', boxShadow: 'none' }}>
                  <source src={gifConfig.url} type="video/mp4" />
                </video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    ReactDOM.render(<LessonApp />, document.getElementById('root'));
  </script>
</body>
</html>
