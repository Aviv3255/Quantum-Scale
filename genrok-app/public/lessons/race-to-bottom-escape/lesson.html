<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Why Your ROAS Is Killing Your Business | Quantum Scale</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js" defer></script>
  <script src="../shared/greetings.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #ef4444; --accent-dark: #dc2626; --accent-light: #f87171; --accent-rgb: 239, 68, 68; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: transparent; -webkit-font-smoothing: antialiased; }
    .title-font { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    h1, h2, h3, .slide-title { font-family: 'Fraunces', serif; font-weight: 900; letter-spacing: -0.02em; line-height: 1.1; }
    ::selection { background: var(--accent); color: white; }
    .slide-scroll::-webkit-scrollbar { display: none; }
    .slide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { motion, AnimatePresence } = window.Motion;
    const { useState, useEffect, useCallback, useMemo } = React;

    const getUserName = () => { const params = new URLSearchParams(window.location.search); return params.get('userName') || 'Builder'; };
    const getInitialSlide = () => { const params = new URLSearchParams(window.location.search); const slide = params.get('slide'); return slide ? parseInt(slide, 10) : 0; };

    const LESSON_CONFIG = {
      id: 'race-to-bottom-escape',
      title: 'Why Your ROAS Is Killing Your Business',
      description: 'You are winning every battle and still losing the war.',
      accentColor: '#ef4444',
      duration: '8 min',
      nextLesson: { id: 'founder-operating-system', title: 'The 4 Traits of Legendary Brand Founders', teaser: 'Most founders optimize for tactics. The legends operate from a different system.' }
    };

    // ============ CONFIGURATION ARRAYS ============
    const THREE_SPIRALS = [
      { id: 1, name: 'Rising Costs', icon: 'TrendingUp', color: '#ef4444', stat: '+140%', statLabel: 'CPM increase', description: 'The auction extracts maximum value. What worked at $5 CPM now costs $12.' },
      { id: 2, name: 'Commoditization', icon: 'Tag', color: '#f97316', stat: '40%', statLabel: 'margin erosion', description: 'Competing on performance means discounts. You become a commodity.' },
      { id: 3, name: 'Zero Loyalty', icon: 'UserX', color: '#eab308', stat: '73%', statLabel: 'will leave for 10% off', description: 'Customers acquired by transaction, not relationship. No moat.' }
    ];

    const CPM_TIMELINE = [
      { quarter: 'Q1 2023', cpm: 5, label: '$5 CPM' },
      { quarter: 'Q2 2023', cpm: 7, label: '$7 CPM' },
      { quarter: 'Q3 2023', cpm: 9, label: '$9 CPM' },
      { quarter: 'Q4 2023', cpm: 12, label: '$12 CPM' }
    ];

    const DISCOUNT_CYCLE = [
      { step: 1, label: 'DISCOUNT', description: 'Run 25% off sale to hit numbers' },
      { step: 2, label: 'COMPETE', description: 'Competitors match or beat your price' },
      { step: 3, label: 'DISCOUNT MORE', description: 'Must go deeper to maintain volume' },
      { step: 4, label: 'TRAPPED', description: 'Customers only buy during sales' }
    ];

    const ESCAPE_FORMULA = [
      { component: 'Brand Psychology', icon: 'Heart', color: '#8b5cf6', elements: ['Emotional connection', 'Cultural relevance', 'Long-term positioning'] },
      { component: 'DR Execution', icon: 'Target', color: '#10b981', elements: ['Measurable', 'Optimizable', 'Scalable'] }
    ];

    const ROAS_PARADOX = {
      title: 'The ROAS Paradox',
      insight: 'Optimizing for transactions destroys the relationships that create transactions.',
      quote: 'Performance marketing funds your growth today. Brand marketing ensures you are still here tomorrow.'
    };

    // ============ ADMIN REPORTER SYSTEM ============
    let __isAdmin = false;
    window.addEventListener('message', function(e) {
      if (e.data?.type === 'ADMIN_STATUS') __isAdmin = e.data.isAdmin;
    });
    if (window.parent !== window) window.parent.postMessage({ type: 'CHECK_ADMIN_STATUS' }, '*');

    const AdminSlideReportButton = ({ slideIndex, slideType }) => {
      const handleReport = (e) => {
        e.stopPropagation();
        e.preventDefault();
        if (window.parent !== window) {
          window.parent.postMessage({ type: 'ADMIN_REPORT_REQUEST', slideIndex, slideType, lessonSlug: LESSON_CONFIG.id, elementId: slideType + '-' + slideIndex }, '*');
        }
      };
      return (
        <button onClick={handleReport} title={`Report issue on Slide ${slideIndex + 1} (${slideType})`}
          style={{ position: 'absolute', top: '12px', right: '12px', width: '32px', height: '32px', borderRadius: '8px', backgroundColor: 'rgba(239, 68, 68, 0.9)', color: 'white', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, opacity: 0.6, transition: 'opacity 0.2s, transform 0.2s', boxShadow: '0 2px 8px rgba(0,0,0,0.15)' }}
          onMouseEnter={(e) => { e.currentTarget.style.opacity = '1'; e.currentTarget.style.transform = 'scale(1.1)'; }}
          onMouseLeave={(e) => { e.currentTarget.style.opacity = '0.6'; e.currentTarget.style.transform = 'scale(1)'; }}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>
        </button>
      );
    };

    // ============ ICONS ============
    const Icons = {
      Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Check: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      ArrowRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      TrendingUp: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
      TrendingDown: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
      Tag: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
      UserX: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>,
      Heart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>,
      Target: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
      AlertTriangle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
      DollarSign: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
      RefreshCw: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
      Zap: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
      Plus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      Equals: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/></svg>,
      Shield: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
      Brain: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-1.54z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-1.54z"/></svg>,
      Lightbulb: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>,
    };

    const SpiralIcons = {
      TrendingUp: Icons.TrendingUp,
      Tag: Icons.Tag,
      UserX: Icons.UserX
    };

    const FormulaIcons = {
      Heart: Icons.Heart,
      Target: Icons.Target
    };

    // ============ ANIMATED COUNTER ============
    const AnimatedCounter = ({ value, duration = 2000, prefix = '', suffix = '' }) => {
      const [count, setCount] = useState(0);
      useEffect(() => {
        let startTime;
        const animate = (timestamp) => {
          if (!startTime) startTime = timestamp;
          const progress = Math.min((timestamp - startTime) / duration, 1);
          setCount(Math.floor(progress * value));
          if (progress < 1) requestAnimationFrame(animate);
        };
        requestAnimationFrame(animate);
      }, [value, duration]);
      return <span>{prefix}{count}{suffix}</span>;
    };

    // ============ CELEBRATION/EMPATHY GIFS ============
    const celebrationGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_doing_a_quick_victory_dance_move_high_energy_c_d03b798b-a518-4e6c-bcae-d69b2dd50486_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_jumping_in_the_air_arms_raised_high_YESSS_cele_201477e8-3df4-405a-bc81-81d1747e5c6c_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_playing_air_guitar_light_headbanging_rockstar__0702007e-9e84-4d9e-8f99-8ee23d0b65f8_2.mp4'
    ];
    const getRandomCelebrationGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];
    const empathyGifs = [
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_thumbs_down_with_encouraging_nod_close_keep_go_613e541f-c072-436f-aee7-f99cd6f834fc_2.mp4',
      'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/aviv3255_He_is_shaking_head_side_to_side_sadly_disappointed_e_c4a4be22-6a70-4738-8612-3039454fef37_1.mp4'
    ];
    const getRandomEmpathyGif = () => empathyGifs[Math.floor(Math.random() * empathyGifs.length)];

    // ============ SLIDES DATA ============
    const slides = [
      { type: 'welcome', learningGoals: ['Why optimizing ROAS can destroy your business long-term', 'The three death spirals of performance-only marketing', 'How to escape the race to the bottom with brand + performance fusion'] },
      { type: 'hook', headline: 'You are winning every battle and still losing the war.', subtext: 'Your dashboard looks beautiful. ROAS is climbing. CTR is up. Conversion rate is optimized to the third decimal place. Yet somehow, your margins are shrinking. Customer acquisition costs keep rising. And last month\'s winning campaign is already losing this month.', brandImage: 'https://pqvvrljykfvhpyvxmwzb.supabase.co/storage/v1/object/public/images/Meta_Platforms_Inc._logo_(cropped).svg.png', brandName: 'Meta' },
      { type: 'three-spirals-grid' },
      { type: 'spiral-detail', spiralIndex: 0 },
      { type: 'cpm-timeline' },
      { type: 'spiral-detail', spiralIndex: 1 },
      { type: 'discount-cycle' },
      { type: 'spiral-detail', spiralIndex: 2 },
      { type: 'performance-vs-brand' },
      { type: 'escape-formula' },
      { type: 'quiz', question: 'According to Seth Godin, why does direct marketing race to the bottom?', options: ['It is too expensive for small businesses', 'You are trying to get clicks from people dumb enough to pay you', 'The algorithms are broken', 'Competitors always copy your ads'], correctIndex: 1, feedback: { correct: 'Exactly. When your entire strategy is "find people who will click and buy right now," you are selecting for the least discerning, most price-sensitive customers in the market.', incorrect: 'The core issue is WHO you attract. Performance-only marketing selects for the least discerning, most price-sensitive customers.' }},
      { type: 'elite-insight' },
      { type: 'completion' }
    ];

    // ============ UNIQUE SLIDE COMPONENTS ============

    // Three Spirals Grid - Animated overview of all 3 death spirals
    const ThreeSpiralsGridSlide = () => {
      const [activeSpiral, setActiveSpiral] = useState(0);

      useEffect(() => {
        const interval = setInterval(() => {
          setActiveSpiral(prev => (prev + 1) % 3);
        }, 2500);
        return () => clearInterval(interval);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-4xl text-black text-center mb-3">
            The Three Death Spirals
          </motion.h2>
          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.2 }} className="text-neutral-500 text-center mb-8 text-sm md:text-base">
            Each spiral feeds the next. Together, they destroy your business.
          </motion.p>

          <div className="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6">
            {THREE_SPIRALS.map((spiral, i) => {
              const IconComponent = SpiralIcons[spiral.icon];
              const isActive = activeSpiral === i;
              return (
                <motion.div
                  key={spiral.id}
                  initial={{ opacity: 0, y: 30 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.3 + i * 0.15 }}
                  onClick={() => setActiveSpiral(i)}
                  style={{
                    background: isActive ? 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' : 'white',
                    border: isActive ? `2px solid ${spiral.color}` : '2px solid #e5e5e5',
                    boxShadow: isActive ? `0 0 30px ${spiral.color}30` : 'none',
                    cursor: 'pointer'
                  }}
                  className="w-full md:w-64 rounded-2xl p-6 transition-all duration-500"
                >
                  <div className="flex flex-col items-center text-center">
                    <motion.div
                      animate={{ rotate: isActive ? 360 : 0 }}
                      transition={{ duration: 1, ease: "easeInOut" }}
                      className="w-14 h-14 rounded-xl flex items-center justify-center mb-4"
                      style={{ background: `${spiral.color}20`, color: spiral.color }}
                    >
                      <IconComponent />
                    </motion.div>
                    <div className="text-xs font-bold mb-2" style={{ color: spiral.color }}>
                      SPIRAL {spiral.id}
                    </div>
                    <h3 className={`font-bold text-lg mb-2 ${isActive ? 'text-white' : 'text-neutral-900'}`}>
                      {spiral.name}
                    </h3>
                    <div className="text-3xl font-black mb-1" style={{ color: spiral.color }}>
                      {spiral.stat}
                    </div>
                    <div className={`text-xs ${isActive ? 'text-neutral-400' : 'text-neutral-500'}`}>
                      {spiral.statLabel}
                    </div>
                  </div>

                  {/* Arrow connecting to next spiral */}
                  {i < 2 && (
                    <motion.div
                      animate={{ x: [0, 5, 0] }}
                      transition={{ duration: 1.5, repeat: Infinity }}
                      className="hidden md:block absolute -right-5 top-1/2 -translate-y-1/2 text-neutral-300"
                    >
                      <Icons.ArrowRight />
                    </motion.div>
                  )}
                </motion.div>
              );
            })}
          </div>

          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.8 }}
            className="mt-8 text-center"
          >
            <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-red-50 text-red-600 text-sm font-medium">
              <Icons.AlertTriangle />
              <span>Each spiral makes the next one worse</span>
            </div>
          </motion.div>
        </div>
      );
    };

    // Spiral Detail - Individual deep dive into each spiral
    const SpiralDetailSlide = ({ spiralIndex }) => {
      const spiral = THREE_SPIRALS[spiralIndex];
      const IconComponent = SpiralIcons[spiral.icon];

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-4xl mx-auto py-8">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="text-center mb-8"
          >
            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold mb-4" style={{ background: `${spiral.color}20`, color: spiral.color }}>
              DEATH SPIRAL {spiral.id}
            </div>
            <h2 className="slide-title text-3xl md:text-5xl text-black">{spiral.name}</h2>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.2 }}
            className="rounded-2xl p-8 mb-6"
            style={{ background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' }}
          >
            <div className="flex flex-col md:flex-row items-center gap-8">
              <motion.div
                animate={{
                  scale: [1, 1.1, 1],
                  rotate: spiralIndex === 0 ? [0, 10, 0] : 0
                }}
                transition={{ duration: 2, repeat: Infinity }}
                className="w-24 h-24 rounded-2xl flex items-center justify-center flex-shrink-0"
                style={{ background: `${spiral.color}20`, color: spiral.color }}
              >
                <IconComponent />
              </motion.div>

              <div className="flex-1 text-center md:text-left">
                <div className="text-5xl md:text-7xl font-black mb-2" style={{ color: spiral.color }}>
                  <AnimatedCounter value={parseInt(spiral.stat)} suffix={spiral.stat.includes('%') ? '%' : ''} prefix={spiral.stat.includes('+') ? '+' : ''} />
                </div>
                <div className="text-neutral-400 text-lg mb-4">{spiral.statLabel}</div>
                <p className="text-white text-lg leading-relaxed">{spiral.description}</p>
              </div>
            </div>
          </motion.div>

          {spiralIndex === 0 && (
            <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }} className="text-neutral-600 text-center text-sm">
              The platform always wins. Your competitors copy. Your costs rise. And you must raise prices... which leads to Spiral 2.
            </motion.p>
          )}
          {spiralIndex === 1 && (
            <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }} className="text-neutral-600 text-center text-sm">
              Congratulations. You have trained customers to never buy at full price. You are now a commodity.
            </motion.p>
          )}
          {spiralIndex === 2 && (
            <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }} className="text-neutral-600 text-center text-sm">
              Someone clicks because of FOMO or discount. They do not care about you. When competitors offer 10% more, they are gone.
            </motion.p>
          )}
        </div>
      );
    };

    // CPM Timeline - Animated rising costs visualization
    const CPMTimelineSlide = () => {
      const maxCPM = Math.max(...CPM_TIMELINE.map(t => t.cpm));

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-2">
            Watch Your CPMs Rise
          </motion.h2>
          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.1 }} className="text-neutral-500 text-center mb-8 text-sm">
            The auction extracts maximum value. What worked last quarter now costs more.
          </motion.p>

          <div className="flex items-end justify-center gap-4 md:gap-8 h-64 mb-6">
            {CPM_TIMELINE.map((item, i) => (
              <motion.div
                key={item.quarter}
                initial={{ height: 0, opacity: 0 }}
                animate={{ height: `${(item.cpm / maxCPM) * 100}%`, opacity: 1 }}
                transition={{ delay: 0.3 + i * 0.2, duration: 0.8 }}
                className="w-16 md:w-24 rounded-t-xl relative flex flex-col items-center"
                style={{
                  background: `linear-gradient(to top, ${LESSON_CONFIG.accentColor}, ${LESSON_CONFIG.accentColor}90)`,
                  boxShadow: `0 0 20px ${LESSON_CONFIG.accentColor}30`
                }}
              >
                <motion.div
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.5 + i * 0.2 }}
                  className="absolute -top-10 text-center"
                >
                  <div className="text-xl md:text-2xl font-black text-neutral-900">{item.label}</div>
                </motion.div>
                <motion.div
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  transition={{ delay: 0.7 + i * 0.2 }}
                  className="absolute -bottom-8 text-xs text-neutral-500 whitespace-nowrap"
                >
                  {item.quarter}
                </motion.div>
              </motion.div>
            ))}
          </div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 1.2 }}
            className="flex items-center justify-center gap-2 mt-8"
          >
            <Icons.TrendingUp />
            <span className="text-2xl font-black" style={{ color: LESSON_CONFIG.accentColor }}>+140% in 12 months</span>
          </motion.div>
        </div>
      );
    };

    // Discount Cycle - Animated trap visualization
    const DiscountCycleSlide = () => {
      const [activeStep, setActiveStep] = useState(0);

      useEffect(() => {
        const interval = setInterval(() => {
          setActiveStep(prev => (prev + 1) % 4);
        }, 2000);
        return () => clearInterval(interval);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-2">
            The Discount Death Trap
          </motion.h2>
          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.1 }} className="text-neutral-500 text-center mb-8 text-sm">
            A cycle you cannot escape once you enter.
          </motion.p>

          <div className="relative">
            {/* Circular cycle visualization */}
            <div className="flex flex-wrap justify-center gap-4">
              {DISCOUNT_CYCLE.map((item, i) => {
                const isActive = activeStep === i;
                return (
                  <motion.div
                    key={item.step}
                    initial={{ opacity: 0, scale: 0.8 }}
                    animate={{
                      opacity: 1,
                      scale: isActive ? 1.05 : 1,
                    }}
                    transition={{ delay: 0.2 + i * 0.1 }}
                    className="w-full sm:w-40 md:w-48 rounded-xl p-4 transition-all duration-300"
                    style={{
                      background: isActive ? 'linear-gradient(135deg, #1a1a1a, #2d2d2d)' : 'white',
                      border: isActive ? '2px solid #f97316' : '2px solid #e5e5e5',
                      boxShadow: isActive ? '0 0 30px rgba(249, 115, 22, 0.3)' : 'none'
                    }}
                  >
                    <div className="flex items-center gap-3">
                      <div
                        className="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-lg flex-shrink-0"
                        style={{ background: isActive ? '#f97316' : '#d4d4d4' }}
                      >
                        {item.step}
                      </div>
                      <div>
                        <div className={`font-bold text-sm ${isActive ? 'text-white' : 'text-neutral-900'}`}>
                          {item.label}
                        </div>
                        <div className={`text-xs ${isActive ? 'text-neutral-400' : 'text-neutral-500'}`}>
                          {item.description}
                        </div>
                      </div>
                    </div>

                    {/* Arrow to next */}
                    {i < 3 && (
                      <motion.div
                        animate={{ x: [0, 5, 0] }}
                        transition={{ duration: 1.5, repeat: Infinity }}
                        className="hidden sm:flex absolute -right-3 top-1/2 -translate-y-1/2 text-orange-400"
                      >
                        <Icons.ArrowRight />
                      </motion.div>
                    )}
                  </motion.div>
                );
              })}
            </div>

            {/* Loop back arrow */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.8 }}
              className="flex justify-center mt-6"
            >
              <div className="flex items-center gap-2 text-red-500">
                <Icons.RefreshCw />
                <span className="text-sm font-medium">Repeat forever</span>
              </div>
            </motion.div>
          </div>
        </div>
      );
    };

    // Performance vs Brand - Side-by-side comparison with winner
    const PerformanceVsBrandSlide = () => {
      const [showWinner, setShowWinner] = useState(false);

      useEffect(() => {
        const timer = setTimeout(() => setShowWinner(true), 1500);
        return () => clearTimeout(timer);
      }, []);

      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-5xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-8">
            Two Approaches. One Winner.
          </motion.h2>

          <div className="grid md:grid-cols-2 gap-6">
            {/* Performance Only */}
            <motion.div
              initial={{ opacity: 0, x: -30 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.2 }}
              className="rounded-2xl p-6 border-2 border-red-200 bg-red-50 relative"
            >
              <div className="flex items-center gap-2 mb-4">
                <div className="w-10 h-10 rounded-xl bg-red-500 flex items-center justify-center">
                  <Icons.X />
                </div>
                <h3 className="font-bold text-red-900 text-lg">Performance Only</h3>
              </div>
              <ul className="space-y-3">
                {['Optimize ROAS obsessively', 'Split-test everything', 'Rising CPMs every quarter', 'Constant discounts to compete', 'Zero customer loyalty', 'Customers leave for 10% off'].map((item, i) => (
                  <motion.li
                    key={i}
                    initial={{ opacity: 0, x: -10 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.4 + i * 0.1 }}
                    className="flex items-center gap-2 text-red-800 text-sm"
                  >
                    <Icons.X />
                    {item}
                  </motion.li>
                ))}
              </ul>

              {showWinner && (
                <motion.div
                  initial={{ opacity: 0, scale: 0 }}
                  animate={{ opacity: 1, scale: 1 }}
                  className="absolute -top-3 -right-3 px-3 py-1 rounded-full bg-red-500 text-white text-xs font-bold"
                >
                  LOSES
                </motion.div>
              )}
            </motion.div>

            {/* Brand + Performance */}
            <motion.div
              initial={{ opacity: 0, x: 30 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.3 }}
              className="rounded-2xl p-6 relative"
              style={{
                background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
                border: '2px solid #10b981',
                boxShadow: '0 0 30px rgba(16, 185, 129, 0.2)'
              }}
            >
              <div className="flex items-center gap-2 mb-4">
                <div className="w-10 h-10 rounded-xl bg-green-500 flex items-center justify-center text-white">
                  <Icons.Check />
                </div>
                <h3 className="font-bold text-white text-lg">Brand + Performance</h3>
              </div>
              <ul className="space-y-3">
                {['Build emotional connection', 'Stand for something bigger', 'Create uncopiable moat', 'Pricing power over discounts', 'Loyal customers who stay', 'Referrals from believers'].map((item, i) => (
                  <motion.li
                    key={i}
                    initial={{ opacity: 0, x: -10 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.5 + i * 0.1 }}
                    className="flex items-center gap-2 text-green-400 text-sm"
                  >
                    <Icons.Check />
                    {item}
                  </motion.li>
                ))}
              </ul>

              {showWinner && (
                <motion.div
                  initial={{ opacity: 0, scale: 0 }}
                  animate={{ opacity: 1, scale: 1 }}
                  className="absolute -top-3 -right-3 px-4 py-1.5 rounded-full bg-green-500 text-white text-xs font-bold"
                >
                  WINS
                </motion.div>
              )}
            </motion.div>
          </div>
        </div>
      );
    };

    // Escape Formula - Brand + DR = Escape equation
    const EscapeFormulaSlide = () => {
      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-12 max-w-4xl mx-auto py-8">
          <motion.h2 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="slide-title text-2xl md:text-3xl text-black text-center mb-2">
            The Escape Formula
          </motion.h2>
          <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.1 }} className="text-neutral-500 text-center mb-8 text-sm">
            Fuse both. Master the combination.
          </motion.p>

          {/* Formula equation */}
          <div className="flex flex-col md:flex-row items-center justify-center gap-4 mb-8">
            {ESCAPE_FORMULA.map((item, i) => {
              const IconComponent = FormulaIcons[item.icon];
              return (
                <React.Fragment key={item.component}>
                  <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.3 + i * 0.2 }}
                    className="w-full md:w-64 rounded-2xl p-6"
                    style={{
                      background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
                      border: `2px solid ${item.color}`,
                      boxShadow: `0 0 20px ${item.color}20`
                    }}
                  >
                    <div className="flex items-center gap-3 mb-4">
                      <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ background: `${item.color}20`, color: item.color }}>
                        <IconComponent />
                      </div>
                      <h3 className="text-white font-bold">{item.component}</h3>
                    </div>
                    <ul className="space-y-2">
                      {item.elements.map((el, j) => (
                        <li key={j} className="text-neutral-400 text-sm flex items-center gap-2">
                          <div className="w-1.5 h-1.5 rounded-full" style={{ background: item.color }} />
                          {el}
                        </li>
                      ))}
                    </ul>
                  </motion.div>

                  {i === 0 && (
                    <motion.div
                      initial={{ opacity: 0, scale: 0 }}
                      animate={{ opacity: 1, scale: 1 }}
                      transition={{ delay: 0.6 }}
                      className="text-4xl font-black text-neutral-300"
                    >
                      <Icons.Plus />
                    </motion.div>
                  )}
                </React.Fragment>
              );
            })}

            <motion.div
              initial={{ opacity: 0, scale: 0 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: 0.8 }}
              className="text-4xl font-black text-neutral-300"
            >
              <Icons.Equals />
            </motion.div>

            <motion.div
              initial={{ opacity: 0, scale: 0 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: 1 }}
              className="w-full md:w-40 h-32 rounded-2xl flex items-center justify-center"
              style={{
                background: 'linear-gradient(135deg, #10b981, #059669)',
                boxShadow: '0 0 40px rgba(16, 185, 129, 0.4)'
              }}
            >
              <div className="text-center">
                <Icons.Shield />
                <div className="text-white font-black text-xl mt-2">ESCAPE</div>
              </div>
            </motion.div>
          </div>

          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 1.2 }}
            className="text-center"
          >
            <p className="text-neutral-600 text-sm">
              Performance marketing funds your growth today. Brand marketing ensures you are still here tomorrow.
            </p>
          </motion.div>
        </div>
      );
    };

    // Elite Insight - The ROAS Paradox
    const EliteInsightSlide = () => {
      return (
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto py-8">
          <motion.div
            initial={{ opacity: 0, y: 30 }}
            animate={{ opacity: 1, y: 0 }}
            className="rounded-2xl p-8 md:p-12 text-center relative overflow-hidden"
            style={{
              background: 'linear-gradient(135deg, #1a1a1a, #2d2d2d)',
              boxShadow: '0 0 60px rgba(239, 68, 68, 0.15)'
            }}
          >
            {/* Top accent line */}
            <div
              className="absolute top-0 left-0 right-0 h-1"
              style={{ background: `linear-gradient(90deg, transparent, ${LESSON_CONFIG.accentColor}, transparent)` }}
            />

            <motion.div
              initial={{ opacity: 0, scale: 0 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: 0.2 }}
              className="w-16 h-16 rounded-2xl mx-auto mb-6 flex items-center justify-center"
              style={{ background: `${LESSON_CONFIG.accentColor}20`, color: LESSON_CONFIG.accentColor }}
            >
              <Icons.Brain />
            </motion.div>

            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.3 }}
              className="text-xs font-bold tracking-wider mb-4"
              style={{ color: LESSON_CONFIG.accentColor }}
            >
              ELITE INSIGHT
            </motion.div>

            <motion.h2
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.4 }}
              className="slide-title text-3xl md:text-4xl text-white mb-6"
            >
              {ROAS_PARADOX.title}
            </motion.h2>

            <motion.p
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.5 }}
              className="text-neutral-300 text-lg md:text-xl leading-relaxed mb-8"
            >
              "{ROAS_PARADOX.insight}"
            </motion.p>

            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.7 }}
              className="inline-flex items-center gap-2 px-5 py-3 rounded-xl"
              style={{ background: `${LESSON_CONFIG.accentColor}15`, border: `1px solid ${LESSON_CONFIG.accentColor}30` }}
            >
              <Icons.Lightbulb />
              <span className="text-sm font-medium" style={{ color: LESSON_CONFIG.accentColor }}>
                Play only one game, and you have already lost.
              </span>
            </motion.div>
          </motion.div>
        </div>
      );
    };

    // ============ STANDARD SLIDE COMPONENTS ============
    const WelcomeSlide = ({ data, onStart, userName, onShowGif, onHideGif }) => {
      const welcomeData = useMemo(() => getTimeBasedWelcome(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      useEffect(() => { onShowGif(welcomeData.gif, '65%', gifSide); return () => onHideGif(); }, [welcomeData.gif, gifSide, onShowGif, onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col items-center justify-center text-center px-6 py-4 relative z-20">
            <motion.h1 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="title-font text-3xl sm:text-4xl md:text-5xl lg:text-6xl text-black mb-2 md:mb-3">{LESSON_CONFIG.title}</motion.h1>
            <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }} className="text-neutral-600 text-base md:text-lg lg:text-xl mb-2 md:mb-3 max-w-lg leading-relaxed" dangerouslySetInnerHTML={{ __html: formatGreeting(welcomeData.greeting, `<span class="font-bold text-neutral-900">${userName}</span>`) }} />
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="flex items-center justify-center gap-1.5 text-neutral-400 text-[10px] md:text-xs mb-2 md:mb-3"><Icons.Clock /><span>{LESSON_CONFIG.duration}</span></motion.div>
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-neutral-900 rounded-xl md:rounded-2xl p-3 md:p-5 mb-3 md:mb-4 max-w-sm w-full mx-auto">
              <p className="text-neutral-500 text-[9px] md:text-[11px] uppercase tracking-wider mb-2 md:mb-3">In this lesson</p>
              <ul className="space-y-1.5 md:space-y-2">
                {data.learningGoals.map((goal, i) => (
                  <motion.li key={i} initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.25 + i * 0.05 }} className="flex items-start gap-2 text-left">
                    <span className="w-5 h-5 rounded-md flex items-center justify-center text-[9px] font-bold text-white flex-shrink-0 mt-0.5" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>{i + 1}</span>
                    <span className="text-neutral-300 text-[11px] md:text-sm leading-snug">{goal}</span>
                  </motion.li>
                ))}
              </ul>
            </motion.div>
            <motion.button initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.45 }} onClick={onStart} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} className="px-6 md:px-7 py-2.5 md:py-3 rounded-xl text-white font-semibold text-sm md:text-base" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))` }}>Let's Go</motion.button>
          </div>
        </div>
      );
    };

    const HookSlide = ({ data }) => (
      <div className="h-full relative overflow-hidden">
        <div className="h-full flex flex-col justify-center px-6 md:px-16 max-w-3xl mx-auto slide-scroll overflow-y-auto py-8 md:py-10 relative z-10">
          <motion.div initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} className="mb-4 md:mb-6">
            <span className="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-3 md:mb-4" style={{ background: `rgba(var(--accent-rgb), 0.1)`, color: 'var(--accent)' }}>The Hook</span>
            <h2 className="slide-title text-2xl md:text-4xl lg:text-5xl text-black leading-tight">{data.headline}</h2>
          </motion.div>
          <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="text-base md:text-xl text-neutral-600 leading-relaxed">{data.subtext}</motion.p>
        </div>
        {data.brandImage && (
          <motion.div initial={{ opacity: 0, x: 30 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.3, duration: 0.5 }}
            className="absolute bottom-0 right-0 z-0 pointer-events-none hidden md:block" style={{ height: '30%', maxHeight: '200px', marginRight: '80px', marginBottom: '5%' }}>
            <img src={data.brandImage} alt={data.brandName || ''} className="h-full w-auto object-contain" style={{ opacity: 0.8 }} />
          </motion.div>
        )}
      </div>
    );

    const QuizSlide = ({ data, onShowGif, onHideGif }) => {
      const [selected, setSelected] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const celebrationGif = useMemo(() => getRandomCelebrationGif(), []);
      const empathyGif = useMemo(() => getRandomEmpathyGif(), []);
      const gifSide = useMemo(() => Math.random() > 0.5 ? 'left' : 'right', []);
      const handleSelect = (index) => { if (showFeedback) return; setSelected(index); setShowFeedback(true); };
      const isCorrect = selected === data.correctIndex;

      useEffect(() => { if (showFeedback) { if (isCorrect) { onShowGif(celebrationGif, '60%', gifSide); } else { onShowGif(empathyGif, '60%', gifSide); } } }, [showFeedback, isCorrect, celebrationGif, empathyGif, gifSide, onShowGif]);
      useEffect(() => { return () => onHideGif(); }, [onHideGif]);

      return (
        <div className="h-full w-full relative overflow-hidden">
          <div className="h-full flex flex-col justify-center px-8 md:px-12 max-w-2xl mx-auto slide-scroll overflow-y-auto py-10 relative z-30">
            <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className="text-center mb-6">
              <p className="text-xs uppercase tracking-wider text-neutral-400 mb-3">Quick Check</p>
              <h2 className="slide-title text-xl md:text-2xl text-black leading-tight">{data.question}</h2>
            </motion.div>
            <div className="space-y-3 mb-6">
              {data.options.map((option, i) => (
                <motion.button key={i} initial={{ opacity: 0, x: -15 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.08 + i * 0.06 }} onClick={() => handleSelect(i)} disabled={showFeedback} className={`w-full p-4 rounded-xl text-left transition-all border-2 ${showFeedback ? i === data.correctIndex ? 'border-green-500 bg-green-50' : i === selected ? 'border-red-400 bg-red-50' : 'border-neutral-200 bg-white opacity-40' : 'border-neutral-200 bg-white hover:border-neutral-300'}`}>
                  <div className="flex items-center gap-3">
                    <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold transition-all ${showFeedback && i === data.correctIndex ? 'bg-green-500 text-white' : showFeedback && i === selected && !isCorrect ? 'bg-red-400 text-white' : 'bg-neutral-100 text-neutral-500'}`}>
                      {showFeedback && i === data.correctIndex ? <Icons.Check /> : showFeedback && i === selected && !isCorrect ? <Icons.X /> : String.fromCharCode(65 + i)}
                    </span>
                    <span className="text-neutral-700 text-sm md:text-base">{option}</span>
                  </div>
                </motion.button>
              ))}
            </div>
            <AnimatePresence>
              {showFeedback && (
                <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} className={`p-5 rounded-xl ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                  <p className={`text-sm leading-relaxed ${isCorrect ? 'text-green-800' : 'text-amber-800'}`}>{isCorrect ? data.feedback.correct : data.feedback.incorrect}</p>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      );
    };

    const CompletionSlide = () => (
      <div className="h-full flex flex-col items-center justify-center text-center px-8 slide-scroll overflow-y-auto py-8">
        <motion.div initial={{ opacity: 0, scale: 0 }} animate={{ opacity: 1, scale: 1 }} transition={{ type: 'spring', duration: 0.5 }} className="w-16 h-16 rounded-xl flex items-center justify-center mb-4 text-white" style={{ background: `linear-gradient(135deg, var(--accent), var(--accent-dark))`, boxShadow: `0 6px 24px rgba(var(--accent-rgb), 0.35)` }}><Icons.Check /></motion.div>
        <motion.h2 initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }} className="slide-title text-2xl md:text-3xl text-black mb-3">Lesson Complete</motion.h2>
        <motion.p initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }} className="text-neutral-500 text-sm mb-5 max-w-md leading-relaxed">You now understand why ROAS optimization alone kills businesses. Performance marketing without brand positioning is a treadmill. Escape by fusing brand psychology with direct response execution.</motion.p>
        <motion.div initial={{ opacity: 0, y: 15 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.35 }} className="bg-neutral-900 rounded-xl p-5 max-w-md w-full mb-4">
          <p className="text-neutral-500 text-xs uppercase tracking-wider mb-2">Up Next</p>
          <h3 className="text-white font-bold text-lg mb-1">{LESSON_CONFIG.nextLesson.title}</h3>
          <p className="text-neutral-400 text-xs">{LESSON_CONFIG.nextLesson.teaser}</p>
        </motion.div>
      </div>
    );

    // ============ MAIN APP ============
    const LessonApp = () => {
      const [currentSlide, setCurrentSlide] = useState(getInitialSlide());
      const [direction, setDirection] = useState(1);
      const userName = useMemo(() => getUserName(), []);
      const currentSlideRef = React.useRef(0);
      const [gifConfig, setGifConfig] = useState(null);
      const [isAnimating, setIsAnimating] = useState(false);

      const showGif = useCallback((url, height, side) => setGifConfig({ url, height, side }), []);
      const hideGif = useCallback(() => setGifConfig(null), []);

      React.useEffect(() => { currentSlideRef.current = currentSlide; }, [currentSlide]);

      useEffect(() => {
        window.parent.postMessage({ type: 'LESSON_SLIDE_UPDATE', slideIndex: currentSlide, slideType: slides[currentSlide]?.type, lessonSlug: LESSON_CONFIG.id }, '*');
      }, [currentSlide]);

      const goToSlide = useCallback((newSlide) => {
        if (isAnimating || newSlide < 0 || newSlide >= slides.length) return;
        setIsAnimating(true);
        setDirection(newSlide > currentSlideRef.current ? 1 : -1);
        setCurrentSlide(newSlide);
      }, [isAnimating]);

      const nextSlide = useCallback(() => { if (currentSlideRef.current + 1 < slides.length) goToSlide(currentSlideRef.current + 1); }, [goToSlide]);
      const prevSlide = useCallback(() => { if (currentSlideRef.current - 1 >= 0) goToSlide(currentSlideRef.current - 1); }, [goToSlide]);

      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [nextSlide, prevSlide]);

      const slideVariants = {
        enter: (dir) => ({ x: dir > 0 ? '100%' : '-100%', opacity: 0 }),
        center: { x: 0, opacity: 1 },
        exit: (dir) => ({ x: dir > 0 ? '-100%' : '100%', opacity: 0 })
      };

      const renderSlide = (slide) => {
        switch (slide.type) {
          case 'welcome': return <WelcomeSlide data={slide} onStart={nextSlide} userName={userName} onShowGif={showGif} onHideGif={hideGif} />;
          case 'hook': return <HookSlide data={slide} />;
          case 'three-spirals-grid': return <ThreeSpiralsGridSlide />;
          case 'spiral-detail': return <SpiralDetailSlide spiralIndex={slide.spiralIndex} />;
          case 'cpm-timeline': return <CPMTimelineSlide />;
          case 'discount-cycle': return <DiscountCycleSlide />;
          case 'performance-vs-brand': return <PerformanceVsBrandSlide />;
          case 'escape-formula': return <EscapeFormulaSlide />;
          case 'quiz': return <QuizSlide data={slide} onShowGif={showGif} onHideGif={hideGif} />;
          case 'elite-insight': return <EliteInsightSlide />;
          case 'completion': return <CompletionSlide />;
          default: return null;
        }
      };

      const showPrev = currentSlide > 0;
      const showNext = currentSlide < slides.length - 1 && slides[currentSlide].type !== 'welcome';

      return (
        <div className="w-full h-screen bg-white flex flex-col relative">
          <div className="flex-1 relative overflow-hidden z-20">
            <AnimatePresence mode="wait" custom={direction} onExitComplete={() => setIsAnimating(false)}>
              <motion.div key={currentSlide} custom={direction} variants={slideVariants} initial="enter" animate="center" exit="exit" transition={{ duration: 0.3, ease: [0.25, 0.1, 0.25, 1] }} className="absolute inset-0">
                {renderSlide(slides[currentSlide])}
                <AdminSlideReportButton slideIndex={currentSlide} slideType={slides[currentSlide].type} />
              </motion.div>
            </AnimatePresence>
            {showPrev && <button onClick={prevSlide} className="absolute left-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowLeft /></button>}
            {showNext && <button onClick={nextSlide} className="absolute right-5 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center text-neutral-500 hover:text-neutral-700 transition-all z-10"><Icons.ArrowRight /></button>}
          </div>
          <div className="px-6 md:px-8 py-5 border-t border-neutral-100 flex-shrink-0 relative z-10">
            <div className="flex items-center justify-center gap-2.5">
              {slides.map((_, i) => <button key={i} onClick={() => goToSlide(i)} className="w-2.5 h-2.5 rounded-full transition-all duration-300" style={{ background: i === currentSlide ? 'var(--accent)' : '#d4d4d4', transform: i === currentSlide ? 'scale(1.3)' : 'scale(1)' }} />)}
            </div>
          </div>
          <AnimatePresence>
            {gifConfig && (
              <motion.div initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 30 }} transition={{ type: 'spring', stiffness: 100 }} className={`absolute ${gifConfig.side === 'left' ? 'left-4 md:left-8' : 'right-4 md:right-8'} bottom-0 pointer-events-none`} style={{ zIndex: 15, height: gifConfig.height }}>
                <video autoPlay loop muted playsInline className="h-full w-auto object-contain object-bottom" style={{ background: 'transparent', border: 'none', boxShadow: 'none' }}>
                  <source src={gifConfig.url} type="video/mp4" />
                </video>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      );
    };

    ReactDOM.render(<LessonApp />, document.getElementById('root'));
  </script>
</body>
</html>
